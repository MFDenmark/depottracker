<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>TidsHjulet V21 ¬∑ WizardZoom</title>
<style>
:root{
  --bg1:#f6fbff;
  --bg2:#eef5ff;
  --card:#ffffff;
  --text:#0b1220;
  --muted:#5a6b85;
  --line:#e7eef8;
  --blue:#2c6cff;
  --blue2:#1f4ed8;
  --alt:#00a6ff;
  --shadow: 0 18px 45px rgba(10,30,80,0.10);
  --segB:#cfe2ff;
  --segC:#dbe9ff;
  --danger:#b42318;
  --ok:#059669;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  background: linear-gradient(180deg, var(--bg1), var(--bg2));
  color: var(--text);
}
.app{max-width:520px;margin:0 auto;padding:18px 14px 44px;}
.top{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding:10px 6px 14px;
  position:sticky; top:0; z-index:20;
  background: linear-gradient(180deg, rgba(246,251,255,0.92), rgba(246,251,255,0.70));
  backdrop-filter: blur(10px);
}
.brand{display:flex;align-items:center;gap:10px}
.dot{width:10px;height:10px;border-radius:999px;background:linear-gradient(135deg,var(--alt),var(--blue));
  box-shadow:0 0 0 3px rgba(44,108,255,0.08);}
.name{font-weight:900;letter-spacing:-0.02em}
.tag{font-size:12px;color:var(--muted)}
.btn{
  border:1px solid var(--line);
  background: rgba(255,255,255,0.85);
  color: var(--text);
  border-radius: 14px;
  padding:10px 12px;
  font-weight:900;
  cursor:pointer;
  box-shadow: 0 10px 26px rgba(10,30,80,0.06);
}
.btn:active{transform:translateY(1px)}
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius: 22px;
  box-shadow: 0 25px 60px rgba(10,30,80,0.12);
}
.hero{padding:16px;}
.kicker{font-size:12px;color:var(--muted);letter-spacing:0.02em;text-transform:uppercase}
.h1{margin:6px 0 0;font-size:22px;font-weight:950;letter-spacing:-0.02em}
.p{margin:8px 0 0;font-size:13px;color:var(--muted);line-height:1.4}

.wheel-wrap{margin-top:12px;text-align:center;position:relative;padding:12px 6px 8px;}
svg{width:100%;max-width:470px;height:auto;display:block;margin:0 auto;}

.segment{
  cursor:pointer;
  transition: opacity .18s ease, filter .18s ease, transform .28s ease, stroke .18s ease;
  filter: drop-shadow(0 10px 18px rgba(44,108,255,0.10));
  stroke: rgba(11,18,32,0.10);
  stroke-width: 2;
  transform-origin: 210px 210px;
}
.segment:hover{opacity:0.95; filter: drop-shadow(0 16px 26px rgba(44,108,255,0.16));}
.segment:active{transform:scale(0.996);}
.segment.active{filter: drop-shadow(0 18px 30px rgba(44,108,255,0.24)); stroke: rgba(44,108,255,0.55); stroke-width: 3;}
.segment.inactive{opacity:0.72;}
#wheelRot{transform-origin: 210px 210px; transition: transform .34s ease;}

.coreTap{cursor:pointer;}
.coreAge{font-size:62px;font-weight:950;fill:var(--text);letter-spacing:-0.05em}
.coreSmall{font-size:12px;fill:rgba(11,18,32,0.64)}
.coreDelta{font-size:13px;font-weight:950;fill:rgba(31,78,216,0.98)}

.centerInputWrap{position:absolute;left:50%; top:50%; transform:translate(-50%,-50%); width:230px; pointer-events:none; z-index:10;}
.centerCard{width:100%; background: rgba(255,255,255,0.95); border:1px solid var(--line); border-radius: 18px;
  box-shadow: 0 18px 45px rgba(10,30,80,0.14); padding:12px 12px 10px; pointer-events:auto;}
.centerTitle{font-size:12px;color:var(--muted);font-weight:900;letter-spacing:0.02em;text-transform:uppercase}
.centerField{width:100%; margin-top:8px; padding:12px 12px; border-radius:14px; border:1px solid var(--line);
  background:#fff; color: var(--text); font-size:22px; font-weight:950; outline:none; text-align:center;}
.centerHint{margin-top:8px;font-size:12px;color:var(--muted);line-height:1.35}
.centerBtns{display:flex;gap:8px;margin-top:10px}
.centerBtns button{flex:1;border:0;border-radius:14px;padding:10px 10px;font-weight:950;cursor:pointer;}
.centerBtns .go{background:linear-gradient(135deg,var(--blue),var(--blue2));color:#fff}
.centerBtns .demo{background:rgba(0,166,255,0.10);color:rgba(0,90,140,0.95); border:1px solid rgba(0,166,255,0.20)}
.hidden{display:none;}

.badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.badge{border:1px solid var(--line); background: rgba(255,255,255,0.70); padding:7px 10px; border-radius:999px;
  font-size:12px; color: rgba(11,18,32,0.78); font-weight:900;}
.badge.blue{border-color: rgba(44,108,255,0.18); background: rgba(44,108,255,0.08); color: rgba(31,78,216,0.95);}
.badge.ok{border-color: rgba(5,150,105,0.18); background: rgba(5,150,105,0.08); color: rgba(5,150,105,0.95);}
.progressRow{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-top:10px}
.progressRow .left{font-size:12px;color:var(--muted);line-height:1.35;flex:1;text-align:left}
.progressRow .right{font-size:13px;font-weight:950;color:rgba(11,18,32,0.85);white-space:nowrap}

/* ===== Focus / Zoom ===== */
.focusShade{
  position:absolute; inset:0;
  background: radial-gradient(circle at 50% 42%, rgba(255,255,255,0.0), rgba(0,0,0,0.06));
  opacity:0; pointer-events:none;
  transition: opacity .25s ease;
  border-radius: 22px;
}
.wheel-wrap.focus .focusShade{opacity:1;}

.wheel-wrap.focus .segment{opacity:0.08; filter:none; stroke:rgba(11,18,32,0.06);}
.wheel-wrap.focus .segment.isFocus{
  opacity:1;
  filter: drop-shadow(0 24px 38px rgba(44,108,255,0.26));
  stroke: rgba(44,108,255,0.60);
  stroke-width: 3.2;
  transform: translate(0px,-12px) scale(1.11);
}

.focusUI{
  position:absolute;
  left:50%; top:50%;
  transform: translate(-50%,-50%);
  width:min(430px, calc(100% - 28px));
  pointer-events:none;
  z-index:9;
}
.focusCard{
  pointer-events:auto;
  background: rgba(255,255,255,0.96);
  border:1px solid var(--line);
  border-radius: 20px;
  box-shadow: 0 26px 70px rgba(10,30,80,0.16);
  padding:14px 14px 12px;
  backdrop-filter: blur(10px);
}
.focusTitle{font-size:12px;color:var(--muted);font-weight:900;letter-spacing:0.02em;text-transform:uppercase}
.focusH{margin:6px 0 0; font-size:18px; font-weight:950; letter-spacing:-0.02em}
.focusHint{margin-top:8px;font-size:12px;color:var(--muted);line-height:1.35}
.hr{height:1px;background:var(--line);margin:12px 0;}

label{display:block;font-size:12px;color:var(--muted);font-weight:900;margin:10px 0 6px}
.number{width:100%;padding:12px 12px;border-radius:14px;border:1px solid var(--line);font-size:18px;font-weight:900;color:var(--text);outline:none;}
.inline2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.quick{display:flex;gap:8px;margin-top:10px}
.quick button{flex:1;border:1px solid var(--line);background: rgba(44,108,255,0.07);color: rgba(31,78,216,0.98);
  border-radius:14px;padding:10px 10px;font-weight:950;cursor:pointer;}
.small{font-size:12px;color:var(--muted);line-height:1.35;margin-top:8px}
.range{-webkit-appearance:none;appearance:none;width:100%;height:12px;border-radius:999px;background: linear-gradient(90deg, rgba(44,108,255,0.35), rgba(44,108,255,0.10));outline:none;}
.range::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:26px;height:26px;border-radius:999px;background: linear-gradient(135deg, var(--alt), var(--blue));
  border:3px solid rgba(255,255,255,0.95);box-shadow:0 10px 22px rgba(44,108,255,0.24);}
.range::-moz-range-thumb{width:26px;height:26px;border-radius:999px;background: linear-gradient(135deg, var(--alt), var(--blue));
  border:3px solid rgba(255,255,255,0.95);box-shadow:0 10px 22px rgba(44,108,255,0.24);}
.range::-moz-range-track{height:12px;border-radius:999px;background: linear-gradient(90deg, rgba(44,108,255,0.35), rgba(44,108,255,0.10));}

.chipsGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
.chip{padding:12px;border-radius:16px;border:1px solid var(--line);background:#f8fbff;cursor:pointer;font-size:13px;font-weight:950;
  display:flex;justify-content:space-between;gap:10px;}
.chip small{font-weight:950;color:var(--muted);}
.chip.on{background: rgba(44,108,255,0.10);border-color: rgba(44,108,255,0.45);color: rgba(31,78,216,0.98);}

.pagerRow{display:flex;align-items:center;justify-content:space-between;margin-top:12px;color:var(--muted);font-size:12px;}
.pagerRow button{border:1px solid var(--line);background:#fff;border-radius:14px;padding:10px 12px;font-weight:950;cursor:pointer;}
.pagerRow button:disabled{opacity:0.45;cursor:not-allowed;}

.wizFooter{display:flex; gap:10px; margin-top:12px;}
.wizFooter button{
  flex:1; border-radius:14px; padding:11px 12px; font-weight:950; cursor:pointer;
  border:1px solid var(--line);
}
.wizFooter .back{background:#fff; color:rgba(11,18,32,0.88);}
.wizFooter .ok{
  border:0;
  background: linear-gradient(135deg,var(--blue),var(--blue2));
  color:#fff;
  box-shadow: 0 14px 32px rgba(31,78,216,0.18);
}
.wizFooter .back:disabled{opacity:0.45; cursor:not-allowed;}
.wizSub{margin-top:8px; font-size:12px; color:var(--muted); line-height:1.35;}
.wizSub.warn{color:rgba(180,35,24,0.92); font-weight:900;}
.wizSub.ok{color:rgba(5,150,105,0.95); font-weight:900;}

/* Keep focus UI hidden unless focus */
.wheel-wrap:not(.focus) .focusUI{display:none;}

/* ‚ÄúCore scoreboard‚Äù polish */
.corePulse{animation: corePulse .45s ease;}
@keyframes corePulse{
  0%{transform: scale(1);}
  45%{transform: scale(1.025);}
  100%{transform: scale(1);}
}
</style>
</head>
<body>
<div class="app" id="appRoot">
  <div class="top">
    <div class="brand">
      <div class="dot"></div>
      <div>
        <div class="name">TidsHjulet</div>
        <div class="tag">V21 ¬∑ WizardZoom ¬∑ adf√¶rdsflow</div>
      </div>
    </div>
    <button class="btn" id="btnAssum">Foruds√¶tninger</button>
  </div>

  <div class="card hero" id="heroCard">
    <div class="kicker">Din frihed</div>
    <div class="h1">V√¶lg ‚Äì se effekten ‚Äì bekr√¶ft</div>
    <div class="p">3 trin. Zoom ind i √©t ‚Äúkagestykke‚Äù. Midten opdaterer live. Efter 3√óOK kan du redigere frit.</div>

    <div class="wheel-wrap locked" id="wheelWrap">
      <div class="focusShade"></div>
      <svg viewBox="0 0 420 420" aria-label="Tids-hjul">
        <defs>
          <linearGradient id="gMonthly" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#4f8dff"/>
            <stop offset="100%" stop-color="#2c6cff"/>
          </linearGradient>
          <radialGradient id="gCore" cx="40%" cy="30%" r="70%">
            <stop offset="0%" stop-color="rgba(255,255,255,0.98)"/>
            <stop offset="100%" stop-color="rgba(255,255,255,0.92)"/>
          </radialGradient>
        </defs>

        <!-- Rotating ring (segments ONLY) -->
        <g id="wheelRot">
          <path id="segMonthly" class="segment inactive" fill="url(#gMonthly)"
                d="M 210.000 40.000 A 170 170 0 0 1 309.923 347.533 L 274.656 298.992 A 110 110 0 0 0 210.000 100.000 Z"/>
          <path id="segSavings" class="segment inactive" fill="var(--segB)"
                d="M 309.923 347.533 A 170 170 0 0 1 40.000 210.000 L 100.000 210.000 A 110 110 0 0 0 274.656 298.992 Z"/>
          <path id="segChoices" class="segment inactive" fill="var(--segC)"
                d="M 40.000 210.000 A 170 170 0 0 1 210.000 40.000 L 210.000 100.000 A 110 110 0 0 0 100.000 210.000 Z"/>

          <text x="347.9" y="165.2" text-anchor="middle" font-size="12" fill="rgba(11,18,32,0.70)" font-weight="900">M√•nedlig</text>
          <text x="144.2" y="339.2" text-anchor="middle" font-size="12" fill="rgba(11,18,32,0.70)" font-weight="900">Opsparing</text>
          <text x="107.5" y="107.5" text-anchor="middle" font-size="12" fill="rgba(11,18,32,0.70)" font-weight="900">Sm√• valg</text>
        </g>

        <!-- Static core (NEVER rotates) -->
        <g id="coreStatic">
          <!-- progress ring -->
          <circle cx="210" cy="210" r="118" fill="none" stroke="rgba(44,108,255,0.10)" stroke-width="10"/>
          <circle id="progRing" cx="210" cy="210" r="118" fill="none" stroke="rgba(44,108,255,0.55)" stroke-width="10"
                  stroke-linecap="round" transform="rotate(-90 210 210)"/>
          <!-- Core -->
          <circle id="coreTap" class="coreTap" cx="210" cy="210" r="106" fill="url(#gCore)"/>
          <circle cx="210" cy="210" r="106" fill="none" stroke="rgba(11,18,32,0.06)" stroke-width="2"/>

          <text id="coreBase" x="210" y="164" text-anchor="middle" class="coreSmall">Folkepension: ‚Äì</text>
          <text id="coreAge" x="210" y="245" text-anchor="middle" class="coreAge">‚Äì</text>
          <text x="210" y="270" text-anchor="middle" class="coreSmall">√•r</text>
          <text id="coreDelta" x="210" y="300" text-anchor="middle" class="coreDelta">Indtast alder</text>
          <text id="coreStep" x="210" y="326" text-anchor="middle" class="coreSmall">Trin ‚Äì/3</text>
        </g>
      </svg>

      <!-- Age gate -->
      <div class="centerInputWrap" id="centerWrap">
        <div class="centerCard">
          <div class="centerTitle">Hvor gammel er du?</div>
          <input id="ageField" class="centerField" type="number" inputmode="numeric" min="15" max="100" placeholder="fx 35">
          <div class="centerHint">Indtast alder. Bekr√¶ft med Forts√¶t (eller Enter).</div>
          <div class="centerBtns">
            <button class="go" id="ageGo">Forts√¶t</button>
            <button class="demo" id="ageDemo">Demo</button>
          </div>
        </div>
      </div>

      <!-- Focus UI -->
      <div class="focusUI" id="focusUI">
        <div class="focusCard">
          <div class="focusTitle" id="focusTitle">‚Äî</div>
          <div class="focusH" id="focusH">‚Äî</div>
          <div class="focusHint" id="focusHint">‚Äî</div>
          <div class="hr"></div>
          <div id="focusBody"></div>
          <div class="wizFooter">
            <button class="back" id="btnBack">Tilbage</button>
            <button class="ok" id="btnOk">OK</button>
          </div>
          <div class="wizSub" id="wizSub"></div>
        </div>
      </div>
    </div>

    <div class="badges">
      <div class="badge" id="badgeOfficial">Folkepension: ‚Äì</div>
      <div class="badge blue" id="badgeActive">0/3 aktiveret</div>
      <div class="badge ok hidden" id="badgeLive">Live</div>
    </div>

    <div class="progressRow">
      <div class="left" id="progLeft">Indtast alder for at starte.</div>
      <div class="right" id="progRight"></div>
    </div>
  </div>
</div>

<script>
/* ===== Baseline ===== */
const nowYear = 2026;
const $ = (id)=>document.getElementById(id);

const CHOICES = [
  {id:"c1", label:"‚òï Mindre caf√©-kaffe", monthly:200},
  {id:"c2", label:"üçî 1 mindre take-away", monthly:400},
  {id:"c3", label:"üì∫ Del streaming", monthly:150},
  {id:"c4", label:"üö≤ Cykel 1 dag mere", monthly:300},
  {id:"c5", label:"üõí 5% mindre forbrug", monthly:250},
  {id:"c6", label:"üßæ Abonnement-scan", monthly:150},
  {id:"c7", label:"üßÅ F√¶rre snacks", monthly:200},
  {id:"c8", label:"üõçÔ∏è Impulsk√∏b f√¶rre", monthly:400},
  {id:"c9", label:"üì¶ K√∏b brugt 1x", monthly:350},
  {id:"c10", label:"üöÜ Transport-optimering", monthly:300},
];
const PAGE_SIZE = 5;

const state = {
  age:null,
  birthYear:null,
  pensionAge:null,
  monthly:0,
  savings:0,
  choicesOn: new Set(),
  choicesManual: 0,
  r: 0.06,
  targetMonthly: 20000,
  payoutYears: 20,
  choicesPage: 0,

  /* V21 flow */
  wizardMode: true,
  stepIndex: 0, // 0..2
  confirmed: { monthly:false, savings:false, choices:false },
  focusOpen: false,
  focusStep: null,
};

const CLAMP = {
  ageMin: 15, ageMax: 100,
  monthlyMin: 0, monthlyMax: 30000,
  savingsMin: 0, savingsMax: 50000000,
  choicesManualMin: 0, choicesManualMax: 10000,
  targetMonthlyMin: 5000, targetMonthlyMax: 50000,
  payoutYearsMin: 5, payoutYearsMax: 35,
  rMin: 0.00, rMax: 0.10,
};

function clamp(n, a, b){
  n = Number.isFinite(n) ? n : 0;
  return Math.min(b, Math.max(a, n));
}
function toInt(v){
  const n = parseInt(String(v ?? "").replace(/[^0-9]/g,""), 10);
  return Number.isFinite(n) ? n : 0;
}
function toFloat(v){
  const n = parseFloat(String(v ?? "").replace(",", "."));
  return Number.isFinite(n) ? n : 0;
}

function pensionAgeFromBirthYear(y){
  if (y < 1963) return 67;
  if (y < 1967) return 68;
  if (y < 1971) return 69;
  if (y < 1975) return 70;
  if (y < 1979) return 71;
  return 72;
}
function neededCapital(){ return state.targetMonthly * 12 * state.payoutYears; }
function choicesSum(){
  let sum = 0;
  for (const id of state.choicesOn){
    const c = CHOICES.find(x=>x.id===id);
    if (c) sum += c.monthly;
  }
  return sum + (state.choicesManual||0);
}
function activeCount(){
  let n=0;
  if (state.monthly>0) n++;
  if (state.savings>0) n++;
  if (choicesSum()>0) n++;
  return n;
}
function hardenAll(){
  if(state.age != null) state.age = clamp(toInt(state.age), CLAMP.ageMin, CLAMP.ageMax);
  state.monthly = clamp(toInt(state.monthly), CLAMP.monthlyMin, CLAMP.monthlyMax);
  state.savings = clamp(toInt(state.savings), CLAMP.savingsMin, CLAMP.savingsMax);
  state.choicesManual = clamp(toInt(state.choicesManual), CLAMP.choicesManualMin, CLAMP.choicesManualMax);
  state.r = clamp(toFloat(state.r), CLAMP.rMin, CLAMP.rMax);
  state.targetMonthly = clamp(toInt(state.targetMonthly), CLAMP.targetMonthlyMin, CLAMP.targetMonthlyMax);
  state.payoutYears = clamp(toInt(state.payoutYears), CLAMP.payoutYearsMin, CLAMP.payoutYearsMax);
}

function computeFreedom(){
  hardenAll();
  if (!state.age || !state.pensionAge) return null;
  const baseAge = state.pensionAge;
  const yearsLeft = Math.max(0, baseAge - state.age);
  const r = state.r;

  const annual = (state.monthly + choicesSum()) * 12;
  const fvContrib = annual * (r===0 ? yearsLeft : ((Math.pow(1+r, yearsLeft)-1)/r));
  const fvSavings = state.savings * Math.pow(1+r, yearsLeft);
  const total = fvContrib + fvSavings;

  const need = neededCapital();
  const ratio = need>0 ? total/need : 0;

  const cap = yearsLeft * 0.35;
  const yearsGained = Math.max(0, Math.min(cap, ratio*cap));
  const freedomAge = baseAge - yearsGained;
  return {baseAge, freedomAge, yearsGained};
}

/* ===== Persistence ===== */
const LS_KEY = "tidhjulet_v21_wizardzoom_state_v1";
function saveState(){
  try{
    const payload = {
      age: state.age,
      monthly: state.monthly,
      savings: state.savings,
      choicesOn: Array.from(state.choicesOn),
      choicesManual: state.choicesManual,
      r: state.r,
      targetMonthly: state.targetMonthly,
      payoutYears: state.payoutYears,
      choicesPage: state.choicesPage,

      wizardMode: state.wizardMode,
      stepIndex: state.stepIndex,
      confirmed: state.confirmed,

      wheelRot: $("wheelRot")?.style?.transform ?? "",
    };
    localStorage.setItem(LS_KEY, JSON.stringify(payload));
  }catch(e){}
}
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return false;
    const p = JSON.parse(raw);
    if(p && typeof p === "object"){
      if(p.age != null){
        const a = clamp(toInt(p.age), CLAMP.ageMin, CLAMP.ageMax);
        state.age = a;
        state.birthYear = nowYear - a;
        state.pensionAge = pensionAgeFromBirthYear(state.birthYear);
        $("centerWrap")?.classList.add("hidden");
        lockWheel(false);
      }
      state.monthly = clamp(toInt(p.monthly), CLAMP.monthlyMin, CLAMP.monthlyMax);
      state.savings = clamp(toInt(p.savings), CLAMP.savingsMin, CLAMP.savingsMax);
      state.choicesOn = new Set(Array.isArray(p.choicesOn) ? p.choicesOn : []);
      state.choicesManual = clamp(toInt(p.choicesManual), CLAMP.choicesManualMin, CLAMP.choicesManualMax);
      state.r = clamp(toFloat(p.r), CLAMP.rMin, CLAMP.rMax);
      state.targetMonthly = clamp(toInt(p.targetMonthly), CLAMP.targetMonthlyMin, CLAMP.targetMonthlyMax);
      state.payoutYears = clamp(toInt(p.payoutYears), CLAMP.payoutYearsMin, CLAMP.payoutYearsMax);
      state.choicesPage = clamp(toInt(p.choicesPage), 0, 1000);

      state.wizardMode = (p.wizardMode === false) ? false : true;
      state.stepIndex = clamp(toInt(p.stepIndex), 0, 2);
      if(p.confirmed && typeof p.confirmed === "object"){
        state.confirmed = {
          monthly: !!p.confirmed.monthly,
          savings: !!p.confirmed.savings,
          choices: !!p.confirmed.choices,
        };
        if(state.confirmed.monthly && state.confirmed.savings && state.confirmed.choices){
          state.wizardMode = false;
        }
      }

      if(typeof p.wheelRot === "string" && p.wheelRot.includes("rotate(")){
        $("wheelRot").style.transform = p.wheelRot;
      }
      return true;
    }
  }catch(e){}
  return false;
}

/* ===== UI helpers ===== */
function easeOutCubic(p){ return 1 - Math.pow(1-p, 3); }

let lastShown = null;
let animSeq = 0; // IMPORTANT: cancel older animations so core always ends at newest value

function animateCore(to){
  const el = $("coreAge");
  if(!el) return;

  animSeq++;
  const seq = animSeq;

  if (lastShown === null){
    el.textContent = (Math.round(to*10)/10).toString();
    lastShown = to;
    return;
  }

  const from = lastShown;
  const start = performance.now();
  const dur = 320;

  function tick(t){
    if (seq !== animSeq) return; // cancelled by a newer update

    const p = Math.min(1, (t-start)/dur);
    const v = from + (to-from) * easeOutCubic(p);
    el.textContent = (Math.round(v*10)/10).toString();

    if (p<1) requestAnimationFrame(tick);
    else lastShown = to;
  }
  requestAnimationFrame(tick);
}

function pulseCore(){
  const g = $("coreStatic");
  if(!g) return;
  g.classList.remove("corePulse");
  void g.offsetWidth;
  g.classList.add("corePulse");
}

function lockWheel(locked){ $("wheelWrap").classList.toggle("locked", locked); }
function setLiveBadge(on){ $("badgeLive").classList.toggle("hidden", !on); }

function updateSegmentStates(){
  const m=$("segMonthly"), s=$("segSavings"), c=$("segChoices");
  const onM = state.monthly>0;
  const onS = state.savings>0;
  const onC = choicesSum()>0;

  [m,s,c].forEach(el=>{ el.classList.remove("active"); el.classList.add("inactive"); el.classList.remove("isFocus"); });
  if (onM){ m.classList.add("active"); m.classList.remove("inactive"); }
  if (onS){ s.classList.add("active"); s.classList.remove("inactive"); }
  if (onC){ c.classList.add("active"); c.classList.remove("inactive"); }
}

const STEP_ORDER = ["monthly","savings","choices"];
function stepName(step){
  if(step==="monthly") return "M√•nedlig investering";
  if(step==="savings") return "Opsparing i dag";
  if(step==="choices") return "Sm√• valg";
  return "‚Äî";
}
function stepHint(step){
  if(step==="monthly") return "Indtast 0 hvis du ikke investerer m√•nedligt. Midten opdaterer live.";
  if(step==="savings") return "Indtast 0 hvis du ikke har opsparing. Midten opdaterer live.";
  if(step==="choices") return "V√¶lg konkrete sm√• valg ‚Äì eller lad st√• tomt (0). Midten opdaterer live.";
  return "";
}

function rotateToStepIndex(i){
  const degMap = [0, 120, -120];
  const deg = degMap[i] ?? 0;
  $("wheelRot").style.transform = `rotate(${deg}deg)`;
  saveState();
}

function isAllConfirmed(){
  return state.confirmed.monthly && state.confirmed.savings && state.confirmed.choices;
}
function confirmedCount(){
  let n=0; if(state.confirmed.monthly) n++; if(state.confirmed.savings) n++; if(state.confirmed.choices) n++;
  return n;
}
function updateProgressRing(){
  const r = 118;
  const C = 2*Math.PI*r;
  const done = confirmedCount();
  const frac = Math.min(1, Math.max(0, done/3));
  const dash = C * frac;
  const gap = C - dash;

  const ring = $("progRing");
  ring.setAttribute("stroke-dasharray", `${dash} ${gap}`);
  ring.setAttribute("stroke-dashoffset", "0");
}
function setSegmentInteractivity(){
  const current = STEP_ORDER[state.stepIndex];
  const map = { monthly:$("segMonthly"), savings:$("segSavings"), choices:$("segChoices") };

  if(!state.age){
    Object.values(map).forEach(el=>{ el.style.pointerEvents="none"; });
    return;
  }

  if(state.focusOpen){
    Object.values(map).forEach(el=>{ el.style.pointerEvents="none"; });
    return;
  }

  if(state.wizardMode){
    Object.entries(map).forEach(([k,el])=>{
      el.style.pointerEvents = (k===current) ? "auto" : "none";
      el.classList.toggle("active", k===current || el.classList.contains("active"));
      el.classList.toggle("inactive", k!==current);
    });
    return;
  }

  Object.values(map).forEach(el=>{ el.style.pointerEvents="auto"; });
}

/* ===== Core messaging ===== */
function updateUI(){
  const res = computeFreedom();
  if (!res){
    $("coreBase").textContent = "Folkepension: ‚Äì";
    $("coreAge").textContent = "‚Äì";
    $("coreDelta").textContent = "Indtast alder";
    $("coreStep").textContent = "Trin ‚Äì/3";
    $("badgeOfficial").textContent = "Folkepension: ‚Äì";
    $("badgeActive").textContent = "0/3 aktiveret";
    $("progLeft").textContent = "Indtast alder for at starte.";
    $("progRight").textContent = "";
    setLiveBadge(false);
    lastShown = null;
    animSeq++; // cancel any running animation
    updateSegmentStates();
    updateProgressRing();
    setSegmentInteractivity();
    return;
  }

  $("coreBase").textContent = "Folkepension: " + res.baseAge + " √•r";
  $("badgeOfficial").textContent = "Folkepension: " + res.baseAge + " √•r (estimat)";

  animateCore(Math.round(res.freedomAge*10)/10);

  const gained = Math.round(res.yearsGained*10)/10;
  if (gained < 0.05){
    $("coreDelta").textContent = "Lav et valg og se effekten";
    $("progRight").textContent = "";
  }else{
    $("coreDelta").textContent = "+" + gained + " √•r tidligere muligt";
    $("progRight").textContent = "+" + gained + " √•r";
  }

  const act = activeCount();
  $("badgeActive").textContent = act + "/3 aktiveret";
  setLiveBadge(act>0);

  $("coreStep").textContent = "Trin " + (state.wizardMode ? (state.stepIndex+1) : "‚úì") + "/3";
  $("progLeft").textContent = state.wizardMode
    ? ("Trin " + (state.stepIndex+1) + " af 3 ¬∑ Tryk for at zoome ind og bekr√¶ft med OK.")
    : "Fri redigering: Tryk p√• et felt og just√©r.";

  updateSegmentStates();
  updateProgressRing();
  setSegmentInteractivity();
  saveState();
}

/* ===== Focus (Zoom) ===== */
function setFocusVisual(step){
  const wrap = $("wheelWrap");
  wrap.classList.add("focus");
  $("segMonthly").classList.toggle("isFocus", step==="monthly");
  $("segSavings").classList.toggle("isFocus", step==="savings");
  $("segChoices").classList.toggle("isFocus", step==="choices");
}
function clearFocusVisual(){
  $("wheelWrap").classList.remove("focus");
  ["segMonthly","segSavings","segChoices"].forEach(id=>$(id).classList.remove("isFocus"));
}

function openFocus(step){
  if(!state.age) return;
  state.focusOpen = true;
  state.focusStep = step;

  setFocusVisual(step);
  $("focusTitle").textContent = state.wizardMode ? ("Trin " + (state.stepIndex+1) + " af 3") : "Redig√©r";
  $("focusH").textContent = stepName(step);
  $("focusHint").textContent = stepHint(step);
  $("wizSub").textContent = "";

  renderFocusBody(step);

  $("btnBack").disabled = state.wizardMode ? (state.stepIndex===0) : false;
  $("btnBack").textContent = "Tilbage";
  $("btnOk").textContent = "OK";

  setSegmentInteractivity();
}

function closeFocus(){
  state.focusOpen = false;
  state.focusStep = null;
  clearFocusVisual();
  $("wizSub").textContent = "";
  setSegmentInteractivity();
  saveState();
}

/* Focus content */
function focusMonthlyHtml(){
  return `
    <label>Bel√∏b (kr./md)</label>
    <input id="mRange" class="range" type="range" min="0" max="15000" step="100" value="${state.monthly}">
    <div class="inline2" style="margin-top:10px">
      <div>
        <label>Skriv bel√∏b</label>
        <input id="mNum" class="number" type="number" inputmode="numeric" min="0" value="${state.monthly}">
      </div>
      <div>
        <label>Hurtigt</label>
        <div class="quick">
          <button type="button" data-add="100">+100</button>
          <button type="button" data-add="500">+500</button>
          <button type="button" data-add="1000">+1000</button>
        </div>
      </div>
    </div>
    <div class="small">0 er tilladt. OK betyder ‚Äúbekr√¶ftet‚Äù.</div>
  `;
}
function bindMonthly(){
  const r=$("mRange"), n=$("mNum");
  r.addEventListener("input", (e)=>{
    state.monthly = clamp(toInt(e.target.value||"0"), CLAMP.monthlyMin, CLAMP.monthlyMax);
    n.value = state.monthly;
    updateUI(); pulseCore();
  });
  n.addEventListener("input", (e)=>{
    state.monthly = clamp(toInt(e.target.value||"0"), CLAMP.monthlyMin, CLAMP.monthlyMax);
    r.value = state.monthly;
    updateUI(); pulseCore();
  });
  $("focusBody").querySelectorAll(".quick button").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      state.monthly = clamp(state.monthly + toInt(btn.dataset.add), CLAMP.monthlyMin, CLAMP.monthlyMax);
      r.value = state.monthly; n.value = state.monthly;
      updateUI(); pulseCore();
    });
  });
}
function focusSavingsHtml(){
  return `
    <label>Bel√∏b (kr.)</label>
    <input id="sNum" class="number" type="number" inputmode="numeric" min="0" value="${state.savings}" placeholder="fx 250000">
    <div class="quick">
      <button type="button" data-add="10000">+10k</button>
      <button type="button" data-add="50000">+50k</button>
      <button type="button" data-add="100000">+100k</button>
    </div>
    <div class="small">0 er tilladt. OK betyder ‚Äúbekr√¶ftet‚Äù.</div>
  `;
}
function bindSavings(){
  const n=$("sNum");
  n.addEventListener("input", (e)=>{
    state.savings = clamp(toInt(e.target.value||"0"), CLAMP.savingsMin, CLAMP.savingsMax);
    updateUI(); pulseCore();
  });
  $("focusBody").querySelectorAll(".quick button").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      state.savings = clamp(state.savings + toInt(btn.dataset.add), CLAMP.savingsMin, CLAMP.savingsMax);
      n.value = state.savings;
      updateUI(); pulseCore();
    });
  });
}
function renderChoices(){
  const totalPages = Math.ceil(CHOICES.length / PAGE_SIZE);
  const start = state.choicesPage * PAGE_SIZE;
  const items = CHOICES.slice(start, start + PAGE_SIZE);

  let chipsHtml = "";
  for (const c of items){
    const on = state.choicesOn.has(c.id) ? "on" : "";
    chipsHtml += `<div class="chip ${on}" data-id="${c.id}"><span>${c.label}</span><small>${c.monthly} kr./md</small></div>`;
  }

  const prevDisabled = (state.choicesPage===0) ? "disabled" : "";
  const nextDisabled = (state.choicesPage===totalPages-1) ? "disabled" : "";

  return `
    <div class="small">V√¶lg konkrete ting. 0 er tilladt.</div>
    <div class="small" style="margin-top:6px"><b>Sm√• valg i alt:</b> <span id="choicesTotal">${choicesSum()}</span> kr./md</div>

    <div class="chipsGrid" id="chipsGrid">${chipsHtml}</div>

    <div class="pagerRow">
      <button id="prevPg" type="button" ${prevDisabled}>Forrige</button>
      <div>Side ${state.choicesPage+1}/${totalPages}</div>
      <button id="nextPg" type="button" ${nextDisabled}>N√¶ste</button>
    </div>

    <label>Tilpas selv (kr./md) ‚Äì ekstra</label>
    <input id="choicesManual" class="number" type="number" inputmode="numeric" min="0" value="${state.choicesManual}" placeholder="fx 300">

    <div class="small">OK betyder ‚Äúbekr√¶ftet‚Äù.</div>
  `;
}
function bindChoices(){
  const grid = $("chipsGrid");
  if (grid){
    grid.addEventListener("click", (e)=>{
      const el = e.target.closest(".chip");
      if(!el) return;
      const id = el.getAttribute("data-id");
      if(state.choicesOn.has(id)) state.choicesOn.delete(id); else state.choicesOn.add(id);
      $("focusBody").innerHTML = renderChoices();
      bindChoices();
      updateUI(); pulseCore();
    });
  }

  const totalPages = Math.ceil(CHOICES.length / PAGE_SIZE);
  const prev = $("prevPg"), next = $("nextPg");
  if (prev){
    prev.addEventListener("click", ()=>{
      if(state.choicesPage>0) state.choicesPage--;
      $("focusBody").innerHTML = renderChoices();
      bindChoices();
    });
  }
  if (next){
    next.addEventListener("click", ()=>{
      if(state.choicesPage<totalPages-1) state.choicesPage++;
      $("focusBody").innerHTML = renderChoices();
      bindChoices();
    });
  }

  const manual = $("choicesManual");
  if (manual){
    manual.addEventListener("input", (e)=>{
      state.choicesManual = clamp(toInt(e.target.value||"0"), CLAMP.choicesManualMin, CLAMP.choicesManualMax);
      const t = $("choicesTotal");
      if (t) t.textContent = choicesSum();
      updateUI(); pulseCore();
    });
  }
}

function renderFocusBody(step){
  if(step==="monthly"){
    $("focusBody").innerHTML = focusMonthlyHtml();
    bindMonthly();
  }else if(step==="savings"){
    $("focusBody").innerHTML = focusSavingsHtml();
    bindSavings();
  }else if(step==="choices"){
    $("focusBody").innerHTML = renderChoices();
    bindChoices();
  }
}

function okZeroMessage(step){
  if(step==="monthly" && state.monthly===0) return "Ingen √¶ndring registreret.";
  if(step==="savings" && state.savings===0) return "Ingen √¶ndring registreret.";
  if(step==="choices" && choicesSum()===0) return "Ingen √¶ndring registreret.";
  return "";
}
function confirmStep(step){
  state.confirmed[step] = true;
  if(isAllConfirmed()){
    state.wizardMode = false;
  }
}

/* Footer actions */
$("btnBack").addEventListener("click", ()=>{
  if(!state.focusOpen) return;
  if(state.wizardMode){
    if(state.stepIndex===0) return;
    closeFocus();
    state.stepIndex--;
    rotateToStepIndex(state.stepIndex);
    updateUI();
    return;
  }
  closeFocus();
  updateUI();
});

$("btnOk").addEventListener("click", ()=>{
  if(!state.focusOpen) return;
  const step = state.focusStep;

  const msg = okZeroMessage(step);
  if(msg){
    $("wizSub").textContent = msg;
    $("wizSub").className = "wizSub warn";
  }else{
    $("wizSub").textContent = "";
    $("wizSub").className = "wizSub";
  }

  confirmStep(step);

  if(state.wizardMode){
    closeFocus();
    if(state.stepIndex < 2){
      state.stepIndex++;
      rotateToStepIndex(state.stepIndex);
      updateUI();
      return;
    }
    state.wizardMode = false;
    updateUI();
    return;
  }

  closeFocus();
  updateUI();
});

/* Clicking segments */
function openCurrentWizardStep(){
  const step = STEP_ORDER[state.stepIndex];
  openFocus(step);
}
$("segMonthly").addEventListener("click", ()=>{
  if(!state.age || state.focusOpen) return;
  if(state.wizardMode){
    if(STEP_ORDER[state.stepIndex] !== "monthly") return;
    openCurrentWizardStep();
    return;
  }
  state.stepIndex = 0;
  rotateToStepIndex(0);
  openFocus("monthly");
  updateUI();
});
$("segSavings").addEventListener("click", ()=>{
  if(!state.age || state.focusOpen) return;
  if(state.wizardMode){
    if(STEP_ORDER[state.stepIndex] !== "savings") return;
    openCurrentWizardStep();
    return;
  }
  state.stepIndex = 1;
  rotateToStepIndex(1);
  openFocus("savings");
  updateUI();
});
$("segChoices").addEventListener("click", ()=>{
  if(!state.age || state.focusOpen) return;
  if(state.wizardMode){
    if(STEP_ORDER[state.stepIndex] !== "choices") return;
    openCurrentWizardStep();
    return;
  }
  state.stepIndex = 2;
  rotateToStepIndex(2);
  openFocus("choices");
  updateUI();
});

/* Assumptions button */
$("btnAssum").addEventListener("click", ()=>{
  const res = computeFreedom();
  const need = neededCapital();
  const text =
    "Afkast: " + Math.round(state.r*100) + "%\n" +
    "M√•l: " + state.targetMonthly.toLocaleString("da-DK") + " kr./md i " + state.payoutYears + " √•r\n" +
    "M√•lkapital: " + need.toLocaleString("da-DK") + " kr.\n" +
    "Alder: " + (state.age ?? "‚Äî") + "\n" +
    "Folkepension: " + (state.pensionAge ?? "‚Äî") + "\n" +
    (res ? ("Mulig alder: " + (Math.round(res.freedomAge*10)/10) + " (+" + (Math.round(res.yearsGained*10)/10) + " √•r)") : "");
  alert(text);
});

/* ===== Age handling (NO auto-advance on input) ===== */
function unlockWithAge(age){
  age = clamp(toInt(age), CLAMP.ageMin, CLAMP.ageMax);
  state.age = age;
  state.birthYear = nowYear - age;
  state.pensionAge = pensionAgeFromBirthYear(state.birthYear);

  lastShown = null;
  animSeq++; // cancel any running animation immediately

  $("centerWrap").classList.add("hidden");
  lockWheel(false);

  if(isAllConfirmed()) state.wizardMode = false;
  rotateToStepIndex(state.stepIndex);
  updateUI();
}

function enterAgeEdit(){
  if(state.focusOpen) return;
  $("centerWrap").classList.remove("hidden");
  lockWheel(true);
  $("ageField").value = state.age ?? "";
  $("ageField").focus();
  $("coreDelta").textContent = "Indtast alder";
}
$("coreTap").addEventListener("click", enterAgeEdit);

const ageField = $("ageField");

/* Preview-only on input: do NOT unlock/advance */
ageField.addEventListener("input", ()=>{
  const raw = ageField.value || "";
  if (!raw){
    $("coreBase").textContent = "Folkepension: ‚Äì";
    $("coreAge").textContent = "‚Äì";
    $("coreDelta").textContent = "Indtast alder";
    $("coreStep").textContent = "Trin ‚Äì/3";
    $("badgeOfficial").textContent = "Folkepension: ‚Äì";
    return;
  }

  const a = clamp(toInt(raw), CLAMP.ageMin, CLAMP.ageMax);
  const by = nowYear - a;
  const pa = pensionAgeFromBirthYear(by);

  $("coreBase").textContent = "Folkepension: " + pa + " √•r";
  $("badgeOfficial").textContent = "Folkepension: " + pa + " √•r (estimat)";
  $("coreAge").textContent = String(a);
  $("coreDelta").textContent = "Bekr√¶ft med Forts√¶t";
  $("coreStep").textContent = "Trin ‚Äì/3";
});

ageField.addEventListener("keydown", (e)=>{
  if (e.key==="Enter"){
    e.preventDefault();
    const a = clamp(toInt(ageField.value||""), CLAMP.ageMin, CLAMP.ageMax);
    if (a>=CLAMP.ageMin && a<=CLAMP.ageMax) unlockWithAge(a);
  }
});
$("ageGo").addEventListener("click", ()=>{
  const a = clamp(toInt(ageField.value||""), CLAMP.ageMin, CLAMP.ageMax);
  if (a>=CLAMP.ageMin && a<=CLAMP.ageMax) unlockWithAge(a);
});
$("ageDemo").addEventListener("click", ()=>{
  ageField.value = 37;
  unlockWithAge(37);
  state.savings = 250000;
  state.monthly = 1500;
  state.choicesOn = new Set(["c1","c3"]);
  state.choicesManual = 0;
  updateUI();
});

/* Init */
lockWheel(true);
loadState();
rotateToStepIndex(state.stepIndex);
updateUI();
</script>
</body>
</html>
