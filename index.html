<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Depot Tracker (6%) ‚Äì v2</title>
<style>
  :root{
    --bg:#0b1220; --card:#111b2e; --text:#e8eefc; --muted:#a9b7d3;
    --good:#19c37d; --bad:#ff4d4f; --warn:#f7b500; --accent:#6aa6ff;
    --shadow: 0 10px 28px rgba(0,0,0,.35); --radius:18px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    background: radial-gradient(1200px 600px at 10% 0%, rgba(106,166,255,.18), transparent 55%),
                radial-gradient(900px 500px at 90% 10%, rgba(25,195,125,.14), transparent 55%),
                var(--bg);
    color:var(--text);
  }
  .wrap{max-width:980px;margin:0 auto;padding:18px 16px 40px}
  .top{display:flex;gap:14px;flex-wrap:wrap;align-items:stretch}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.08);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:16px;
  }
  .banner{
    margin-bottom:14px;
    border-radius:14px;
    padding:12px 14px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.18);
    color:var(--muted);
    font-size:13px;
    line-height:1.35;
  }
  .banner strong{color:var(--text)}
  .hero{flex:1 1 420px;min-width:320px;position:relative;overflow:hidden}
  .hero h1{margin:0;font-size:18px;color:var(--muted);font-weight:800}
  .kpi{margin-top:10px;display:flex;gap:14px;align-items:baseline;flex-wrap:wrap}
  .kpi .big{font-size:44px;font-weight:900;line-height:1}
  .kpi .unit{font-size:14px;color:var(--muted);font-weight:800}
  .pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 10px;border-radius:999px;font-weight:900;font-size:13px;
    border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);
  }
  .pill.good{color:var(--good)} .pill.warn{color:var(--warn)} .pill.bad{color:var(--bad)}
  .sub{margin-top:10px;color:var(--muted);font-size:13px;line-height:1.35}
  .right{flex:0 1 420px;min-width:320px;display:flex;flex-direction:column;gap:14px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .mini{flex:1 1 180px;min-width:160px}
  .mini h3{margin:0;font-size:12px;color:var(--muted);letter-spacing:.2px}
  .mini .val{margin-top:8px;font-size:22px;font-weight:900}
  .mini .hint{margin-top:6px;font-size:12px;color:var(--muted)}
  .form{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .field{display:flex;flex-direction:column;gap:6px}
  label{font-size:12px;color:var(--muted);font-weight:900}
  input{
    padding:12px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
    background:rgba(0,0,0,.18);color:var(--text);font-weight:900;outline:none;
  }
  button{
    border:0;border-radius:12px;padding:12px 12px;font-weight:900;cursor:pointer;
    background:linear-gradient(180deg, rgba(106,166,255,1), rgba(106,166,255,.78));
    color:#071021;
    box-shadow:0 12px 26px rgba(106,166,255,.25);
  }
  button.secondary{
    background:rgba(255,255,255,.06);color:var(--text);
    border:1px solid rgba(255,255,255,.12);box-shadow:none;
  }
  button.danger{
    background:rgba(255,77,79,.12);color:#ffd2d2;
    border:1px solid rgba(255,77,79,.25);box-shadow:none;
  }
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .full{grid-column:1/-1}
  .chartCard{margin-top:14px}
  canvas{width:100%;height:320px;display:block}
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:13px}
  th,td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
  th{color:var(--muted);font-size:12px;letter-spacing:.2px}
  .tag{
    display:inline-block;padding:4px 8px;border-radius:999px;font-weight:900;font-size:12px;
    border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.16);
  }
  .tag.good{color:var(--good)} .tag.warn{color:var(--warn)}
  .footer{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;color:var(--muted);font-size:12px}
  .progress{height:12px;border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22)}
  .progress>div{height:100%;width:0%;background:linear-gradient(90deg, rgba(25,195,125,1), rgba(106,166,255,1))}
  .hidden{display:none}
  @media (max-width:720px){.kpi .big{font-size:40px}canvas{height:280px}.form{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <div class="banner" id="storageBanner">
    <strong>Storage:</strong> tester‚Ä¶
  </div>

  <div class="top">
    <div class="card hero">
      <h1>FORAN/BAGUD (akkumuleret)</h1>
      <div class="kpi">
        <div class="big" id="kpiMonths">‚Äì</div>
        <div class="unit">m√•neder</div>
        <div class="pill" id="kpiPill">‚Äì</div>
      </div>
      <div class="sub" id="kpiSub">Indtast depotv√¶rdi for denne m√•ned for at starte.</div>
      <div style="margin-top:12px">
        <div style="font-size:12px;color:var(--muted);font-weight:800">Fremskridt mod alder 62 (benchmark)</div>
        <div class="progress" style="margin-top:6px"><div id="progBar"></div></div>
      </div>
    </div>

    <div class="right">
      <div class="row">
        <div class="card mini">
          <h3>N√ÜSTE INDBETALING (bl√∏d korrektion)</h3>
          <div class="val" id="nextPay">‚Äì</div>
          <div class="hint">10.000 kr +/‚àí justering fordelt over 12 mdr</div>
        </div>
        <div class="card mini">
          <h3>STREAK</h3>
          <div class="val" id="streak">‚Äì</div>
          <div class="hint" id="streakHint">‚Äì</div>
        </div>
      </div>

      <div class="card">
        <div class="form">
          <div class="field">
            <label for="month">M√•ned</label>
            <input id="month" type="month"/>
          </div>
          <div class="field">
            <label for="value">Depotv√¶rdi (kr)</label>
            <input id="value" inputmode="numeric" placeholder="fx 325000"/>
          </div>
          <div class="field full actions">
            <button id="saveBtn">Gem m√•ned</button>
            <button class="secondary" id="editBtn">Ret seneste</button>
            <button class="secondary" id="exportBtn">Eksport√©r backup</button>
            <button class="secondary" id="importBtn">Import√©r backup</button>
            <button class="danger" id="resetBtn">Nulstil</button>
          </div>
        </div>
        <div style="font-size:12px;color:var(--muted);margin-top:10px">
          Benchmark: 10.000 kr/md og 6% p.a. (fast). Du indtaster kun depotv√¶rdi.
        </div>
      </div>
    </div>
  </div>

  <div class="card chartCard">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
      <div>
        <div style="font-weight:900">Plan vs. faktisk</div>
        <div style="font-size:12px;color:var(--muted)">To linjer. Ingen st√∏j.</div>
      </div>
      <div style="font-size:12px;color:var(--muted)" id="meta"></div>
    </div>
    <canvas id="chart"></canvas>
  </div>

  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
      <div style="font-weight:900">Seneste 18 m√•neder</div>
      <div style="font-size:12px;color:var(--muted)">Backup anbefales 1 gang om m√•neden.</div>
    </div>
    <table>
      <thead>
        <tr><th>Periode</th><th>Faktisk</th><th>Plan</th><th>Afvigelse</th><th>M√•neder</th></tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

  <div class="footer">
    <div>Tip: Safari ‚Üí Del ‚Üí ‚ÄúF√∏j til hjemmesk√¶rm‚Äù for app-ikon.</div>
    <div>Hvis iOS blokerer lagring for lokale filer: brug ‚ÄúEksport√©r backup‚Äù (√©n fil) + ‚ÄúImport√©r‚Äù ved behov.</div>
  </div>
</div>

<input id="filePick" type="file" accept="application/json" class="hidden"/>

<script>
(async function(){
  // Fixed benchmark
  const PMT = 10000;
  const annual = 0.06;
  const r = Math.pow(1+annual, 1/12) - 1;  // effective monthly rate
  const refSpend = 40000;
  const catchUpMonths = 12;
  const N_TARGET = 16*12;

  const $ = (id)=>document.getElementById(id);
  const monthEl = $("month"), valueEl = $("value");
  const saveBtn = $("saveBtn"), editBtn = $("editBtn");
  const exportBtn = $("exportBtn"), importBtn = $("importBtn");
  const resetBtn = $("resetBtn"), filePick = $("filePick");
  const kpiMonths = $("kpiMonths"), kpiPill = $("kpiPill"), kpiSub = $("kpiSub");
  const nextPay = $("nextPay"), streakEl = $("streak"), streakHint = $("streakHint");
  const meta = $("meta"), rows = $("rows"), progBar = $("progBar");
  const banner = $("storageBanner");
  const chart = $("chart"), ctx = chart.getContext("2d");

  // ---------- Storage layer (LocalStorage -> IndexedDB -> Memory + backup) ----------
  const KEY = "depotTracker_6pct_v2";
  let mem = [];

  function lsAvailable(){
    try{
      const t="__t__"+Date.now();
      localStorage.setItem(t,"1");
      localStorage.removeItem(t);
      return true;
    }catch(e){ return false; }
  }

  function idbAvailable(){
    return !!window.indexedDB;
  }

  async function idbOpen(){
    return new Promise((resolve,reject)=>{
      const req = indexedDB.open("DepotTrackerDB", 1);
      req.onupgradeneeded = ()=>{
        const db = req.result;
        if(!db.objectStoreNames.contains("kv")) db.createObjectStore("kv");
      };
      req.onsuccess = ()=> resolve(req.result);
      req.onerror = ()=> reject(req.error);
    });
  }

  async function idbGet(db, k){
    return new Promise((resolve,reject)=>{
      const tx = db.transaction("kv","readonly");
      const store = tx.objectStore("kv");
      const req = store.get(k);
      req.onsuccess = ()=> resolve(req.result);
      req.onerror = ()=> reject(req.error);
    });
  }

  async function idbSet(db, k, v){
    return new Promise((resolve,reject)=>{
      const tx = db.transaction("kv","readwrite");
      const store = tx.objectStore("kv");
      const req = store.put(v, k);
      req.onsuccess = ()=> resolve(true);
      req.onerror = ()=> reject(req.error);
    });
  }

  let mode = "memory"; // "localStorage" | "indexedDB" | "memory"
  let db = null;

  async function initStorage(){
    if(lsAvailable()){
      mode = "localStorage";
      banner.innerHTML = "<strong>Storage:</strong> localStorage (OK). Data gemmes p√• enheden.";
      return;
    }
    if(idbAvailable()){
      try{
        db = await idbOpen();
        mode = "indexedDB";
        banner.innerHTML = "<strong>Storage:</strong> IndexedDB (OK). Data gemmes p√• enheden.";
        return;
      }catch(e){ /* fallthrough */ }
    }
    mode = "memory";
    banner.innerHTML = "<strong>Storage:</strong> begr√¶nset af iOS for lokale filer. Brug <strong>Eksport√©r backup</strong> efter indtastning.";
  }

  async function load(){
    if(mode==="localStorage"){
      try{ return JSON.parse(localStorage.getItem(KEY) || "[]"); }catch(e){ return []; }
    }
    if(mode==="indexedDB"){
      try{
        const v = await idbGet(db, KEY);
        return Array.isArray(v) ? v : [];
      }catch(e){ return []; }
    }
    return mem.slice();
  }

  async function save(data){
    if(mode==="localStorage"){
      localStorage.setItem(KEY, JSON.stringify(data));
      return true;
    }
    if(mode==="indexedDB"){
      await idbSet(db, KEY, data);
      return true;
    }
    mem = data.slice();
    return false; // indicates not persisted
  }

  // ---------- Math helpers ----------
  function fmt(n){ if(n==null||!isFinite(n)) return "‚Äì"; return new Intl.NumberFormat("da-DK").format(Math.round(n)); }
  function fmt1(n){ if(n==null||!isFinite(n)) return "‚Äì"; return (Math.round(n*10)/10).toLocaleString("da-DK",{minimumFractionDigits:1,maximumFractionDigits:1}); }
  function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }

  function planned(n){
    return PMT * ((Math.pow(1+r, n) - 1) / r);
  }
  function monthDiff(a,b){
    const [ay,am] = a.split("-").map(Number);
    const [by,bm] = b.split("-").map(Number);
    return (ay-by)*12 + (am-bm);
  }
  function sorted(data){
    return data.slice().sort((x,y)=> x.m < y.m ? -1 : (x.m > y.m ? 1 : 0));
  }

  function compute(data){
    const s = sorted(data);
    if(s.length===0) return {items:[], last:null, streak:0, pTarget:planned(N_TARGET)};
    const start = s[0].m;
    const items = s.map((row)=>{
      const n = monthDiff(row.m, start) + 1;
      const p = planned(n);
      const dev = row.v - p;
      return {...row, n, p, dev};
    });
    const last = items[items.length-1];
    let streak = 1;
    for(let i=items.length-1;i>0;i--){
      if(monthDiff(items[i].m, items[i-1].m)===1) streak++;
      else break;
    }
    return {items, last, streak, pTarget:planned(N_TARGET)};
  }

  // ---------- Chart ----------
  function drawChart(labels, planArr, actualArr){
    const dpr = window.devicePixelRatio || 1;
    const rect = chart.getBoundingClientRect();
    chart.width = Math.floor(rect.width * dpr);
    chart.height = Math.floor(rect.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    const W = rect.width, H = rect.height;
    ctx.clearRect(0,0,W,H);

    const padL=46,padR=14,padT=18,padB=26;
    const all = planArr.concat(actualArr).filter(x=>isFinite(x));
    const maxY = all.length ? Math.max(...all)*1.06 : 1;
    const minY = 0;

    // grid
    ctx.strokeStyle = "rgba(255,255,255,.08)";
    ctx.lineWidth = 1;
    const gridN=5;
    for(let i=0;i<=gridN;i++){
      const y = padT + (H-padT-padB)*(i/gridN);
      ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke();
    }

    // y labels
    ctx.fillStyle = "rgba(169,183,211,.9)";
    ctx.font = "12px -apple-system, system-ui, sans-serif";
    for(let i=0;i<=gridN;i++){
      const val = maxY - (maxY-minY)*(i/gridN);
      const y = padT + (H-padT-padB)*(i/gridN);
      ctx.fillText(new Intl.NumberFormat("da-DK",{notation:"compact",maximumFractionDigits:1}).format(val), 6, y+4);
    }

    function xAt(i){
      if(labels.length<=1) return padL;
      return padL + (W-padL-padR) * (i/(labels.length-1));
    }
    function yAt(v){
      return padT + (H-padT-padB) * (1 - (v-minY)/(maxY-minY || 1));
    }
    function line(arr, stroke){
      if(arr.length<2) return;
      ctx.strokeStyle = stroke;
      ctx.lineWidth = 2.5;
      ctx.beginPath();
      for(let i=0;i<arr.length;i++){
        const x=xAt(i), y=yAt(arr[i]);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();
    }

    line(planArr, "rgba(106,166,255,1)");
    line(actualArr, "rgba(25,195,125,1)");

    // legend
    const lx=padL, ly=14;
    ctx.fillStyle="rgba(106,166,255,1)"; ctx.fillRect(lx,ly,14,4);
    ctx.fillStyle="rgba(232,238,252,.95)"; ctx.fillText("Plan", lx+20, ly+6);
    ctx.fillStyle="rgba(25,195,125,1)"; ctx.fillRect(lx+70,ly,14,4);
    ctx.fillStyle="rgba(232,238,252,.95)"; ctx.fillText("Faktisk", lx+90, ly+6);

    if(labels.length){
      ctx.fillStyle="rgba(169,183,211,.9)";
      ctx.fillText(labels[0], padL, H-8);
      ctx.fillText(labels[labels.length-1], W-padR-52, H-8);
    }
  }

  // ---------- UI ----------
  async function render(){
    const data = await load();
    const {items, last, streak, pTarget} = compute(data);

    const now = new Date();
    const ym = now.toISOString().slice(0,7);
    if(!monthEl.value) monthEl.value = ym;

    if(!last){
      kpiMonths.textContent="‚Äì";
      kpiPill.textContent="Indtast f√∏rste m√•ned";
      kpiPill.className="pill warn";
      kpiSub.textContent="Indtast depotv√¶rdi og tryk Gem.";
      nextPay.textContent=fmt(PMT)+" kr";
      streakEl.textContent="‚Äì";
      streakHint.textContent="Start med f√∏rste m√•ned.";
      meta.textContent=`Benchmark ved 62: ca. ${fmt(pTarget)} kr (10.000 kr/md & 6% p.a.)`;
      rows.innerHTML="";
      progBar.style.width="0%";
      drawChart([],[],[]);
      return;
    }

    const dev = last.dev;
    const monthsAhead = dev / refSpend;

    kpiMonths.textContent = (monthsAhead>=0?"+":"") + fmt1(monthsAhead);
    if(monthsAhead>=0){ kpiPill.textContent="üíö Foran planen"; kpiPill.className="pill good"; }
    else { kpiPill.textContent="üü° Juster lidt"; kpiPill.className="pill warn"; }
    kpiSub.textContent = `Senest: ${last.m}. Afvigelse: ${fmt(dev)} kr vs benchmark.`;

    let suggested = PMT - (dev / catchUpMonths);
    suggested = Math.max(0, suggested);
    nextPay.textContent = fmt(suggested) + " kr";

    streakEl.textContent = `${streak}`;
    streakHint.textContent = "m√•neder i tr√¶k uden huller";

    const progress = clamp(last.p / pTarget, 0, 1);
    progBar.style.width = (progress*100).toFixed(1) + "%";

    meta.textContent = `Benchmark ved 62 (m√•ned ${N_TARGET}): ca. ${fmt(pTarget)} kr`;

    const tail = items.slice(-18).reverse();
    rows.innerHTML = tail.map(rw=>{
      const m = rw.dev / refSpend;
      const tag = m>=0 ? "good" : "warn";
      const sign = m>=0 ? "+" : "";
      return `<tr>
        <td><span class="tag ${tag}">${rw.m}</span></td>
        <td>${fmt(rw.v)}</td>
        <td>${fmt(rw.p)}</td>
        <td>${fmt(rw.dev)}</td>
        <td>${sign}${fmt1(m)}</td>
      </tr>`;
    }).join("");

    drawChart(items.map(x=>x.m), items.map(x=>x.p), items.map(x=>x.v));
  }

  async function upsertMonth(m, v){
    const data = await load();
    const idx = data.findIndex(x=>x.m===m);
    const row = {m, v};
    if(idx>=0) data[idx]=row; else data.push(row);
    const persisted = await save(data);
    return persisted;
  }

  function lastMonth(data){
    if(!data.length) return null;
    return sorted(data)[data.length-1].m;
  }

  // ---------- Events ----------
  saveBtn.addEventListener("click", async ()=>{
    const m = monthEl.value;
    const raw = (valueEl.value||"").toString().replace(/\./g,"").replace(/\s/g,"").replace(/,/g,".");
    const v = Number(raw);
    if(!m || !isFinite(v) || v<=0){
      alert("Indtast b√•de m√•ned og en depotv√¶rdi (tal).");
      return;
    }
    const persisted = await upsertMonth(m, v);
    valueEl.value="";
    await render();
    if(!persisted){
      alert("iOS blokerer lokal lagring for denne fil. Tryk 'Eksport√©r backup' (√©n fil) efter indtastning.");
    }
  });

  editBtn.addEventListener("click", async ()=>{
    const data = await load();
    const lm = lastMonth(data);
    if(!lm){ alert("Ingen data endnu."); return; }
    monthEl.value = lm;
    const row = data.find(x=>x.m===lm);
    valueEl.value = row ? String(row.v) : "";
    valueEl.focus();
  });

  exportBtn.addEventListener("click", async ()=>{
    const data = await load();
    const blob = new Blob([JSON.stringify({version:2, benchmark:{pmt:PMT, annual}, data}, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "depot-tracker-backup.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  importBtn.addEventListener("click", ()=> filePick.click());
  filePick.addEventListener("change", async (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const text = await file.text();
    try{
      const obj = JSON.parse(text);
      if(!obj || !Array.isArray(obj.data)) throw new Error("Ugyldigt format");
      const current = await load();
      const map = new Map(current.map(x=>[x.m, x.v]));
      for(const r of obj.data){
        if(r && typeof r.m==="string" && isFinite(r.v)) map.set(r.m, r.v);
      }
      const merged = Array.from(map.entries()).map(([m,v])=>({m,v}));
      await save(merged);
      filePick.value="";
      await render();
    }catch(err){
      alert("Kunne ikke importere filen. (Forkert format)");
    }
  });

  resetBtn.addEventListener("click", async ()=>{
    if(confirm("Nulstil alt?")){
      if(lsAvailable()) localStorage.removeItem(KEY);
      if(mode==="indexedDB" && db) await idbSet(db, KEY, []);
      mem = [];
      await render();
    }
  });

  window.addEventListener("resize", ()=> render());

  await initStorage();
  await render();
})();
</script>
</body>
</html>
