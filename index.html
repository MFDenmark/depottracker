<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Freedom Engine ELITE</title>
<style>
:root{
  --bg:#071620; --panel:#0d2230; --card:#0f2a3a; --text:#eaf2f7; --muted:#a7c0cf;
  --good:#1fd08a; --warn:#f7c948; --bad:#ff5a5f; --accent:#6aa9ff;
  --shadow:0 18px 40px rgba(0,0,0,.35);
  --r:20px;
}
*{box-sizing:border-box}
body{
  margin:0; background:radial-gradient(900px 600px at 20% 10%, rgba(106,169,255,.14), transparent 60%),
                   radial-gradient(700px 500px at 80% 30%, rgba(31,208,138,.10), transparent 55%),
                   var(--bg);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","Segoe UI",Roboto,Helvetica,Arial;
}
.wrap{max-width:980px; margin:0 auto; padding:18px 14px 70px;}
.top{
  display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
  margin-bottom:12px;
}
.brand{font-weight:800; letter-spacing:.2px; font-size:20px}
.pill{
  display:inline-flex; align-items:center; gap:8px;
  padding:8px 12px; border-radius:999px; background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.10);
  color:var(--muted); font-weight:600; font-size:13px;
}
.dot{width:10px;height:10px;border-radius:50%}
.grid{display:grid; grid-template-columns:1fr; gap:14px;}
@media(min-width:860px){ .grid{grid-template-columns:1.1fr .9fr;} }
.card{
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  border:1px solid rgba(255,255,255,.10);
  border-radius:var(--r);
  box-shadow:var(--shadow);
  padding:16px;
}
.h1{font-size:16px; font-weight:800; letter-spacing:.2px; margin:0 0 6px}
.small{color:var(--muted); font-size:13px; line-height:1.35}
.big{
  font-size:52px; font-weight:900; letter-spacing:-1px; margin:10px 0 2px;
}
.subbig{font-size:22px; font-weight:800; margin:0 0 10px}
.hr{height:1px; background:rgba(255,255,255,.10); margin:12px 0}
.row{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
.kpi{display:flex; flex-direction:column; gap:2px}
.kpi b{font-size:18px}
.kpi span{font-size:12px; color:var(--muted)}
.btns{display:flex; gap:10px; flex-wrap:wrap}
.btn{
  user-select:none;
  background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.12);
  color:var(--text);
  padding:10px 14px;
  border-radius:16px;
  font-weight:800;
  font-size:15px;
  min-width:74px;
  text-align:center;
}
.btn:active{transform:scale(.99)}
.btn.sel{border-color:rgba(106,169,255,.55); box-shadow:0 0 0 3px rgba(106,169,255,.18)}
.badge{
  display:inline-flex; align-items:center; gap:8px;
  padding:12px 14px; border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.05);
  font-weight:900;
}
.badge.good{border-color:rgba(31,208,138,.55); box-shadow:0 0 0 3px rgba(31,208,138,.15)}
.badge.warn{border-color:rgba(247,201,72,.55); box-shadow:0 0 0 3px rgba(247,201,72,.15)}
.badge.bad{border-color:rgba(255,90,95,.55); box-shadow:0 0 0 3px rgba(255,90,95,.14)}
.input, select{
  width:100%;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.20);
  color:var(--text);
  font-size:16px;
  outline:none;
}
.label{font-weight:800; font-size:13px; color:var(--muted); margin:10px 0 6px}
details{
  border-radius:var(--r);
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.03);
  overflow:hidden;
}
summary{
  list-style:none;
  cursor:pointer;
  padding:14px 16px;
  font-weight:900;
  display:flex; align-items:center; justify-content:space-between; gap:10px;
}
summary::-webkit-details-marker{display:none}
.chev{opacity:.7}
.pad{padding:0 16px 16px}
.footerbar{
  position:fixed; left:0; right:0; bottom:0;
  background:rgba(7,22,32,.85);
  backdrop-filter: blur(10px);
  border-top:1px solid rgba(255,255,255,.10);
  padding:10px 12px;
}
.footerbar .wrap2{max-width:980px;margin:0 auto;display:flex;gap:10px;align-items:center;justify-content:space-between}
.primary{
  background:linear-gradient(180deg, rgba(106,169,255,.95), rgba(106,169,255,.70));
  border:1px solid rgba(255,255,255,.18);
  color:#06131b;
  padding:12px 14px;
  border-radius:16px;
  font-weight:900;
}
.ghost{
  background:transparent; border:1px solid rgba(255,255,255,.16); color:var(--text);
  padding:12px 14px; border-radius:16px; font-weight:900;
}
.note{
  font-size:12px; color:var(--muted); line-height:1.35
}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
.progress{
  height:12px; border-radius:999px; background:rgba(255,255,255,.08); overflow:hidden;
  border:1px solid rgba(255,255,255,.10)
}
.bar{height:100%; width:0%}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="brand">Freedom Engine <span style="opacity:.7">ELITE</span></div>
    <div class="pill" id="storagePill"><span class="dot" id="storageDot"></span><span id="storageTxt">Storage‚Ä¶</span></div>
  </div>

  <div class="grid">
    <div class="card" id="frontCard">
      <div class="row">
        <div>
          <div class="h1">FORSIDE (simpel)</div>
          <div class="small" id="headlineSmall">Indstil afkast og se realistisk friheds-dato. Admin er skjult nederst.</div>
        </div>
        <div class="badge" id="signalBadge"><span class="dot" id="signalDot"></span><span id="signalTxt">Beregner‚Ä¶</span></div>
      </div>

      <div class="hr"></div>

      <div class="small">Hurtigvalg: forventet afkast (opsparing)</div>
      <div class="btns" id="returnBtns">
        <div class="btn" data-r="0.06">6%</div>
        <div class="btn" data-r="0.07">7%</div>
        <div class="btn sel" data-r="0.08">8%</div>
        <div class="btn" data-r="0.09">9%</div>
      </div>
      <div class="small" style="margin-top:8px">Tryk ‚Üí gemmer lokalt og genberegner (Monte Carlo).</div>

      <div class="hr"></div>

      <div class="small">üéØ Realistisk frihed (80% sandsynlighed)</div>
      <div class="big" id="dateBig">‚Äî</div>
      <div class="subbig" id="ageBig">Alder ca. ‚Äî</div>

      <div class="row">
        <div class="kpi">
          <b id="monthsTo">‚Äî</b>
          <span>Tid til realistisk m√•l (80%)</span>
        </div>
        <div class="kpi">
          <b id="prob62">‚Äî</b>
          <span>Sandsynlighed for at ramme <span id="goalAgeLbl">62</span> √•r</span>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div class="kpi">
          <b id="targetCapital">‚Äî</b>
          <span>Kapital-m√•l ved <span id="goalAgeLbl2">62</span> √•r (bro)</span>
        </div>
        <div class="kpi">
          <b id="needMonthlyGross">‚Äî</b>
          <span>M√•l: <span id="netNeedLbl">35.000</span> udbetalt ‚áí brutto salg pr. md (est.)</span>
        </div>
      </div>

      <div class="hr"></div>

      <div class="label">‚ÄúHvad hvis jeg indbetaler ‚Ä¶ kr mere/mindre pr. m√•ned?‚Äù</div>
      <input class="input" id="whatIfDelta" inputmode="numeric" placeholder="fx 2000 eller -1000" value="0"/>
      <div class="small" style="margin-top:8px" id="whatIfResult">‚Äî</div>

      <div class="hr"></div>
      <div class="note">
        Modellen er en forenkling: historiske afkast er ikke garanti. Resultater er <b>ikke</b> r√•dgivning.
      </div>
    </div>

    <div class="card">
      <div class="h1">M√•nedlig tracker (valgfri)</div>
      <div class="small">Hvis du taster din depotv√¶rdi hver m√•ned, f√•r du ‚Äúforan/bagud‚Äù i forhold til median-prognosen.</div>

      <div class="label">M√•ned (YYYY-MM)</div>
      <input class="input mono" id="mMonth" placeholder="fx 2026-03"/>
      <div class="label">Depotv√¶rdi (kr)</div>
      <input class="input mono" id="mValue" inputmode="numeric" placeholder="fx 250000" />
      <div class="btns" style="margin-top:10px">
        <div class="btn" id="saveMonth">Gem m√•ned</div>
        <div class="btn" id="editLast">Ret seneste</div>
        <div class="btn" id="exportBtn">Eksport√©r</div>
        <div class="btn" id="importBtn">Import√©r</div>
      </div>
      <input type="file" id="importFile" accept="application/json" style="display:none"/>

      <div class="hr"></div>
      <div class="row">
        <div class="kpi">
          <b id="aheadBehind">‚Äî</b>
          <span>M√•neder foran/bagud (mod median-plan)</span>
        </div>
        <div class="kpi">
          <b id="lastEntry">‚Äî</b>
          <span>Seneste indtastning</span>
        </div>
      </div>

      <div class="label">Fremskridt mod m√•let</div>
      <div class="progress"><div class="bar" id="progBar"></div></div>
      <div class="small" style="margin-top:6px" id="progTxt">‚Äî</div>
    </div>
  </div>

  <div style="height:14px"></div>

  <details id="adminBox">
    <summary>Admin (bagved) ‚Äî realistisk baseline <span class="chev">‚ñæ</span></summary>
    <div class="pad">
      <div class="small">Her kan du √¶ndre antagelser. Forsiden er til ‚Äúikke-matematikeren‚Äù.</div>

      <div class="label">Alder nu</div>
      <input class="input" id="pAgeNow" inputmode="numeric" value="46"/>

      <div class="label">M√•l-alder (frihed)</div>
      <input class="input" id="pGoalAge" inputmode="numeric" value="62"/>

      <div class="label">Startsaldo (kr)</div>
      <input class="input mono" id="pStart" inputmode="numeric" value="0"/>

      <div class="label">Indbetaling (kr/md)</div>
      <input class="input mono" id="pContrib" inputmode="numeric" value="10000"/>

      <div class="label">Forventet afkast (opsparing, √•rligt)</div>
      <input class="input mono" id="pRsave" inputmode="decimal" value="0.08"/>

      <div class="label">Volatilitet (√•rligt, til Monte Carlo)</div>
      <input class="input mono" id="pVol" inputmode="decimal" value="0.15"/>

      <div class="hr"></div>

      <div class="h1">Bro til aldersopsparing</div>
      <div class="small">Standard: du vil have <b>35.000 kr udbetalt</b> fra privat depot fra m√•l-alder til aldersopsparing udbetales.</div>

      <div class="label">Netto-udbetaling (kr/md)</div>
      <input class="input mono" id="pNetNeed" inputmode="numeric" value="35000"/>

      <div class="label">Skattefaktor (brutto = netto √ó faktor)</div>
      <input class="input mono" id="pTaxFactor" inputmode="decimal" value="1.13"/>

      <div class="label">Aldersopsparing udbetales (alder)</div>
      <input class="input" id="pAOAge" inputmode="numeric" value="65"/>

      <div class="label">Aldersopsparing bel√∏b (kr) (vises, men indg√•r ikke i broen f√∏r udbetaling)</div>
      <input class="input mono" id="pAOAmount" inputmode="numeric" value="1000000"/>

      <div class="label">Afkast under udbetaling (√•rligt) ‚Äî til broens nutidsv√¶rdi</div>
      <input class="input mono" id="pRdraw" inputmode="decimal" value="0.04"/>

      <div class="label">Sikkerhedsbuffer (mdr)</div>
      <input class="input" id="pBufferM" inputmode="numeric" value="0"/>

      <div class="hr"></div>

      <div class="h1">Tekniske valg</div>
      <div class="label">Simulationer (Monte Carlo paths)</div>
      <input class="input" id="pPaths" inputmode="numeric" value="2000"/>

      <div class="label">Seed (tal) ‚Äî g√∏r resultat stabilt</div>
      <input class="input" id="pSeed" inputmode="numeric" value="42"/>

      <div class="btns" style="margin-top:12px">
        <button class="primary" id="saveParams" type="button">Gem parametre</button>
        <button class="ghost" id="resetAll" type="button">Nulstil alt</button>
      </div>

      <div class="hr"></div>
      <div class="note">
        Data gemmes <b>kun lokalt</b> i din browser (LocalStorage). Brug ‚ÄúEksport√©r‚Äù 1√ó/md hvis du vil kunne flytte/restore.
      </div>
    </div>
  </details>
</div>

<div class="footerbar">
  <div class="wrap2">
    <div class="note"><span class="mono" id="baselineLine">Baseline: ‚Äî</span></div>
    <button class="primary" type="button" id="recalcBtn">Genberegn</button>
  </div>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  const STORAGE_KEY = "freedom_engine_elite_v23";
  const TRACK_KEY = "freedom_engine_elite_v23_track";

  function hasStorage(){
    try{ localStorage.setItem("__t","1"); localStorage.removeItem("__t"); return true; }catch(e){ return false; }
  }

  function fmtKr(x){
    if (!isFinite(x)) return "‚Äî";
    return Math.round(x).toLocaleString("da-DK") + " kr";
  }
  function fmtPct(x){
    if (!isFinite(x)) return "‚Äî";
    return (x*100).toFixed(1).replace(".",",")+"%";
  }
  function monthName(d){
    return d.toLocaleString("da-DK",{month:"short"}).replace(".","").toLowerCase();
  }
  function addMonths(date, m){
    const d = new Date(date.getTime());
    const day = d.getDate();
    d.setMonth(d.getMonth()+m);
    // fix for month rollover
    if (d.getDate() !== day) d.setDate(0);
    return d;
  }
  // deterministic PRNG for stable MC
  function mulberry32(a){
    return function(){
      let t = a += 0x6D2B79F5;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    }
  }
  function randn(rng){
    // Box-Muller
    let u=0,v=0;
    while(u===0) u=rng();
    while(v===0) v=rng();
    return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
  }

  function loadParams(){
    const def = {
      ageNow:46, goalAge:62, start:0, contrib:10000,
      rSave:0.08, vol:0.15,
      netNeed:35000, taxFactor:1.13,
      aoAge:65, aoAmount:1000000,
      rDraw:0.04, bufferM:0,
      paths:2000, seed:42
    };
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return def;
      const obj = JSON.parse(raw);
      return Object.assign(def, obj||{});
    }catch(e){ return def; }
  }

  function saveParams(p){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(p));
  }

  function readAdminToParams(){
    const p = loadParams();
    p.ageNow = +$("pAgeNow").value;
    p.goalAge = +$("pGoalAge").value;
    p.start = +$("pStart").value;
    p.contrib = +$("pContrib").value;
    p.rSave = +$("pRsave").value;
    p.vol = +$("pVol").value;
    p.netNeed = +$("pNetNeed").value;
    p.taxFactor = +$("pTaxFactor").value;
    p.aoAge = +$("pAOAge").value;
    p.aoAmount = +$("pAOAmount").value;
    p.rDraw = +$("pRdraw").value;
    p.bufferM = +$("pBufferM").value;
    p.paths = Math.max(300, Math.min(20000, Math.floor(+$("pPaths").value||2000)));
    p.seed = Math.floor(+$("pSeed").value||42);
    return p;
  }

  function fillAdmin(p){
    $("pAgeNow").value = p.ageNow;
    $("pGoalAge").value = p.goalAge;
    $("pStart").value = p.start;
    $("pContrib").value = p.contrib;
    $("pRsave").value = p.rSave;
    $("pVol").value = p.vol;
    $("pNetNeed").value = p.netNeed;
    $("pTaxFactor").value = p.taxFactor;
    $("pAOAge").value = p.aoAge;
    $("pAOAmount").value = p.aoAmount;
    $("pRdraw").value = p.rDraw;
    $("pBufferM").value = p.bufferM;
    $("pPaths").value = p.paths;
    $("pSeed").value = p.seed;
  }

  function targetCapital(p){
    // PV of withdrawals from goalAge to aoAge (+ buffer) discounted with rDraw
    const n = Math.max(0, Math.round((p.aoAge - p.goalAge)*12 + p.bufferM));
    const r = p.rDraw/12;
    const gross = p.netNeed * p.taxFactor;
    if (n===0) return 0;
    if (Math.abs(r) < 1e-9) return gross*n;
    return gross * (1 - Math.pow(1+r, -n)) / r;
  }

  function simulate(p, contribOverride){
    const rngBase = mulberry32(p.seed>>>0);
    const monthsToGoalAge = Math.max(0, Math.round((p.goalAge - p.ageNow)*12));
    const capTarget = targetCapital(p);
    const paths = p.paths;
    const rM = p.rSave/12;
    const volM = p.vol/Math.sqrt(12);
    const contrib = (contribOverride==null? p.contrib : contribOverride);

    let hitMonthArr = []; // month index when capTarget reached, else Infinity
    let hitByGoal=0;

    // also build median path for tracker (single deterministic expected path)
    const expectedPath = [];
    let vExp = p.start;
    for(let m=0;m<=monthsToGoalAge;m++){
      expectedPath.push(vExp);
      vExp = vExp*(1+rM) + contrib;
    }

    for(let i=0;i<paths;i++){
      // vary seed per path deterministically
      const rng = mulberry32((Math.floor(rngBase()*1e9) ^ (i*2654435761))>>>0);
      let v = p.start;
      let hit = Infinity;
      for(let m=0;m<=monthsToGoalAge; m++){
        if (v >= capTarget && hit===Infinity) hit = m;
        // step
        const z = randn(rng);
        const ret = rM + volM*z;
        v = v*(1+ret) + contrib;
      }
      if (v >= capTarget) hitByGoal++;
      hitMonthArr.push(hit);
    }

    hitMonthArr.sort((a,b)=>a-b);
    const q = (p)=>hitMonthArr[Math.min(hitMonthArr.length-1, Math.max(0, Math.floor(p*hitMonthArr.length)-1))];
    // better quantile: use indices for 20/50/80% among finite hits; but keep all for "date when reached" incl Infinity
    function quantileFinite(prob){
      const finite = hitMonthArr.filter(x=>isFinite(x));
      if (!finite.length) return Infinity;
      const idx = Math.max(0, Math.min(finite.length-1, Math.floor(prob*(finite.length-1))));
      return finite[idx];
    }
    const m20 = quantileFinite(0.20);
    const m50 = quantileFinite(0.50);
    const m80 = quantileFinite(0.80);

    return {
      monthsToGoalAge,
      capTarget,
      probHitByGoal: hitByGoal/paths,
      m20, m50, m80,
      expectedPath
    };
  }

  function setSignal(state, txt){
    const badge = $("signalBadge");
    const dot = $("signalDot");
    badge.classList.remove("good","warn","bad");
    dot.style.background = "var(--muted)";
    if(state==="good"){ badge.classList.add("good"); dot.style.background="var(--good)"; }
    if(state==="warn"){ badge.classList.add("warn"); dot.style.background="var(--warn)"; }
    if(state==="bad"){ badge.classList.add("bad"); dot.style.background="var(--bad)"; }
    $("signalTxt").textContent = txt;
  }

  function updateReturnButtons(p){
    document.querySelectorAll("#returnBtns .btn").forEach(b=>{
      b.classList.toggle("sel", Math.abs(+b.dataset.r - p.rSave) < 1e-9);
    });
  }

  function dateFromMonths(m){
    const base = new Date();
    const d = addMonths(new Date(base.getFullYear(), base.getMonth(), 1), m);
    return d;
  }
  function fmtMonthYear(d){
    return `${monthName(d)} ${d.getFullYear()}`;
  }

  function monthsAndYears(m){
    const years = Math.floor(m/12);
    const mm = m%12;
    if(years<=0) return `${mm} mdr`;
    if(mm===0) return `${years} √•r`;
    return `${years} √•r ${mm} mdr`;
  }

  function updateUI(p){
    // baseline line
    $("baselineLine").textContent = `Baseline: ${(p.rSave*100).toFixed(1).replace(".",",")}% | ${fmtKr(p.netNeed)} udbetalt | x${p.taxFactor.toFixed(2).replace(".",",")} skat`;

    $("goalAgeLbl").textContent = p.goalAge;
    $("goalAgeLbl2").textContent = p.goalAge;
    $("netNeedLbl").textContent = Math.round(p.netNeed).toLocaleString("da-DK");

    updateReturnButtons(p);

    // compute main sim
    setSignal("warn","Beregner‚Ä¶");
    const res = simulate(p, null);

    const capT = res.capTarget;
    $("targetCapital").textContent = fmtKr(capT);
    $("needMonthlyGross").textContent = fmtKr(p.netNeed * p.taxFactor);

    const m80 = res.m80;
    const hit80 = isFinite(m80) ? dateFromMonths(m80) : null;

    if (!hit80){
      $("dateBig").textContent = "‚Äî";
      $("ageBig").textContent = "Alder ca. ‚Äî";
      $("monthsTo").textContent = "‚Äî";
      setSignal("bad","Ikke i sigte (80%)");
    } else {
      $("dateBig").textContent = fmtMonthYear(hit80);
      const ageAt = p.ageNow + (m80/12);
      $("ageBig").textContent = `Alder ca. ${ageAt.toFixed(1).replace(".",",")} √•r`;
      $("monthsTo").textContent = monthsAndYears(Math.max(0, Math.round(m80)));
      // signal vs goalAge date
      const goalDate = dateFromMonths(res.monthsToGoalAge);
      const diff = (hit80.getFullYear()-goalDate.getFullYear())*12 + (hit80.getMonth()-goalDate.getMonth());
      if (diff <= 0) setSignal("good","Klar f√∏r/ved m√•let");
      else if (diff <= 12) setSignal("warn","T√¶t p√•");
      else setSignal("bad","Ikke endnu");
    }

    $("prob62").textContent = fmtPct(res.probHitByGoal);

    // what-if delta
    const delta = +$("whatIfDelta").value || 0;
    const res2 = simulate(p, p.contrib + delta);
    const m80b = res2.m80;
    if (!isFinite(m80b)){
      $("whatIfResult").textContent = "Med den indbetaling rammer du ikke m√•let i simuleringen (80%).";
    } else {
      const d2 = dateFromMonths(m80b);
      const age2 = p.ageNow + (m80b/12);
      const sign = (delta>=0?"+":"");
      $("whatIfResult").textContent = `Hvis du √¶ndrer indbetaling med ${sign}${Math.round(delta).toLocaleString("da-DK")} kr/md: realistisk (80%) ‚Üí ${fmtMonthYear(d2)} (alder ca. ${age2.toFixed(1).replace(".",",")}).`;
    }

    // tracker stats
    updateTracker(res.expectedPath, p);
  }

  function loadTrack(){
    try{
      const raw = localStorage.getItem(TRACK_KEY);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      if(!Array.isArray(arr)) return [];
      return arr;
    }catch(e){ return []; }
  }
  function saveTrack(arr){
    localStorage.setItem(TRACK_KEY, JSON.stringify(arr));
  }
  function ymNow(){
    const d=new Date();
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    return `${y}-${m}`;
  }
  function sortTrack(arr){
    arr.sort((a,b)=> (a.month||"").localeCompare(b.month||""));
  }

  function updateTracker(expectedPath, p){
    const track = loadTrack();
    sortTrack(track);
    const last = track.length ? track[track.length-1] : null;
    $("lastEntry").textContent = last ? `${last.month}: ${fmtKr(last.value)}` : "‚Äî";

    // progress toward target at goal age (capTarget)
    const capT = targetCapital(p);
    if (last && capT>0){
      const pct = Math.max(0, Math.min(1, last.value/capT));
      $("progBar").style.width = (pct*100).toFixed(1)+"%";
      $("progBar").style.background = "linear-gradient(90deg, rgba(31,208,138,.9), rgba(106,169,255,.9))";
      $("progTxt").textContent = `${(pct*100).toFixed(1).replace(".",",")}% af m√•l.`;
    } else {
      $("progBar").style.width = "0%";
      $("progBar").style.background = "rgba(255,255,255,.10)";
      $("progTxt").textContent = "Indtast en m√•ned for at se fremskridt.";
    }

    // ahead/behind: compare last.value with expectedPath at same month index since now
    if (!last){
      $("aheadBehind").textContent = "‚Äî";
      return;
    }
    // month index relative to "now month"
    const base = ymNow();
    const idx = monthDiff(base, last.month);
    if (!isFinite(idx) || idx<0 || idx>=expectedPath.length){
      $("aheadBehind").textContent = "‚Äî";
      return;
    }
    const expected = expectedPath[idx];
    // convert difference into "months" using local slope around idx
    const next = expectedPath[Math.min(expectedPath.length-1, idx+1)];
    const slope = Math.max(1, next-expected); // avoid div by 0
    const mAhead = (last.value - expected)/slope;
    $("aheadBehind").textContent = `${mAhead.toFixed(1).replace(".",",")} mdr`;
  }

  function monthDiff(a,b){
    // a,b 'YYYY-MM'
    const pa = /^(\d{4})-(\d{2})$/.exec(a||"");
    const pb = /^(\d{4})-(\d{2})$/.exec(b||"");
    if(!pa || !pb) return NaN;
    const ya=+pa[1], ma=+pa[2];
    const yb=+pb[1], mb=+pb[2];
    return (yb-ya)*12 + (mb-ma);
  }

  function initStoragePill(){
    const ok = hasStorage();
    $("storageDot").style.background = ok ? "var(--good)" : "var(--bad)";
    $("storageTxt").textContent = ok ? "Storage: OK (lokalt p√• enhed)" : "Storage: FEJL (private mode?)";
  }

  // wiring
  function attach(){
    // return buttons
    document.querySelectorAll("#returnBtns .btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const p = loadParams();
        p.rSave = +btn.dataset.r;
        saveParams(p);
        fillAdmin(p);
        updateUI(p);
      });
    });

    $("whatIfDelta").addEventListener("input", ()=>{
      const p = loadParams();
      updateUI(p);
    });

    $("recalcBtn").addEventListener("click", ()=>{
      const p = loadParams();
      updateUI(p);
    });

    $("saveParams").addEventListener("click", ()=>{
      const p = readAdminToParams();
      saveParams(p);
      updateUI(p);
      // close details after save on mobile
      $("adminBox").open = false;
      window.scrollTo({top:0, behavior:"smooth"});
    });

    $("resetAll").addEventListener("click", ()=>{
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(TRACK_KEY);
      const p = loadParams();
      fillAdmin(p);
      $("mMonth").value = "";
      $("mValue").value = "";
      updateUI(p);
    });

    $("saveMonth").addEventListener("click", ()=>{
      const month = ($("mMonth").value||"").trim();
      const value = +($("mValue").value||"");
      if(!/^\d{4}-\d{2}$/.test(month) || !isFinite(value)) { alert("Udfyld m√•ned (YYYY-MM) og v√¶rdi."); return; }
      const arr = loadTrack();
      // upsert by month
      const i = arr.findIndex(x=>x.month===month);
      if(i>=0) arr[i].value = value; else arr.push({month, value});
      sortTrack(arr);
      saveTrack(arr);
      updateUI(loadParams());
    });

    $("editLast").addEventListener("click", ()=>{
      const arr = loadTrack(); sortTrack(arr);
      const last = arr.length? arr[arr.length-1] : null;
      if(!last){ alert("Ingen data endnu."); return; }
      $("mMonth").value = last.month;
      $("mValue").value = last.value;
      window.scrollTo({top:0, behavior:"smooth"});
    });

    $("exportBtn").addEventListener("click", ()=>{
      const payload = { params: loadParams(), track: loadTrack(), version:"v23" };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "freedom_engine_backup.json";
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 500);
    });

    $("importBtn").addEventListener("click", ()=> $("importFile").click());
    $("importFile").addEventListener("change", async (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      try{
        const txt = await file.text();
        const obj = JSON.parse(txt);
        if(obj.params) saveParams(obj.params);
        if(Array.isArray(obj.track)) saveTrack(obj.track);
        const p = loadParams();
        fillAdmin(p);
        updateUI(p);
        alert("Importeret.");
      }catch(err){
        alert("Kunne ikke importere filen.");
      } finally {
        e.target.value = "";
      }
    });
  }

  // boot
  initStoragePill();
  const p = loadParams();
  fillAdmin(p);
  attach();
  updateUI(p);
})();
</script>
</body>
</html>
