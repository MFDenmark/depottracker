<!DOCTYPE html>

<html lang="da">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1,viewport-fit=cover" name="viewport"/>
<title>Tidsl√∏ft ¬∑ Sm√• valg. Store l√∏ft.</title>
<style>
:root{
  --bg1:#f4f8ff;
  --bg2:#e9f1ff;
  --card:#ffffff;
  --text:#0b1220;
  --muted:#5a6b85;
  --line:#e6edf7;
  --blue:#3b82f6;
  --blue2:#1e40af;
  --alt:#06b6d4;
  --shadow: 0 18px 45px rgba(10,30,80,0.10);
  --shadow2: 0 26px 70px rgba(10,30,80,0.14);
  --warn:#b42318;
  --ok:#059669;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  background: linear-gradient(180deg, var(--bg1), var(--bg2));
  color: var(--text);
}
a{color:inherit}
.app{max-width:860px;margin:0 auto;padding:18px 14px 54px;}
.top{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding:10px 6px 14px;
  position:sticky; top:0; z-index:30;
  background: linear-gradient(180deg, rgba(244,248,255,0.92), rgba(244,248,255,0.70));
  backdrop-filter: blur(10px);
}
.brand{display:flex;align-items:center;gap:10px;min-width:0}
.dot{width:10px;height:10px;border-radius:999px;background:linear-gradient(135deg,var(--alt),var(--blue));
  box-shadow:0 0 0 3px rgba(59,130,246,0.10);}
.name{font-weight:950;letter-spacing:-0.02em;line-height:1}
.sub{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.btn{
  border:1px solid var(--line);
  background: rgba(255,255,255,0.90);
  color: var(--text);
  border-radius: 14px;
  padding:10px 12px;
  font-weight:950;
  cursor:pointer;
  box-shadow: 0 10px 26px rgba(10,30,80,0.06);
}
.btn:active{transform:translateY(1px)}
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius: 22px;
  box-shadow: var(--shadow2);
  overflow:hidden;
}
.hero{padding:20px 20px 18px;}
.kicker{font-size:12px;color:var(--muted);letter-spacing:0.10em;text-transform:uppercase;font-weight:950}
.h1{margin:8px 0 0;font-size:44px;line-height:1.02;font-weight:980;letter-spacing:-0.04em}
.p{margin:10px 0 0;font-size:15px;color:var(--muted);line-height:1.5}
@media (max-width:430px){ .h1{font-size:40px} }

.ctaRow{display:flex;gap:10px;margin-top:16px}
.cta{
  flex:1;
  border:0;
  border-radius: 16px;
  padding:14px 14px;
  font-weight:980;
  cursor:pointer;
  color:#fff;
  background: linear-gradient(135deg,var(--blue),var(--blue2));
  box-shadow: 0 16px 34px rgba(30,64,175,0.18);
}
.cta:active{transform:translateY(1px)}
/* Aftalt: "Find flere √•r" skal v√¶re mere tydelig */
.ctaHot{position:relative;min-width:44%;}
.ctaHot{box-shadow:0 18px 42px rgba(30,64,175,0.24), 0 10px 22px rgba(59,130,246,0.16)}
.ctaHot::after{content:"";position:absolute;inset:-6px;border-radius:999px;background:linear-gradient(135deg,rgba(59,130,246,.26),rgba(30,64,175,.16));filter:blur(12px);z-index:-1}
@media (prefers-reduced-motion:no-preference){
  .ctaHot{animation:ctaPulse 2.4s ease-in-out infinite}
  @keyframes ctaPulse{0%,100%{transform:translateY(0)}50%{transform:translateY(-1px)}}
}
.ghost{
  border:1px solid var(--line);
  background:#fff;
  color:rgba(11,18,32,0.88);
  border-radius:16px;
  padding:14px 14px;
  font-weight:980;
  cursor:pointer;
}
.hr{height:1px;background:var(--line);margin:14px 0;}
.hidden{display:none !important}

.stepTitle{font-size:12px;color:var(--muted);font-weight:950;letter-spacing:0.10em;text-transform:uppercase}
.stepH{margin:6px 0 0; font-size:28px; font-weight:980; letter-spacing:-0.03em}
.grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
.fieldLabel{font-size:12px;color:var(--muted);font-weight:950;margin:2px 0 6px}
.input{
  width:100%;
  border:1px solid var(--line);
  border-radius:16px;
  padding:14px 14px;
  font-size:22px;
  font-weight:980;
  outline:none;
}
.hint{font-size:12px;color:var(--muted);line-height:1.45;margin-top:8px}
.warn{color:rgba(180,35,24,0.95);font-weight:950}
.ok{color:rgba(5,150,105,0.95);font-weight:950}

.pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.pill{
  border:1px solid var(--line);
  background: rgba(59,130,246,0.08);
  color: rgba(30,64,175,0.95);
  border-radius:999px;
  padding:9px 12px;
  font-weight:980;
  cursor:pointer;
}
.pill:active{transform:translateY(1px)}

.progressWrap{margin:14px 0 6px;position:relative;height:12px;border-radius:999px;background:rgba(11,18,32,0.10);overflow:hidden}
.progressFill{position:absolute;left:0;top:0;bottom:0;width:0%;background:linear-gradient(90deg,var(--blue),var(--alt));transition:width .18s ease}
.progressMeta{display:flex;justify-content:space-between;gap:10px;font-size:12px;color:var(--muted);margin-top:8px}

.chips{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
@media (min-width:640px){ .chips{grid-template-columns:1fr 1fr} }
.chip{
  display:flex;justify-content:space-between;align-items:center;gap:12px;
  padding:12px 12px;border-radius:16px;border:1px solid var(--line);
  background:#f8fbff;cursor:pointer;font-weight:980;
}
.chipL{display:flex;flex-direction:column;gap:2px;min-width:0}
.chipT{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.chipSub{font-size:12px;font-weight:950;color:var(--muted)}
.chipR{display:flex;flex-direction:column;align-items:flex-end;gap:2px}
.chipGain{font-size:14px;font-weight:980;color:rgba(31,78,216,0.98);text-align:right}
.chip.on{background: rgba(44,108,255,0.10);border-color: rgba(44,108,255,0.45);color: rgba(31,78,216,0.98);}
.chip.on .chipSub{color: rgba(31,78,216,0.78)}


.resultBig{font-size:72px;line-height:1;font-weight:980;letter-spacing:-0.05em;text-align:center;margin:4px 0}
.resultSub{text-align:center;color:var(--muted);font-weight:950}
.resultBar{height:14px;border-radius:999px;background:rgba(11,18,32,0.10);overflow:hidden;margin-top:14px}
.resultBar > div{height:100%;width:0%;background:linear-gradient(90deg,var(--blue),var(--alt));transition:width .22s ease}

.details{
  margin-top:14px;
  background: rgba(244,248,255,0.70);
  border:1px solid var(--line);
  border-radius:18px;
  padding:12px 12px;
  color:rgba(11,18,32,0.86);
  font-size:13px;
  line-height:1.45;
  white-space:pre-line;
}

/* modal */
.modalShade{position:fixed;inset:0;background:rgba(11,18,32,.35);display:none;z-index:80;align-items:flex-end;justify-content:center}
.modal{width:min(860px, 100%);background:#fff;border-radius:22px 22px 0 0;border:1px solid var(--line);box-shadow:var(--shadow2);padding:14px 14px 18px}
.modalH{font-size:14px;font-weight:980}
.modalClose{float:right;border:1px solid var(--line);background:#fff;border-radius:12px;padding:8px 10px;font-weight:980;cursor:pointer}
.small{font-size:12px;color:var(--muted);line-height:1.45;margin-top:8px}

/* touch */
button, .pill, .chip{touch-action:manipulation}


/* ===== v5.8: Resultat f√∏rst + sticky ===== */
.resultSticky{
  position: sticky;
  top: 70px; /* under topbar */
  z-index: 20;
  background: linear-gradient(180deg, rgba(244,248,255,0.96), rgba(244,248,255,0.80));
  border:1px solid var(--line);
  border-radius: 18px;
  padding: 12px 12px 14px;
  box-shadow: 0 18px 45px rgba(10,30,80,0.08);
  margin-top: 12px;
}
.resultSticky .progressWrap{margin-top:0}
.resultStickyMini{
  position: sticky;
  top: 70px;
  z-index: 20;
  background: linear-gradient(180deg, rgba(244,248,255,0.96), rgba(244,248,255,0.84));
  border:1px solid var(--line);
  border-radius: 18px;
  padding: 12px;
  box-shadow: 0 18px 45px rgba(10,30,80,0.08);
  margin-top: 12px;
}
.miniGrid{display:flex;align-items:center;justify-content:space-between;gap:12px}
.miniLeft{display:flex;flex-direction:column;gap:2px}
.miniNum{font-size:34px;font-weight:950;letter-spacing:-0.03em}
.miniLabel{font-size:12px;color:var(--muted);font-weight:900;text-transform:uppercase;letter-spacing:.02em}
.miniRight{display:flex;flex-direction:column;gap:4px;align-items:flex-end;text-align:right}
.miniDelta{font-size:13px;font-weight:950;color:rgba(30,64,175,0.95)}
.miniSmall{font-size:12px;color:var(--muted);line-height:1.25}
</style>
</head>
<body>
<div class="app">
<div class="top">
<div class="brand">
<div class="dot"></div>
<div style="min-width:0">
<div class="name">Tidsl√∏ft</div>
<div class="sub" id="buildTag">Sm√• valg. Store l√∏ft. ¬∑ <span id="verTag">v5.8.3</span> ¬∑ Seneste ¬∑ Testet</div>
</div>
</div>
<button class="btn" id="btnAssum" type="button">Foruds√¶tninger</button>
</div>
<!-- Landing -->
<div class="card hero" id="landingCard">
<div class="kicker">Muligheden</div>
<div class="h1">√ònsker du f√¶rre √•r p√• arbejdsmarkedet?</div>
<div class="p">P√• 90 sekunder ser du, hvad sm√• bel√∏b og sm√• valg kan betyde for din mulighed for at stoppe f√∏r folkepension.</div>
<div class="ctaRow">
<button class="cta" id="btnStart" type="button">Tag dit Tidsl√∏ft ‚Äì gratis</button>
</div>
<div class="hr"></div>
<div class="p" style="font-size:13px">Vi regner konservativt og kun frem til folkepension (bro-model). Eksisterende pensioner er ikke med.</div>
</div>
<!-- Step 1 -->
<div class="card hero hidden" id="step1">
<div class="stepTitle">Trin 1/4</div>
<div class="stepH">Din alder</div>
<div class="p">Start let. Du f√•r straks et estimat p√• folkepension.</div>
<div class="grid">
<div>
<div class="fieldLabel">Alder</div>
<input class="input" id="age" inputmode="numeric" max="100" min="15" placeholder="fx 35" type="number"/>
<div class="hint">Beregningen medregner ikke eksisterende pensionsordninger.</div>
</div>
<div class="card" style="box-shadow:none;border-radius:18px;border:1px solid var(--line);padding:14px;background:rgba(244,248,255,0.55)">
<div class="stepTitle">Folkepension (estimat)</div>
<div style="display:flex;align-items:baseline;gap:10px;margin-top:6px">
<div id="pensionAge" style="font-size:56px;font-weight:980;letter-spacing:-0.05em">‚Äî</div>
<div style="font-weight:950;color:var(--muted)">√•r</div>
</div>
<div class="hint">Tiden er din medspiller ‚Äì is√¶r n√•r du starter tidligt.</div>
</div>
</div>
<div class="ctaRow" style="margin-top:16px">
<button class="cta" id="btnToStep2" type="button">Forts√¶t</button>
<button class="ghost" id="btnDemo" type="button">Demo</button>
</div>
<div class="hint warn hidden" id="ageWarn">Indtast en alder mellem 15 og 100.</div>
</div>
<!-- Step 2 -->
<div class="card hero hidden" id="step2">
<div class="stepTitle">Trin 2/4</div>
<div class="stepH">Dine tal</div>
<div class="p">Intet er forudfyldt. Sm√• √¶ndringer kan give store forskelle over tid.</div>
<div class="grid">
<div>
<div class="fieldLabel">Opsparing i dag (kr.)</div>
<input class="input" id="savings" inputmode="numeric" placeholder="fx 15.000"/>
</div>
<div>
<div class="fieldLabel">M√•nedlig investering (kr./md)</div>
<input class="input" id="monthly" inputmode="numeric" placeholder="fx 3.000"/>
</div>
<div>
<div class="fieldLabel">√ònsket m√•nedlig indkomst f√∏r folkepension (kr./md)</div>
<input class="input" id="targetMonthly" inputmode="numeric" placeholder="fx 20.000"/>
<div class="hint">Kr√¶ves for at beregne stop-alder (bro-modellen).</div>
</div>
</div>
<div class="pills">
<button class="pill" id="exA" type="button">Eksempel: 15.000 + 3.000/md</button>
<button class="pill" id="exB" type="button">Nulstil tal</button>
</div>
<div class="ctaRow" style="margin-top:16px">
<button class="ghost" id="btnBack1" type="button">Tilbage</button>
<button class="cta" id="btnToStep3" type="button">Forts√¶t</button>
</div>
<div class="hint warn hidden" id="step2Warn">Indtast √∏nsket indkomst pr. m√•ned (kr./md) for at forts√¶tte.</div>
</div>
<!-- Step 3 -->
<div class="card hero hidden" id="step3">
<div class="stepTitle">Find flere √•r</div>
<div class="stepH">Mulige tidsl√∏ft</div>
<div class="p">V√¶lg flere. Vi l√¶gger dem sammen som ekstra m√•nedligt bel√∏b.</div><div class="resultStickyMini"><div class="miniGrid"><div class="miniLeft"><div class="miniNum" id="stopAgeMini">‚Äî</div><div class="miniLabel">stop-alder</div></div><div class="miniRight"><div class="miniDelta" id="deltaMini">‚Äî</div><div class="miniSmall">Opdateres live n√•r du v√¶lger mikrovalg.</div></div></div></div>
<div class="chips" id="chips"></div>
<div style="margin-top:12px">
<div class="fieldLabel">Eget mikrovalg (ekstra kr./md)</div>
<input class="input" id="microManual" inputmode="numeric" placeholder="fx 300"/>
<div class="hint">Samlet mikrovalg: <b id="microSum">0</b> kr./md</div>
<div class="hint">Tidsgevinst: <b id="microDeltaTotal">+0 dage</b></div>
</div>
<div class="ctaRow" style="margin-top:16px">
<button class="ghost" id="btnBack2" type="button">Tilbage til resultat</button>
<button class="cta" id="btnToStep4" type="button">Opdater resultat</button>
</div>
</div>
<!-- Step 4 -->
<div class="card hero hidden" id="step4">
<div class="stepTitle">Trin 4/4</div>
<div class="stepH">Resultat</div>
<div class="p">Fokus: hvorn√•r du muligvis kan stoppe f√∏r folkepension ‚Äì baseret p√• dine tal og mikrovalg.</div><div class="resultSticky"><div class="progressWrap"><div class="progressFill" id="prog"></div></div><div class="progressMeta">
<div>Din alder: <b id="ageOut">‚Äî</b></div>
<div>Folkepension: <b id="pensOut">‚Äî</b></div>
</div><div class="resultBig" id="stopAgeOut">‚Äî</div><div class="resultSub" id="stopSub">stop-alder (estimat)</div><div class="resultSub" id="deltaOut" style="margin-top:8px">‚Äî</div><div class="resultBar"><div id="barFill"></div></div></div>






<div class="hr"></div>
<button class="ghost" id="btnToggleDetails" style="width:100%" type="button">Se beregningsdetaljer</button>
<div class="details hidden" id="detailsBox">‚Äî</div>
<div class="ctaRow" style="margin-top:16px">


<button class="ghost" id="btnBack3" type="button">Tilbage</button>
<button class="ghost" id="btnRestart" type="button">Start forfra</button>
<button class="cta ctaHot" id="btnFindMore" type="button">Find flere √•r</button>
</div>

<div class="goalBox hidden" id="goalBox" style="margin-top:14px">
  <div class="hint" style="margin-bottom:8px"><b>Hvis du vil ramme et bestemt tal</b> ‚Äî tast √∏nsket stop-alder, s√• estimerer vi ca. ekstra kr./md.</div>
  <div class="grid2">
    <div class="field">
      <label for="goalAge">√ònsket stop-alder</label>
      <input id="goalAge" inputmode="numeric" placeholder="fx 62" />
    </div>
    <div class="field">
      <label>Estimat</label>
      <div class="pill" id="goalOut">‚Äî</div>
    </div>
  </div>
  <button class="ghost" id="btnGoalCalc" type="button" style="margin-top:10px;width:100%">Beregn ca. ekstra kr./md</button>
</div>

</div>
<div class="progressScroll" id="scrollBar" style="position:fixed;top:0;left:0;height:4px;width:0%;background:linear-gradient(90deg,var(--blue),var(--alt));z-index:9999;pointer-events:none"></div>
<!-- Assumptions modal -->
<div class="modalShade" id="assumModal">
<div class="modal">
<button class="modalClose" id="assumClose" type="button">Luk</button>
<div class="modalH">Foruds√¶tninger</div>
<div class="small" id="assumText">‚Äî</div>
<div class="small" style="margin-top:10px">
<label style="display:flex;gap:10px;align-items:flex-start">
<input id="persistOptIn" style="margin-top:3px" type="checkbox"/>
<span>Husk mine tal p√• denne enhed (localStorage). Du kan altid ‚ÄúStart forfra‚Äù.</span>
</label>
</div>
<div class="ctaRow" style="margin-top:12px">
<button class="ghost" id="btnReset" type="button">Start forfra (slet alt)</button>
</div>
</div>
</div>
</div>
<script>
"use strict";

/* ===== Version ===== */
  const APP_VERSION = "v5.8.3";
document.getElementById("verTag").textContent = APP_VERSION;

/* ===== Helpers ===== */
const $ = (id)=>document.getElementById(id);

function safeScrollTop(){
  try{
    window.scrollTo({top:0,left:0,behavior:"auto"});
  }catch(e){
    try{ window.scrollTo(0,0); }catch(_){}
  }
}

function show(id){
  ["landingCard","step1","step2","step3","step4"].forEach(x=>{
    const el=$(x); if(el) el.classList.add("hidden");
  });
  const el=$(id); if(el) el.classList.remove("hidden");
  safeScrollTop();
  updateScrollBar();
}

function parseDK(v){
  const s = String(v ?? "").trim().replace(/\./g,"").replace(/\s/g,"").replace(",",".");
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}
function fmtDKInt(n){
  n = Math.round(Number(n)||0);
  try{ return n.toLocaleString("da-DK"); }catch(e){ return String(n); }
}
function clamp(n,a,b){ n=Number(n)||0; return Math.min(b, Math.max(a,n)); }

/* ===== Model ===== */
const nowYear = 2026; // fast for consistency in prototype
function pensionAgeFromBirthYear(y){
  if (y < 1963) return 67;
  if (y < 1967) return 68;
  if (y < 1971) return 69;
  if (y < 1975) return 70;
  if (y < 1979) return 71;
  return 72;
}

const CHOICES = [
  {id:"c1", label:"‚òï Mindre caf√©-kaffe", monthly:200},
  {id:"c2", label:"üçî 1 mindre take-away", monthly:400},
  {id:"c3", label:"üì∫ Del streaming", monthly:150},
  {id:"c4", label:"üßæ Abonnement-scan", monthly:150},
  {id:"c5", label:"üõí 5% mindre forbrug", monthly:250},
  {id:"c6", label:"ü•ó Spar p√• madindk√∏b", monthly:500},
  {id:"c7", label:"üõçÔ∏è F√¶rre impulsk√∏b", monthly:400},
  {id:"c8", label:"üö≤ Transport-optimering", monthly:300},
];

const state = {
  age:null,
  pensionAge:null,
  savings:0,
  monthly:0,
  targetMonthly:0,

  // Microvalg: "valgt" er det brugeren leger med p√• mikro-siden.
  // "applied" er det, der faktisk indg√•r i beregningen p√• resultat-siden, indtil man trykker "Opdater resultat".
  microSelected:new Set(),
  microManualSelected:0,
  microApplied:0,
  microManualApplied:0,
  microAppliedChoiceIds:new Set(),

  r:0.04,          // real return during accumulation
  margin:0.10,     // safety margin on required capital
  persist:false,
  hasTriedMicro:false
};

function microAppliedSum(){ return (state.microApplied||0) + (state.microManualApplied||0); }

function microSelectedSum(){
  let s=0;
  state.microSelected.forEach(id=>{
    const c = CHOICES.find(x=>x.id===id);
    if(c) s += c.monthly;
  });
  s += (state.microManualSelected||0);
  return s;
}

// Backwards-compat: gamle kald i beregningerne bruger microSum()
function microSum(){ return microAppliedSum(); }

function computeStopAgeForMonthly(monthlyTotal){
  // wrapper der holder alle antagelser √©t sted
  return computeStopAgeCustom(monthlyTotal);
}

function capitalAtStop(stopAge){
  const t = Math.max(0, stopAge - state.age);
  const r = state.r;
  const annual = (state.monthly + microSum()) * 12;
  const fvSavings = state.savings * Math.pow(1+r, t);
  const fvContrib = (r===0) ? annual * t : annual * ((Math.pow(1+r,t)-1)/r);
  return fvSavings + fvContrib;
}


function capitalAtStopCustom(stopAge, microMonthly){
  const t = Math.max(0, stopAge - state.age);
  const r = state.r;
  const annual = (state.monthly + (microMonthly||0)) * 12;
  const fvSavings = state.savings * Math.pow(1+r, t);
  const fvContrib = (r===0) ? annual * t : annual * ((Math.pow(1+r,t)-1)/r);
  return fvSavings + fvContrib;
}

function computeStopAgeCustom(microMonthly){
  // same guards as computeStopAge()
  if(!(state.age>=15 && state.age<=100)) return null;
  if(!(state.pensionAge>=60 && state.pensionAge<=80)) return null;
  if(!(state.targetMonthly>0)) return null;

  const maxStop = state.pensionAge;
  let best = maxStop;

  for(let a = state.age; a <= maxStop; a += (1/12)){
    const cap = capitalAtStopCustom(a, microMonthly);
    const req = requiredCapitalForBridge(a);
    if(cap >= req){
      best = a;
      break;
    }
  }
  return best;
}

function requiredCapitalForBridge(stopAge){
  const yearsBridge = Math.max(0, state.pensionAge - stopAge);
  const need = state.targetMonthly * 12 * yearsBridge;
  return need * (1 + state.margin);
}

function computeStopAge(){
  // guards
  if(!(state.age>=15 && state.age<=100)) return null;
  if(!(state.pensionAge>=60 && state.pensionAge<=80)) return null;
  if(!(state.targetMonthly>0)) return null;

  const maxStop = state.pensionAge; // stop cannot be after pension for this model
  let best = maxStop;

  // Search earlier ages in 0.5 year increments, but return in months if under 1 year delta later
  for(let a = state.age; a <= maxStop; a += (1/12)){
    const cap = capitalAtStop(a);
    const req = requiredCapitalForBridge(a);
    if(cap >= req){
      best = a;
      break;
    }
  }
  return best;
}

function formatDeltaYears(years){
  // years is a positive number (earlier than pension).
  if(!(years > 0)) return "0 dage";
  const monthYears = 1/12;
  if(years < monthYears){
    const days = Math.max(1, Math.round(years * 365.25));
    return (days < 2) ? "1 dag" : (days + " dage");
  }
  if(years < 1){
    const m = Math.max(1, Math.round(years * 12));
    return (m < 2) ? "1 m√•ned" : (m + " m√•neder");
  }
  // 0.5 steps for years
  const y = Math.round(years*2)/2;
  return (y % 1 === 0 ? String(y.toFixed(0)) : String(y.toFixed(1)).replace(".", ",")) + " √•r";
}

/* ===== Persistence (opt-in) ===== */
const LS_KEY = "tidsloeft_state_v581";
function save(){
  if(!state.persist) return;
  try{
    const payload = {
      v:APP_VERSION,
      age:state.age,
      savings:state.savings,
      monthly:state.monthly,
      targetMonthly:state.targetMonthly,
      microApplied:state.microApplied,
      microManualApplied:state.microManualApplied,
      microAppliedChoiceIds:[...state.microAppliedChoiceIds],
      microSelected:[...state.microSelected],
      microManualSelected:state.microManualSelected,
      persist:true
    };
    localStorage.setItem(LS_KEY, JSON.stringify(payload));
  }catch(e){}
}
function load(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return;
    const p = JSON.parse(raw);

    state.age = p.age!=null ? Number(p.age) : null;
    state.pensionAge = p.pensionAge!=null ? Number(p.pensionAge) : null;
    state.savings = Math.max(0, parseDK(p.savings));
    state.monthly = Math.max(0, parseDK(p.monthly));
    state.targetMonthly = Math.max(0, parseDK(p.targetMonthly));

    state.r = (p.r!=null ? Number(p.r) : state.r);
    state.margin = (p.margin!=null ? Number(p.margin) : state.margin);

    state.persist = !!p.persist;
    state.hasTriedMicro = !!p.hasTriedMicro;
    $("persistOptIn").checked = state.persist;

    // Applied
    state.microApplied = Math.max(0, parseDK(p.microApplied));
    state.microManualApplied = Math.max(0, parseDK(p.microManualApplied));
    state.microAppliedChoiceIds = new Set(Array.isArray(p.microAppliedChoiceIds) ? p.microAppliedChoiceIds : (Array.isArray(p.microOn)? p.microOn: []));

    // Selected (starter som applied)
    state.microSelected = new Set(Array.from(state.microAppliedChoiceIds));
    state.microManualSelected = Math.max(0, parseDK(p.microManualSelected!=null ? p.microManualSelected : (p.microManual!=null ? p.microManual : state.microManualApplied)));

    $("microManual").value = state.microManualSelected ? fmtDKInt(state.microManualSelected) : "";
  }catch(e){}
}
function resetAll(){
  try{ localStorage.removeItem(LS_KEY); }catch(e){}
  state.age=null; state.pensionAge=null;
  state.savings=0; state.monthly=0; state.targetMonthly=0;

  state.microSelected = new Set();
  state.microManualSelected = 0;
  state.microApplied = 0;
  state.microManualApplied = 0;
  state.microAppliedChoiceIds = new Set();

  state.persist = false;
  $("persistOptIn").checked = false;
  $("microManual").value = "";
}

/* ===== UI binding ===== */
function setPensionPreview(){
  const a = parseInt($("age").value||"",10);
  if(!(a>=15 && a<=100)){
    $("pensionAge").textContent = "‚Äî";
    return;
  }
  const by = nowYear - a;
  const pa = pensionAgeFromBirthYear(by);
  $("pensionAge").textContent = String(pa);
}

function renderChips(){
  const list = $("chipList");
  list.innerHTML = "";

  const appliedSum = microAppliedSum();
  const selectedSum = microSelectedSum();
  const delta = selectedSum - appliedSum;

  const baseStop = computeStopAgeCustom(appliedSum);
  const newStop = computeStopAgeCustom(appliedSum + delta);

  // Sticky: vis √¶ndringen i tid (ikke ny alder)
  const diffYears = (baseStop - newStop);
  const diffDays = Math.round(diffYears * 365);
  $("deltaMini").textContent = fmtGain(diffDays, true); // fx +4 m√•neder / -10 dage
  $("stopAgeMini").textContent = "√Ündring";

  // helper: beregn marginal gevinst for et mikrovalg ift. APPLIED baseline
  function gainDaysForMonthly(addMonthly){
    const s = computeStopAgeCustom(appliedSum + addMonthly);
    return Math.round((baseStop - s) * 365);
  }

  CHOICES.forEach(c=>{
    const gainDays = gainDaysForMonthly(c.monthly);

    // B: skjul valg uden reel effekt (< 1 dag)
    if(gainDays < 1) return;

    const on = state.microSelected.has(c.id);

    const chip = document.createElement("button");
    chip.type = "button";
    chip.className = "chip" + (on ? " on" : "");
    chip.setAttribute("data-id", c.id);

    const left = document.createElement("div");
    left.className = "chipLeft";
    left.innerHTML = `<div class="chipTitle">${c.icon ? `<span class="chipIcon">${c.icon}</span>` : ""}${c.label}</div>`;

    const right = document.createElement("div");
    right.className = "chipRight";
    right.innerHTML = `<div class="chipGain">${fmtGain(gainDays,false)}</div><div class="chipAmt">${fmtDK(c.monthly)} kr./md</div>`;

    chip.appendChild(left);
    chip.appendChild(right);

    chip.addEventListener("click", ()=>{
      if(state.microSelected.has(c.id)) state.microSelected.delete(c.id);
      else state.microSelected.add(c.id);
      save();
      renderChips();
      renderMicroTotals();
    });

    list.appendChild(chip);
  });

  renderMicroTotals();
}

function fmtGain(days, signed){
  // days >= 0 (for single choice). For delta can be negative.
  const sgn = (signed && days !== 0) ? (days>0 ? "+" : "‚àí") : "+";
  const abs = Math.abs(days);

  if(abs >= 365){
    const months = Math.round(abs/30);
    const years = Math.floor(months/12);
    const remM = months - years*12;
    if(remM === 0) return `${sgn}${years} √•r tidligere`;
    return `${sgn}${years} √•r ${remM} mdr tidligere`;
  }
  if(abs >= 30){
    const m = Math.round(abs/30);
    return `${sgn}${m} m√•neder tidligere`;
  }
  return `${sgn}${abs} dage tidligere`;
}

function renderMicroTotals(){
  const appliedSum = microAppliedSum();
  const selectedSum = microSelectedSum();
  const delta = selectedSum - appliedSum;

  $("microSum").textContent = fmtDK(selectedSum);

  // vis tydeligt hvor meget der er lagt til siden sidste beregning
  const baseStop = computeStopAgeCustom(appliedSum);
  const newStop = computeStopAgeCustom(appliedSum + delta);
  const diffDays = Math.round((baseStop - newStop) * 365);
  $("microDeltaTotal").textContent = fmtGain(diffDays, true);
}




function bind(){
  // landing
  $("btnStart").addEventListener("click", ()=> show("step1"));

  // step1
  $("age").addEventListener("input", ()=>{
    setPensionPreview();
    $("ageWarn").classList.add("hidden");
  });
  $("btnDemo").addEventListener("click", ()=>{
    $("age").value = "46";
    setPensionPreview();
  });
  $("btnToStep2").addEventListener("click", ()=>{
    const a = parseInt($("age").value||"",10);
    if(!(a>=15 && a<=100)){
      $("ageWarn").classList.remove("hidden");
      return;
    }
    state.age = a;
    const by = nowYear - a;
    state.pensionAge = pensionAgeFromBirthYear(by);
    save();
    show("step2");
  });

  // step2
  $("btnBack1").addEventListener("click", ()=> show("step1"));
  $("exA").addEventListener("click", ()=>{
    $("savings").value = "15.000";
    $("monthly").value = "3.000";
  });
  $("exB").addEventListener("click", ()=>{
    $("savings").value = "";
    $("monthly").value = "";
    $("targetMonthly").value = "";
  });
  $("btnToStep3").addEventListener("click", ()=>{
    state.savings = Math.max(0, parseDK($("savings").value));
    state.monthly = Math.max(0, parseDK($("monthly").value));
    state.targetMonthly = Math.max(0, parseDK($("targetMonthly").value));

    if(!(state.targetMonthly>0)){
      $("step2Warn").classList.remove("hidden");
      return;
    }
    $("step2Warn").classList.add("hidden");

    // format fields
    $("savings").value = state.savings ? fmtDKInt(state.savings) : "";
    $("monthly").value = state.monthly ? fmtDKInt(state.monthly) : "";
    $("targetMonthly").value = fmtDKInt(state.targetMonthly);

    // baseline f√∏rst: nulstil mikrovalg (kan tilf√∏jes bagefter)
    state.microSelected = new Set(Array.isArray(p.microSelected)? p.microSelected: (Array.isArray(p.microOn)? p.microOn: []));
    
    const mm = $("microManual"); if(mm) mm.value = "";
    

    save();
    renderResult();       // vis resultat med baseline
    show("step4");
  });


  // step3
  $("microManual").addEventListener("input", ()=>{
    state.microManualSelected = Math.max(0, parseDK($("microManual").value));
    renderChips();
    
    save();
  });
  $("btnBack2").addEventListener("click", ()=> { renderResult(); show("step4"); });
  $("btnToStep4").addEventListener("click", ()=>{
    // APPLY: f√∏rst nu indg√•r mikrovalg i resultat-beregningen
    state.microAppliedChoiceIds = new Set([...state.microSelected]);
    state.microApplied = 0;
    state.microAppliedChoiceIds.forEach(id=>{
      const c = CHOICES.find(x=>x.id===id);
      if(c) state.microApplied += c.monthly;
    });

    state.microManualApplied = Math.max(0, state.microManualSelected||0);

    state.hasTriedMicro = true;

    // format input
    $("microManual").value = state.microManualSelected ? fmtDKInt(state.microManualSelected) : "";

    save();
    renderResult();
    show("step4");
    // scroll to top to show result immediately
    window.scrollTo(0,0);
  });


  // step4
  $("btnBack3").addEventListener("click", ()=> show("step2"));
  $("btnFindMore").addEventListener("click", ()=>{
    // g√• til mikrovalg og opdater resultat live
    renderChips();
    
    renderResult();
    show("step3");
  });
  $("btnRestart").addEventListener("click", ()=>{
    resetAll();
    // clear inputs
    ["age","savings","monthly","targetMonthly","microManual"].forEach(id=>{ const el=$(id); if(el) el.value=""; });
    $("pensionAge").textContent="‚Äî";
    $("detailsBox").classList.add("hidden");
    show("landingCard");
  });
  $("btnToggleDetails").addEventListener("click", ()=>{
    $("detailsBox").classList.toggle("hidden");
  });

  // assumptions modal
  $("btnAssum").addEventListener("click", ()=>{
    updateAssumText();
    $("assumModal").style.display = "flex";
  });
  $("assumClose").addEventListener("click", ()=> $("assumModal").style.display = "none");
  $("assumModal").addEventListener("click", (e)=>{
    if(e.target === $("assumModal")) $("assumModal").style.display = "none";
  });
  $("persistOptIn").addEventListener("change", ()=>{
    state.persist = $("persistOptIn").checked;
    save();
  });
  $("btnReset").addEventListener("click", ()=>{
    resetAll();
    ["age","savings","monthly","targetMonthly","microManual"].forEach(id=>{ const el=$(id); if(el) el.value=""; });
    $("pensionAge").textContent="‚Äî";
    $("assumModal").style.display = "none";
    show("landingCard");
  });

  // scroll progress
  window.addEventListener("scroll", updateScrollBar, {passive:true});
}

function updateAssumText(){
  const yearsLeft = (state.age!=null && state.pensionAge!=null) ? Math.max(0, state.pensionAge - state.age) : "‚Äî";
  const text =
`Version: ${APP_VERSION}
Model: Bro til folkepension (kapitalen d√¶kker kun perioden fra stop til folkepension)
Afkast (real): ${(state.r*100).toFixed(0)}%
Sikkerhedsmargin: ${(state.margin*100).toFixed(0)}%
Alder: ${state.age ?? "‚Äî"}
Folkepension (estimat): ${state.pensionAge ?? "‚Äî"}
√Ör til folkepension: ${yearsLeft}

Input:
Opsparing: ${fmtDKInt(state.savings)} kr.
M√•nedlig investering: ${fmtDKInt(state.monthly)} kr./md
M√•l (f√∏r folkepension): ${fmtDKInt(state.targetMonthly)} kr./md
Mikrovalg i alt: ${fmtDKInt(microSum())} kr./md

Note: Eksisterende pensionsordninger er ikke med i denne prototype.`;
  $("assumText").textContent = text;
}

function renderResult(){
  const stop = computeStopAge();
  $("ageOut").textContent = state.age ?? "‚Äî";
  $("pensOut").textContent = state.pensionAge ?? "‚Äî";

  const prog = $("prog");
  prog.style.width = "100%";

  if(stop == null){
    $("stopAgeOut").textContent = "‚Äî";
    $("deltaOut").textContent = "Indtast m√•l (kr./md) for at beregne.";
    const miniA = $("stopAgeMini"); if(miniA) miniA.textContent = "‚Äî";
    const miniD = $("deltaMini"); if(miniD) miniD.textContent = "‚Äî";
    $("barFill").style.width = "0%";
    $("detailsBox").textContent = "‚Äî";
    return;
  }

  const yearsEarlier = Math.max(0, state.pensionAge - stop);
  const stopTxt = (Math.round(stop*10)/10).toString().replace(".", ",");
  const deltaTxt = `${formatDeltaYears(yearsEarlier)} f√∏r folkepension (${state.pensionAge} √•r, estimat)`;
  $("stopAgeOut").textContent = stopTxt;
  $("deltaOut").textContent = deltaTxt;
  const miniA = $("stopAgeMini"); if(miniA) miniA.textContent = stopTxt;
  const miniD = $("deltaMini"); if(miniD) miniD.textContent = deltaTxt;

  // bar fill = share of bridge covered (0..1)
  const cap = capitalAtStop(stop);
  const req = requiredCapitalForBridge(stop);
  const ratio = req>0 ? Math.min(1, cap/req) : 0;
  $("barFill").style.width = Math.round(ratio*100) + "%";

  const gb = $("goalBox");
  if(gb) gb.classList.toggle("hidden", !state.hasTriedMicro);


  const details =
`Folkepension: ${state.pensionAge} √•r
Stop-alder (estimat): ${stop.toFixed(1).replace(".", ",")} √•r
Bro-periode: ${(state.pensionAge - stop).toFixed(1).replace(".", ",")} √•r

Kapital ved stop: ${fmtDKInt(cap)} kr.
M√•lkapital for bro: ${fmtDKInt(req)} kr. (inkl. ${(state.margin*100).toFixed(0)}% margin)

Opsparing: ${fmtDKInt(state.savings)} kr.
M√•nedlig indbetaling: ${fmtDKInt(state.monthly)} kr./md
Mikrovalg i alt: ${fmtDKInt(microSum())} kr./md
Afkast (real): ${(state.r*100).toFixed(0)}%

Bem√¶rk: Dette er en konservativ, forsimplet prototype (ingen skat, ingen pensioner, ingen inflation udover real-afkast).`;
  $("detailsBox").textContent = details;
}

/* ===== Scroll bar ===== */
function updateScrollBar(){
  const doc = document.documentElement;
  const max = Math.max(1, doc.scrollHeight - doc.clientHeight);
  const pct = (window.scrollY / max) * 100;
  $("scrollBar").style.width = Math.min(100, Math.max(0, pct)) + "%";
}

/* ===== Init ===== */
load();
bind();

if(state.age!=null){
  $("age").value = String(state.age);
  setPensionPreview();
  $("savings").value = state.savings ? fmtDKInt(state.savings) : "";
  $("monthly").value = state.monthly ? fmtDKInt(state.monthly) : "";
  $("targetMonthly").value = state.targetMonthly ? fmtDKInt(state.targetMonthly) : "";
}
$("microManual").value = state.microManualSelected ? fmtDKInt(state.microManualSelected) : "";

renderResult();
renderChips();

show("landingCard");

$("btnGoalCalc")?.addEventListener("click", ()=>{
  if(!state.hasTriedMicro) return;

  const desired = Math.max(0, parseInt(String($("goalAge").value||"").replace(/\D/g,""),10) || 0);
  if(!desired){ $("goalOut").textContent = "Indtast en alder"; return; }

  const appliedSum = microAppliedSum();
  const baseStop = computeStopAgeCustom(appliedSum);

  if(baseStop <= desired){
    $("goalOut").textContent = "0 kr./md ekstra (du er allerede der)";
    return;
  }

  let lo = 0, hi = 200000;
  for(let i=0;i<28;i++){
    const mid = Math.floor((lo+hi)/2);
    const s = computeStopAgeCustom(appliedSum + mid);
    if(s <= desired) hi = mid;
    else lo = mid + 1;
  }
  $("goalOut").textContent = fmtDK(hi) + " kr./md ekstra (ca.)";
});

</script>
</body>
</html>
