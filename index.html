<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Tidsl√∏ft ¬∑ v7.0.0 (demo)</title>
<style>
:root{
  --bg1:#f4f8ff; --bg2:#e9f1ff; --card:#ffffff;
  --text:#0b1220; --muted:#566b85; --line:#e6edf7;
  --blue:#3b82f6; --blue2:#1e40af; --teal:#06b6d4;
  --shadow2:0 18px 45px rgba(10,30,70,.10);
  --shadow:0 26px 70px rgba(10,30,70,.14);
  --radius:26px;
}
*{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
html,body{height:100%;}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  color:var(--text);
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
}
.app{max-width:860px;margin:0 auto;padding:18px 14px 30px;}
.header{
  position:sticky; top:0; z-index:60;
  padding:10px 12px 12px;
  backdrop-filter: blur(10px);
  background:linear-gradient(180deg, rgba(244,248,255,.92), rgba(244,248,255,.60));
  border-bottom:1px solid rgba(230,237,247,.6);
  border-radius:18px;
}
.toprow{display:flex; align-items:center; justify-content:space-between; gap:12px;}
.brand{display:flex; align-items:flex-start; gap:10px; min-width:0;}
.dot{width:12px;height:12px;border-radius:50%;background:var(--teal);margin-top:6px; flex:0 0 auto;}
.brand h1{margin:0;font-size:20px;letter-spacing:.2px; line-height:1.1;}
.brand .sub{margin:2px 0 0;color:var(--muted);font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
.pillbtn{
  border:1px solid var(--line); background:rgba(255,255,255,.85);
  padding:10px 14px; border-radius:999px; font-weight:900; color:var(--text);
}
.progressWrap{margin-top:10px;}
.progressBar{height:8px;border-radius:999px;background:rgba(230,237,247,.9); overflow:hidden;}
.progressFill{height:100%; width:0%; background:linear-gradient(90deg,var(--blue),var(--teal)); border-radius:999px; transition:width .25s ease;}

.card{
  background:var(--card);
  border:1px solid rgba(230,237,247,.9);
  border-radius:var(--radius);
  box-shadow:var(--shadow2);
}
.hero{padding:22px 20px; margin-top:14px;}
.kicker{letter-spacing:.16em; font-weight:1000; font-size:12px; color:var(--muted);}
.huge{margin:10px 0 10px;font-size:44px;line-height:1.0;letter-spacing:-.03em;}
.p{margin:0;color:var(--muted);font-size:18px;line-height:1.45;}
.small{font-size:13px;color:var(--muted); line-height:1.35;}
.mono{font-variant-numeric: tabular-nums;}

.cta{
  width:100%; border:0; cursor:pointer;
  padding:16px 18px;
  border-radius:999px;
  font-size:16px; font-weight:1100; color:#fff;
  background:linear-gradient(90deg,var(--blue),var(--blue2));
  box-shadow: 0 14px 28px rgba(30,64,175,.25);
  touch-action: manipulation;
  position:relative;
}
.cta:active{transform:translateY(1px);}
.cta.pulse::after{
  content:"";
  position:absolute; inset:-2px;
  border-radius:999px;
  border:2px solid rgba(59,130,246,.22);
  opacity:0;
  animation: pulseRing 6s infinite;
}
@keyframes pulseRing{
  0%{transform:scale(1); opacity:0;}
  8%{transform:scale(1.04); opacity:.55;}
  16%{transform:scale(1.09); opacity:0;}
  100%{transform:scale(1.09); opacity:0;}
}

.section{display:none; opacity:0; transform:translateY(6px);}
.section.active{display:block; animation:fadeUp .26s ease forwards;}
@keyframes fadeUp{
  from{opacity:0; transform:translateY(6px);}
  to{opacity:1; transform:translateY(0);}
}

.stepTitle{font-size:38px; margin:4px 0 6px; letter-spacing:-.02em;}
.stepMeta{color:var(--muted); margin:0 0 14px; font-size:16px; line-height:1.35;}
.formCard{padding:18px 16px; margin-top:14px;}
.label{font-weight:1000; color:var(--muted); margin:14px 2px 8px;}
.input{
  width:100%; font-size:34px; font-weight:1100; letter-spacing:.5px;
  padding:18px 16px; border-radius:20px;
  border:1px solid rgba(230,237,247,.9); outline:none;
  background:rgba(255,255,255,.9);
}
.input.smallInput{font-size:18px; font-weight:900; padding:14px 14px; border-radius:16px;}
.input:focus{border-color:rgba(59,130,246,.55); box-shadow:0 0 0 4px rgba(59,130,246,.12);}

.btnRow{display:flex; gap:12px; margin-top:16px;}
.btn{
  flex:1; border:1px solid var(--line); background:rgba(255,255,255,.85);
  padding:14px 14px; border-radius:18px;
  font-weight:1100; font-size:16px;
  cursor:pointer; touch-action: manipulation;
}
.btn.primary{border:0; color:#fff; background:linear-gradient(90deg,var(--blue),var(--blue2));}
.btn.ghost{background:rgba(255,255,255,.75);}
.btn.link{border:0; background:transparent; color:var(--muted); font-weight:1100; padding:8px 4px;}
.hr{height:1px;background:rgba(230,237,247,.9); margin:14px 0;}
.err{display:none; margin-top:10px; padding:10px 12px; border-radius:16px; background:rgba(180,35,24,.08); border:1px solid rgba(180,35,24,.22); color:#7a1c12; font-weight:1000;}
.err.show{display:block;}

.resultWrap{padding:16px 14px; margin-top:14px;}
.bigNum{font-size:78px; font-weight:1250; letter-spacing:-.05em; margin:4px 0 0; text-align:center;}
.bigNum.bump{animation:bump .22s ease;}
@keyframes bump{from{transform:scale(.985);} to{transform:scale(1);}}
.center{text-align:center;}
.subStrong{font-size:22px; font-weight:1150; margin:2px 0 6px;}
.resultPill{
  display:flex; justify-content:space-between; gap:10px;
  padding:10px 12px; border-radius:18px;
  background:rgba(59,130,246,.08); border:1px solid rgba(59,130,246,.20);
  font-weight:1100;
}
.resultPill span{color:var(--muted); font-weight:1000;}
.details{display:none; margin-top:12px;}
.details.open{display:block;}

.ctaCard{ margin-top:14px; padding:14px 14px; }
.ctaBtn{
  width:100%;
  display:flex; justify-content:space-between; align-items:center; gap:10px;
  border:0;
  background:linear-gradient(90deg,var(--blue),var(--blue2));
  padding:16px 16px;
  border-radius:20px;
  font-weight:1200;
  cursor:pointer;
  color:#fff;
  box-shadow: 0 14px 28px rgba(30,64,175,.22);
}
.ctaBtn .mut{opacity:.9; font-weight:1000;}
.ctaBtn:active{transform:translateY(1px);}

.secondaryCardBtn{
  width:100%;
  display:flex; justify-content:space-between; align-items:center; gap:10px;
  border:1px solid rgba(59,130,246,.22);
  background:rgba(59,130,246,.06);
  padding:14px 14px;
  border-radius:18px;
  font-weight:1200;
  cursor:pointer;
}
.secondaryCardBtn span{color:var(--muted); font-weight:1000;}

.microSticky{
  position:sticky; top:88px; z-index:40;
  margin-top:12px; padding:12px 12px;
  background:rgba(255,255,255,.92);
  border:1px solid rgba(230,237,247,.9);
  border-radius:22px;
  box-shadow: var(--shadow2);
}
.microSticky .line1{display:flex; justify-content:space-between; gap:10px; align-items:center;}
.microSticky .ttl{font-weight:1200; letter-spacing:-.01em;}
.microSticky .gain{font-weight:1200; color:var(--blue2);}
.microList{margin-top:12px; display:flex; flex-direction:column; gap:12px;}
.microItem{
  display:flex; justify-content:space-between; gap:12px; align-items:flex-start;
  padding:14px 14px; border-radius:22px;
  border:1px solid rgba(230,237,247,.9);
  background:rgba(255,255,255,.88);
  cursor:pointer;
  touch-action: manipulation;
  transition: transform .16s ease, background .16s ease, border-color .16s ease;
}
.microItem:hover{transform:translateY(-1px);}
.microItem.selected{border-color:rgba(59,130,246,.55); background:rgba(59,130,246,.08); transform:translateY(-2px);}
.microLeft{display:flex; gap:12px; align-items:flex-start; min-width:0;}
.emoji{font-size:22px; width:28px; text-align:center; margin-top:2px;}
.microName{font-weight:1200; font-size:18px; white-space:normal; line-height:1.15;}
.microRight{text-align:right;}
.microGain{font-weight:1200; color:var(--blue2); line-height:1.05;}
.microCost{font-weight:1100; color:var(--muted);}

.sliderRow{display:flex; align-items:center; gap:12px; margin-top:10px;}
.sliderRow input[type="range"]{width:100%;}
.rcBig{font-size:42px; font-weight:1200; letter-spacing:-.03em; margin:8px 0 0;}
.rcLine{display:flex; justify-content:space-between; gap:10px; align-items:baseline; margin-top:10px;}
.rcLine .lbl{color:var(--muted); font-weight:1100;}
.rcLine .val{font-weight:1200;}
.rcHint{margin-top:10px; font-size:12px; color:var(--muted); line-height:1.35;}

.modalBack{
  position:fixed; inset:0; background:rgba(10,18,32,.40);
  display:none; align-items:flex-end; justify-content:center;
  z-index:200;
}
.modalBack.open{display:flex;}
.modal{
  width:min(860px, 100%);
  border-radius:22px 22px 0 0;
  background:#fff;
  border:1px solid rgba(230,237,247,.9);
  padding:16px 16px 22px;
  box-shadow: var(--shadow);
  animation: slideUp .18s ease;
}
@keyframes slideUp{from{transform:translateY(12px); opacity:.7;} to{transform:translateY(0); opacity:1;}}
.modal h3{margin:0 0 8px; font-size:18px;}
.modal ul{margin:8px 0 0; padding-left:18px; color:var(--muted); line-height:1.45;}
.modal .closeRow{display:flex; justify-content:flex-end; margin-top:14px;}

#fatalBanner{
  display:none;
  position:fixed; inset:0;
  background:rgba(10,18,32,.78);
  z-index:999;
  padding:18px;
}
#fatalBanner .inner{
  max-width:860px; margin:12vh auto 0;
  background:#fff; border-radius:18px; border:1px solid rgba(230,237,247,.9);
  padding:14px 14px;
  box-shadow:0 26px 70px rgba(10,30,70,.22);
}
#fatalBanner h2{margin:0 0 8px; font-size:18px;}
#fatalBanner pre{white-space:pre-wrap; word-break:break-word; color:var(--muted); margin:0; font-size:12px; line-height:1.35;}

.badge{
  display:inline-flex; align-items:center; gap:8px;
  font-size:12px; font-weight:1100;
  padding:6px 10px; border-radius:999px;
  border:1px solid rgba(59,130,246,.22);
  background:rgba(59,130,246,.06);
  color:var(--muted);
}

.checkRow{display:flex; gap:10px; align-items:flex-start; margin-top:12px;}
.checkRow input{margin-top:4px;}
.previewBox{
  margin-top:10px; padding:12px 12px;
  border-radius:16px; border:1px solid rgba(230,237,247,.9);
  background:rgba(244,248,255,.60);
  color:var(--muted);
  font-size:12px; line-height:1.4;
  white-space:pre-wrap;
  word-break:break-word;
}
</style>
</head>
<body>
<div id="fatalBanner"><div class="inner">
  <h2>Teknisk fejl</h2>
  <pre id="fatalText">‚Äî</pre>
</div></div>

<div class="app">
  <div class="header">
    <div class="toprow">
      <div class="brand">
        <div class="dot" aria-hidden="true"></div>
        <div style="min-width:0">
          <h1>Tidsl√∏ft</h1>
          <div class="sub">Sm√• valg. Store l√∏ft. ¬∑ <span class="mono">v7.0.0</span> ¬∑ <span class="badge">DEMO</span></div>
        </div>
      </div>
      <button class="pillbtn" id="assumBtn" type="button">Foruds√¶tninger</button>
    </div>
    <div class="progressWrap">
      <div class="progressBar" aria-hidden="true"><div class="progressFill" id="progressFill"></div></div>
    </div>
  </div>

  <section class="section active" id="s_intro">
    <div class="card hero">
      <div class="kicker">MULIGHEDEN</div>
      <div class="huge">√ònsker du f√¶rre<br/>√•r p√• arbejdsmarkedet?</div>
      <p class="p">Se dit frihedspotentiale ‚Äì baseret p√• dine egne tal. Sm√• justeringer kan flytte mere, end man tror.</p>
      <div style="height:16px"></div>
      <button class="cta pulse" id="startBtn" type="button">Tag dit Tidsl√∏ft ‚Äì gratis</button>
      <div class="hr"></div>
      <div class="small">Vi regner forsigtigt for at give et robust estimat. Eksisterende pensioner og skat er ikke med (det kan i praksis forbedre billedet).</div>
    </div>
  </section>

  <section class="section" id="s_age">
    <div class="card formCard">
      <div class="kicker">TRIN 1/5</div>
      <div class="stepTitle">Din alder</div>
      <p class="stepMeta">Vi estimerer din folkepensionsalder ud fra din alder.</p>

      <div class="label">Alder</div>
      <input class="input" id="ageInput" inputmode="numeric" pattern="[0-9]*" placeholder="fx 46"/>

      <div class="card" style="margin-top:14px; padding:14px 14px;">
        <div class="kicker">FOLKEPENSION (ESTIMAT)</div>
        <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px;">
          <div style="font-size:64px; font-weight:1200; letter-spacing:-.04em;" class="mono" id="pensionAgeBig">‚Äî</div>
          <div class="small" style="text-align:right;">√•r</div>
        </div>
      </div>

      <div class="err" id="errAge">Indtast en gyldig alder (18‚Äì80).</div>

      <div class="btnRow">
        <button class="btn primary" id="ageNextBtn" type="button">Forts√¶t</button>
        <button class="btn ghost" id="demoBtn" type="button">Demo</button>
      </div>
    </div>
  </section>

  <section class="section" id="s_numbers">
    <div class="card formCard">
      <div class="kicker">TRIN 2/5</div>
      <div class="stepTitle">Dine tal</div>
      <p class="stepMeta">Felterne har kun forslag (ikke forudfyldte v√¶rdier). Sm√• bel√∏b kan v√¶re nok til at flytte din frihed.</p>

      <div class="label">Opsparing i dag (kr.)</div>
      <input class="input" id="savingsInput" inputmode="numeric" placeholder="fx 25.000"/>

      <div class="label">M√•nedlig investering (kr./md)</div>
      <input class="input" id="monthlyInput" inputmode="numeric" placeholder="fx 3.500"/>

      <div class="label">√ònsket m√•nedlig indkomst f√∏r folkepension (kr./md)</div>
      <input class="input" id="incomeInput" inputmode="numeric" placeholder="fx 35.000"/>
      <div class="small" style="margin-top:8px;">Angiv brutto-bel√∏b. Vi regner uden skat for gennemsigtighed.</div>

      <div class="err" id="errNums">Udfyld felterne med tal. Indkomst skal v√¶re &gt; 0.</div>

      <div class="btnRow">
        <button class="btn" id="numsBackBtn" type="button">Tilbage</button>
        <button class="btn primary" id="numsNextBtn" type="button">Se mit potentiale</button>
      </div>
      <div class="btnRow" style="margin-top:10px;">
        <button class="btn ghost" id="resetNumsBtn" type="button">Nulstil tal</button>
      </div>
    </div>
  </section>

  <section class="section" id="s_result">
    <div class="card resultWrap">
      <div class="kicker">TRIN 3/5</div>
      <div class="stepTitle">Dit potentiale</div>
      <p class="stepMeta" id="resultMeta">Baseret p√• dine tal lige nu.</p>

      <div class="card" style="padding:14px 14px;">
        <div class="resultPill">
          <div>Din alder: <span class="mono" id="curAgeLbl">‚Äî</span></div>
          <div>Folkepension: <span class="mono" id="pensionAgeLbl">‚Äî</span></div>
        </div>

        <div style="height:12px"></div>
        <div class="bigNum mono" id="stopAgeBig">‚Äî</div>
        <div class="center">
          <div class="subStrong">din mulige stop-alder</div>
          <div class="p" style="margin-top:0;" id="gapText">‚Äî</div>
        </div>

        <div class="card ctaCard">
          <button class="ctaBtn" id="toMicroBtn" type="button">
            <div>Forbedr mit potentiale<br/><span class="mut">Sm√• justeringer kan give ekstra frihed</span></div>
            <div class="mono">‚ñ∏</div>
          </button>
        </div>

        <div class="card ctaCard" id="toRealityCard" style="display:none;">
          <button class="secondaryCardBtn" id="toRealityBtn" type="button">
            <div>Vil du endnu l√¶ngere? <span>Se hvad der skal til</span></div>
            <div class="mono">‚ñ∏</div>
          </button>
        </div>

        <div style="height:12px"></div>
        <button class="btn" id="toggleDetailsBtn" type="button">Se beregningsgrundlag</button>
        <div class="details" id="detailsBox">
          <div class="card" style="margin-top:12px; padding:14px 14px;">
            <div class="small mono" id="detailsText">‚Äî</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="btnRow">
          <button class="btn" id="resBackBtn" type="button">Tilbage</button>
          <button class="btn link" id="startOverBtn" type="button">Start forfra</button>
        </div>
      </div>
    </div>
  </section>

  <section class="section" id="s_micro">
    <div class="card formCard">
      <div class="kicker">TRIN 4/5</div>
      <div class="stepTitle">Sm√• frihedsl√∏ft</div>
      <p class="stepMeta">V√¶lg flere. Vi l√¶gger dem sammen som ekstra m√•nedligt bel√∏b, der kan styrke din frihed.</p>

      <div class="microSticky">
        <div class="line1">
          <div class="ttl">Samlet frihedsl√∏ft</div>
          <div class="gain mono" id="totalGainLbl">‚Äî</div>
        </div>
        <div class="small" style="margin-top:6px;">
          Vi viser kun l√∏ft, der giver mindst <strong>1 m√•ned</strong> effekt (beregnet p√• dine tal f√∏r du v√¶lger).
        </div>
      </div>

      <div class="microList" id="microList"></div>

      <div class="label">Eget frihedsl√∏ft (ekstra kr./md)</div>
      <input class="input" id="customMicroInput" inputmode="numeric" placeholder="fx 300"/>
      <div class="small" id="customNote" style="margin-top:8px;">Tilf√∏jes, hvis det giver mindst 1 m√•ned effekt (baseline).</div>

      <div class="err" id="errMicro">Der er ikke nok data til at beregne effekten. G√• tilbage og udfyld dine tal.</div>

      <div class="btnRow">
        <button class="btn" id="microBackBtn" type="button">Tilbage</button>
        <button class="btn primary" id="microDoneBtn" type="button">Se mit nye potentiale</button>
      </div>
    </div>
  </section>

  <section class="section" id="s_reality">
    <div class="card formCard">
      <div class="kicker">TRIN 5/5</div>
      <div class="stepTitle">Hvor meget tidligere vil du?</div>
      <p class="stepMeta">V√¶lg dit m√•l. Vi viser det ekstra l√∏ft, der kan bringe dig derhen (samme foruds√¶tninger som f√∏r).</p>

      <div class="sliderRow">
        <input id="earlierSlider" type="range" min="0" max="0" step="0.5" value="0" />
        <div class="mono" style="min-width:86px; text-align:right; font-weight:1200;" id="earlierLbl">0 √•r</div>
      </div>

      <div class="rcBig mono" id="targetAgeLbl">‚Äî</div>
      <div class="small" id="targetMeta">‚Äî</div>

      <div class="hr"></div>

      <div class="rcLine">
        <div class="lbl">Ekstra l√∏ft pr. m√•ned</div>
        <div class="val mono" id="needMonthlyLbl">‚Äî</div>
      </div>
      <div class="rcLine">
        <div class="lbl">Alternativ: ekstra startkapital</div>
        <div class="val mono" id="needLumpLbl">‚Äî</div>
      </div>

      <!-- Lead CTA (only shown when relevant + after microApplied) -->
      <div class="card ctaCard" id="leadCard" style="display:none;">
        <button class="ctaBtn" id="openLeadBtn" type="button">
          <div>F√• sparring p√• din plan<br/><span class="mut">Vi formidler kontakt til en r√•dgiver (kun hvis du √∏nsker det)</span></div>
          <div class="mono">‚ñ∏</div>
        </button>
        <div class="small" style="margin-top:10px;">
          Frivilligt. Du ser pr√¶cis hvilke data der deles, f√∏r afsendelse. Demo-mode sender ikke noget eksternt.
        </div>
      </div>

      <div class="rcHint">Modelen er en forenklet ‚Äúbro-model‚Äù frem til folkepension: 4% real f√∏r stop ¬∑ 2% real i overgang ¬∑ 10% buffer. Skat og eksisterende pensioner indg√•r ikke.</div>

      <div class="btnRow">
        <button class="btn" id="realityBackBtn" type="button">Tilbage</button>
      </div>
    </div>
  </section>

</div>

<!-- Assumptions modal -->
<div class="modalBack" id="modalBack" role="dialog" aria-modal="true" aria-label="Foruds√¶tninger">
  <div class="modal">
    <h3>Foruds√¶tninger</h3>
    <ul>
      <li><strong>Folkepensionsalder</strong>: Estimat ud fra din alder (kan afvige op til ca. 1 √•r pga. f√∏dselsdato). Vi bruger vedtaget folkepensionsalder og regner ikke med forh√∏jelser over senest vedtagne niveau (maks. 70 √•r for 1971+).</li>
      <li><strong>Opsparing f√∏r stop</strong>: 4% real √•rligt.</li>
      <li><strong>Overgang (stop ‚Üí folkepension)</strong>: 2% real diskontering + 10% buffer.</li>
      <li><strong>Skat og eksisterende pensioner</strong>: Ikke med i modellen (kan i praksis √¶ndre/forbedre billedet).</li>
    </ul>
    <div class="closeRow">
      <button class="btn primary" id="closeModalBtn" type="button">Luk</button>
    </div>
  </div>
</div>

<!-- Lead modal -->
<div class="modalBack" id="leadBack" role="dialog" aria-modal="true" aria-label="Formidl kontakt">
  <div class="modal">
    <h3>Formidl kontakt til r√•dgiver</h3>
    <div class="small">Du bliver kun kontaktet, hvis du giver samtykke og sender formularen.</div>

    <div class="hr"></div>

    <div id="leadStepA">
      <div class="kicker">KONTAKT</div>

      <div class="label">Navn</div>
      <input class="input smallInput" id="leadName" autocomplete="name" placeholder="Dit navn"/>

      <div class="label">E-mail</div>
      <input class="input smallInput" id="leadEmail" inputmode="email" autocomplete="email" placeholder="navn@eksempel.dk"/>

      <div class="label">Telefon</div>
      <input class="input smallInput" id="leadPhone" inputmode="tel" autocomplete="tel" placeholder="+45 ‚Ä¶"/>

      <div class="checkRow">
        <input type="checkbox" id="leadConsent"/>
        <label for="leadConsent" class="small">
          Jeg √∏nsker at blive kontaktet af en r√•dgiver vedr√∏rende mine beregninger. Oplysninger bruges kun til dette form√•l.
        </label>
      </div>

      <div class="err" id="leadErrA">Udfyld navn, e-mail og telefon, og giv samtykke.</div>

      <div class="btnRow">
        <button class="btn" id="closeLeadBtn" type="button">Annull√©r</button>
        <button class="btn primary" id="leadNextBtn" type="button">Forts√¶t</button>
      </div>

      <div style="margin-top:10px;">
        <button class="btn link" id="privacyBtn" type="button">Privatliv og samtykke</button>
      </div>
    </div>

    <div id="leadStepB" style="display:none;">
      <div class="kicker">DELING</div>

      <div class="checkRow">
        <input type="checkbox" id="shareScenario" checked/>
        <label for="shareScenario" class="small">
          Del mine beregninger med r√•dgiver (anbefalet). Det sparer tid og giver et bedre svar.
        </label>
      </div>

      <div class="small" style="margin-top:10px;">Hvis du deler, sendes f√∏lgende:</div>
      <div class="previewBox" id="scenarioPreview">‚Äî</div>

      <div class="err" id="leadErrB">Der opstod en teknisk fejl. Pr√∏v igen.</div>

      <div class="btnRow">
        <button class="btn" id="leadBackBtn" type="button">Tilbage</button>
        <button class="btn primary" id="leadSubmitBtn" type="button">Send</button>
      </div>

      <div style="margin-top:10px;">
        <button class="btn link" id="privacyBtn2" type="button">Privatliv og samtykke</button>
      </div>
    </div>

    <div id="leadThanks" style="display:none;">
      <div class="kicker">KVITTERING</div>
      <div style="margin-top:10px; font-weight:1100;">Tak. Din foresp√∏rgsel er registreret.</div>
      <div class="small" style="margin-top:8px;">
        Demo-mode: Ingen data er sendt eksternt endnu. Payload kan ses herunder.
      </div>
      <div class="previewBox" id="leadPayloadPreview">‚Äî</div>

      <div class="btnRow">
        <button class="btn primary" id="leadDoneBtn" type="button">Luk</button>
      </div>
    </div>

  </div>
</div>

<!-- Privacy modal -->
<div class="modalBack" id="privacyBack" role="dialog" aria-modal="true" aria-label="Privatliv">
  <div class="modal">
    <h3>Privatliv og samtykke</h3>
    <ul>
      <li><strong>Form√•l</strong>: At formidle kontakt til en r√•dgiver efter dit √∏nske.</li>
      <li><strong>Retsgrundlag</strong>: Samtykke (du v√¶lger aktivt at sende).</li>
      <li><strong>Data</strong>: Kontaktoplysninger + (valgfrit) beregningsresum√©, pr√¶cist vist f√∏r afsendelse.</li>
      <li><strong>Deling</strong>: Oplysninger videregives kun, hvis du sender formularen.</li>
      <li><strong>Opbevaring</strong>: I demo-mode gemmes payload lokalt i din browser til test (localStorage). I produktion erstattes dette af et endpoint/CRM med defineret retention.</li>
      <li><strong>Dine rettigheder</strong>: Du kan til enhver tid undlade at sende eller stoppe processen.</li>
    </ul>
    <div class="closeRow">
      <button class="btn primary" id="closePrivacyBtn" type="button">Luk</button>
    </div>
  </div>
</div>

<script>
(() => {
  "use strict";

  // -------- Demo/Integration config --------
  const LEAD_ENDPOINT = null; // inds√¶t URL senere (serverless endpoint)

  // ---------- Utilities ----------
  const fmtDK = (n)=> {
    if (!Number.isFinite(n)) return "‚Äî";
    const s = Math.round(n).toString();
    return s.replace(/\B(?=(\d{3})+(?!\d))/g,'.');
  };
  const parseDK = (s)=>{
    if (s === null || s === undefined) return NaN;
    const raw = String(s).trim();
    if (raw === "") return NaN;
    const cleaned = raw.replace(/\./g,'').replace(/\s/g,'').replace(/,/g,'.');
    const v = Number(cleaned);
    return Number.isFinite(v) ? v : NaN;
  };
  const fatal = (msg, err)=>{
    const banner = document.getElementById("fatalBanner");
    const t = document.getElementById("fatalText");
    if (banner && t){
      t.textContent = msg + (err ? ("\n\n" + String(err && err.stack ? err.stack : err)) : "");
      banner.style.display = "block";
    } else {
      alert(msg);
    }
  };
  const el = (id)=>{
    const x = document.getElementById(id);
    if (!x) throw new Error("Mangler element #" + id);
    return x;
  };
  const on = (node, evt, fn)=> node.addEventListener(evt, (e)=>{ e.preventDefault?.(); fn(e); }, {passive:false});
  const isoNow = ()=> new Date().toISOString();

  // Count-up for integers / 0.5 steps
  function animateNumber(node, from, to, fmtFn, ms=260){
    if (!node) return;
    if (!Number.isFinite(from)) from = to;
    if (!Number.isFinite(to)) to = from;
    const start = performance.now();
    const tick = (t)=>{
      const p = Math.min(1, (t-start)/ms);
      const v = from + (to-from)*p;
      node.textContent = fmtFn(v);
      if (p < 1) requestAnimationFrame(tick);
    };
    requestAnimationFrame(tick);
  }

  // ---------- Model ----------
  function pensionAgeByBirthYearApprox(birthYear){
    if (birthYear <= 1962) return 67;
    if (birthYear <= 1966) return 68;
    if (birthYear <= 1970) return 69;
    return 70;
  }
  function estimatePensionAgeFromAge(currentAge){
    const y = new Date().getFullYear();
    const by1 = y - currentAge;
    const by2 = y - currentAge - 1;
    const p1 = pensionAgeByBirthYearApprox(by1);
    const p2 = pensionAgeByBirthYearApprox(by2);
    return Math.min(70, Math.max(p1, p2));
  }
  function futureValue(savings, monthly, years, rAnnual=0.04){
    if (years <= 0) return savings;
    const r = rAnnual/12;
    const n = Math.round(years*12);
    const growth = Math.pow(1+r, n);
    const fvLump = savings * growth;
    const fvAnn = monthly * ((growth - 1)/r);
    return fvLump + fvAnn;
  }
  function bridgePV(monthlyIncome, years, rAnnual=0.02, buffer=0.10){
    const n = Math.max(0, years);
    if (n === 0) return 0;
    const r = rAnnual;
    let pv;
    if (r === 0) pv = monthlyIncome*12*n;
    else pv = monthlyIncome*12 * (1 - Math.pow(1+r, -n)) / r;
    return pv * (1+buffer);
  }
  function solveStopAge(age, pensionAge, savings, monthlyTotal, income){
    const minAge = age;
    const maxAge = pensionAge;
    let best = NaN;
    for (let a=minAge; a<=maxAge; a+=0.5){
      const t = a - age;
      const fv = futureValue(savings, monthlyTotal, t, 0.04);
      const need = bridgePV(income, pensionAge - a, 0.02, 0.10);
      if (fv >= need){ best = a; break; }
    }
    if (!Number.isFinite(best)) best = pensionAge;
    return best;
  }
  function inverseNeedAtTarget(targetAge, st, monthlyTotal){
    const r = 0.04/12;
    const years = targetAge - st.age;
    if (!(years > 0)) return { ok:false };
    const n = Math.round(years*12);
    const growth = Math.pow(1+r, n);

    const need = bridgePV(st.income, Math.max(0, st.pensionAge - targetAge), 0.02, 0.10);
    const fvLump = st.savings * growth;
    const fvAnn = monthlyTotal * ((growth - 1)/r);
    const fvCurrent = fvLump + fvAnn;

    let extraMonthly = 0;
    if (need > fvCurrent){
      const totalMonthlyReq = (need - fvLump) * r / (growth - 1);
      extraMonthly = Math.max(0, totalMonthlyReq - monthlyTotal);
    }

    let extraLump = 0;
    const needMinusAnn = need - fvAnn;
    if (needMinusAnn > fvLump){
      const totalLumpReq = needMinusAnn / growth;
      extraLump = Math.max(0, totalLumpReq - st.savings);
    }

    return { ok:true, extraMonthly, extraLump };
  }

  // Labels
  const gapLabel = (gapYears, pensionAge)=>{
    if (!Number.isFinite(gapYears) || !Number.isFinite(pensionAge)) return "‚Äî";
    const days = Math.round(gapYears*365);
    if (days < 30) return `Det svarer til ca. ${days} dage f√∏r folkepension (${pensionAge} √•r, estimat)`;
    const months = Math.round(days/30);
    if (months < 24) return `Det svarer til ca. ${months} m√•neder f√∏r folkepension (${pensionAge} √•r, estimat)`;
    const y = Math.round(gapYears*2)/2;
    return `Det svarer til ca. ${y.toString().replace('.',',')} √•r f√∏r folkepension (${pensionAge} √•r, estimat)`;
  };
  const microGainLabel = (years)=>{
    if (!Number.isFinite(years)) return "‚Äî";
    const days = Math.round(years*365);
    if (days < 30) return "<1 md";
    const months = Math.round(days/30);
    if (months < 24) return `+${months} md`;
    const y = (months/12);
    const yRound = Math.round(y*2)/2;
    return `+${yRound.toString().replace('.',',')} √•r`;
  };

  // ---------- App State ----------
  const st = {
    step: "intro",
    age: NaN,
    pensionAge: NaN,
    savings: NaN,
    monthly: NaN,
    income: NaN,

    microSelected: new Set(),
    microCustom: 0,

    microBaselineGain: new Map(),
    microEligible: new Set(),
    microBaselineCustomMin: NaN,

    stopAge: NaN,
    microApplied: false,

    earlier: 0,
    targetAge: NaN,
    reqExtraMonthly: NaN,
    reqExtraLump: NaN,
  };

  const microOptions = [
    { id:"move200",  emoji:"‚û°Ô∏è", name:"Omdirig√©r 200 kr./md til frihed",   kr:200 },
    { id:"move300",  emoji:"‚û°Ô∏è", name:"Omdirig√©r 300 kr./md til frihed",   kr:300 },
    { id:"move400",  emoji:"‚û°Ô∏è", name:"Omdirig√©r 400 kr./md til frihed",   kr:400 },
    { id:"subs",     emoji:"üßæ", name:"Optimer abonnementer (+150 kr./md)",  kr:150 },
    { id:"shop",     emoji:"üõí", name:"Sm√• forbrugstilpasninger (+250 kr./md)", kr:250 },
    { id:"food",     emoji:"ü•ó", name:"Mad-budget justering (+500 kr./md)",  kr:500 },
    { id:"impulse",  emoji:"üß†", name:"Mindre impulsk√∏b (+400 kr./md)",      kr:400 },
    { id:"transport",emoji:"üö≤", name:"Transport-optimering (+300 kr./md)",  kr:300 },
  ];

  // ---------- UI ----------
  const ui = {};
  const sections = {};
  let lastStopAge = NaN;

  function setStep(next){
    for (const k in sections) sections[k].classList.remove("active");
    sections[next].classList.add("active");
    st.step = next;

    const map = { intro:0, age:20, numbers:40, result:60, micro:80, reality:100 };
    ui.progressFill.style.width = (map[next] ?? 0) + "%";
    window.scrollTo({top:0, behavior:"instant"});
  }

  function selectedExtraMonthly(){
    let sum = 0;
    for (const opt of microOptions) if (st.microSelected.has(opt.id)) sum += opt.kr;
    sum += Math.max(0, Number.isFinite(st.microCustom) ? st.microCustom : 0);
    return sum;
  }

  function syncAgeCard(){
    const v = parseDK(ui.ageInput.value);
    const a = Math.round(v);
    if (Number.isFinite(a) && a>=18 && a<=80) ui.pensionAgeBig.textContent = estimatePensionAgeFromAge(a);
    else ui.pensionAgeBig.textContent = "‚Äî";
  }

  function commitAge(){
    const v = parseDK(ui.ageInput.value);
    const a = Math.round(v);
    if (!Number.isFinite(a) || a<18 || a>80) return false;
    st.age = a;
    st.pensionAge = estimatePensionAgeFromAge(a);
    return true;
  }

  function commitNumbers(){
    const s = parseDK(ui.savingsInput.value);
    const m = parseDK(ui.monthlyInput.value);
    const inc = parseDK(ui.incomeInput.value);
    if (!(Number.isFinite(s) && s>=0)) return false;
    if (!(Number.isFinite(m) && m>=0)) return false;
    if (!(Number.isFinite(inc) && inc>0)) return false;
    st.savings = s;
    st.monthly = m;
    st.income = inc;
    return true;
  }

  function resetAll(){
    st.step="intro";
    st.age=NaN; st.pensionAge=NaN; st.savings=NaN; st.monthly=NaN; st.income=NaN;
    st.microSelected.clear(); st.microCustom=0;
    st.microBaselineGain.clear(); st.microEligible.clear(); st.microBaselineCustomMin=NaN;
    st.stopAge=NaN; st.microApplied=false;
    st.earlier=0; st.targetAge=NaN; st.reqExtraMonthly=NaN; st.reqExtraLump=NaN;
    lastStopAge = NaN;

    ui.ageInput.value=""; ui.pensionAgeBig.textContent="‚Äî";
    ui.savingsInput.value=""; ui.monthlyInput.value=""; ui.incomeInput.value="";
    ui.customMicroInput.value="";
    ui.errAge.classList.remove("show");
    ui.errNums.classList.remove("show");
    ui.errMicro.classList.remove("show");
    ui.detailsBox.classList.remove("open");
    ui.toggleDetailsBtn.textContent="Se beregningsgrundlag";
    ui.toRealityCard.style.display="none";
    ui.resultMeta.textContent="Baseret p√• dine tal lige nu.";
    ui.leadCard.style.display="none";
    closeLead(true);
    setStep("intro");
  }

  function updateResult(){
    const ok = [st.age, st.pensionAge, st.savings, st.monthly, st.income].every(Number.isFinite);
    ui.curAgeLbl.textContent = Number.isFinite(st.age) ? st.age : "‚Äî";
    ui.pensionAgeLbl.textContent = Number.isFinite(st.pensionAge) ? st.pensionAge : "‚Äî";
    if (!ok){
      st.stopAge = NaN;
      ui.stopAgeBig.textContent="‚Äî";
      ui.gapText.textContent="‚Äî";
      ui.detailsText.textContent="‚Äî";
      return;
    }

    const extra = selectedExtraMonthly();
    const stop = solveStopAge(st.age, st.pensionAge, st.savings, st.monthly + extra, st.income);
    st.stopAge = stop;

    // animate stopAge
    const fmtAge = (v)=> v.toFixed(1).replace('.',',').replace(',0','');
    if (Number.isFinite(stop)){
      animateNumber(ui.stopAgeBig, lastStopAge, stop, fmtAge, 280);
      ui.stopAgeBig.classList.remove("bump"); void ui.stopAgeBig.offsetWidth; ui.stopAgeBig.classList.add("bump");
      lastStopAge = stop;
    } else {
      ui.stopAgeBig.textContent="‚Äî";
    }

    ui.gapText.textContent = gapLabel(st.pensionAge - stop, st.pensionAge);

    const fv = futureValue(st.savings, st.monthly + extra, Math.max(0, stop - st.age), 0.04);
    const need = bridgePV(st.income, Math.max(0, st.pensionAge - stop), 0.02, 0.10);
    ui.detailsText.textContent =
      `Folkepension (estimat): ${st.pensionAge} √•r\n` +
      `Mulig stop-alder: ${stop.toString().replace('.',',')} √•r\n` +
      `Overgangsperiode: ${(st.pensionAge-stop).toString().replace('.',',')} √•r\n\n` +
      `Kapital ved stop (estimat): ${fmtDK(fv)} kr.\n` +
      `Kapital til overgang (inkl. 10% buffer): ${fmtDK(need)} kr.\n` +
      `Ekstra l√∏ft fra valg: ${fmtDK(extra)} kr./md\n\n` +
      `Antagelser: 4% real (opsparing) ¬∑ 2% real (overgang) ¬∑ 10% buffer.`;
  }

  function computeMicroBaseline(){
    st.microBaselineGain.clear();
    st.microEligible.clear();

    const ok = [st.age, st.pensionAge, st.savings, st.monthly, st.income].every(Number.isFinite);
    if (!ok) return;

    const baseMonthly = st.monthly;
    for (const opt of microOptions){
      const stopNow = solveStopAge(st.age, st.pensionAge, st.savings, baseMonthly, st.income);
      const stopWith = solveStopAge(st.age, st.pensionAge, st.savings, baseMonthly + opt.kr, st.income);
      const gain = stopNow - stopWith;
      st.microBaselineGain.set(opt.id, gain);
      if (Math.round(gain*365) >= 30) st.microEligible.add(opt.id);
    }

    // minimal custom for >= 1 month (binary search)
    const targetDays = 30;
    let lo=0, hi=20000;
    for (let i=0;i<18;i++){
      const mid=(lo+hi)/2;
      const stopNow = solveStopAge(st.age, st.pensionAge, st.savings, baseMonthly, st.income);
      const stopWith = solveStopAge(st.age, st.pensionAge, st.savings, baseMonthly + mid, st.income);
      const d = Math.round((stopNow-stopWith)*365);
      if (d >= targetDays) hi = mid; else lo = mid;
    }
    st.microBaselineCustomMin = hi;
  }

  function renderMicro(){
    ui.microList.innerHTML = "";
    const ok = [st.age, st.pensionAge, st.savings, st.monthly, st.income].every(Number.isFinite);
    if (!ok){ ui.errMicro.classList.add("show"); return; }
    ui.errMicro.classList.remove("show");

    // custom micro counts only if baseline >= 1 month
    const customVal = parseDK(ui.customMicroInput.value);
    const custom = Number.isFinite(customVal) ? Math.max(0, customVal) : 0;
    if (custom > 0){
      const baseMonthly = st.monthly;
      const stopNow = solveStopAge(st.age, st.pensionAge, st.savings, baseMonthly, st.income);
      const stopWith = solveStopAge(st.age, st.pensionAge, st.savings, baseMonthly + custom, st.income);
      const baselineDays = Math.round((stopNow-stopWith)*365);
      if (baselineDays < 30){
        st.microCustom = 0;
        ui.customNote.textContent = `Bel√∏bet giver under 1 m√•ned effekt (baseline). Pr√∏v ca. ${fmtDK(st.microBaselineCustomMin)} kr./md eller mere.`;
      } else {
        st.microCustom = custom;
        ui.customNote.textContent = "Tilf√∏jet (baseline ‚â• 1 m√•ned).";
      }
    } else {
      st.microCustom = 0;
      ui.customNote.textContent = "Tilf√∏jes, hvis det giver mindst 1 m√•ned effekt (baseline).";
    }

    // total gain
    const extra = selectedExtraMonthly();
    const stopNoMicro = solveStopAge(st.age, st.pensionAge, st.savings, st.monthly, st.income);
    const stopWithMicro = solveStopAge(st.age, st.pensionAge, st.savings, st.monthly + extra, st.income);
    ui.totalGainLbl.textContent = microGainLabel(stopNoMicro - stopWithMicro);

    // eligible list: selected first, then by baseline gain desc
    const eligible = microOptions.filter(o => st.microEligible.has(o.id));
    eligible.sort((a,b)=>{
      const as = st.microSelected.has(a.id) ? 1 : 0;
      const bs = st.microSelected.has(b.id) ? 1 : 0;
      if (as !== bs) return bs - as;
      const ga = st.microBaselineGain.get(a.id) ?? 0;
      const gb = st.microBaselineGain.get(b.id) ?? 0;
      return gb - ga;
    });

    for (const opt of eligible){
      const item = document.createElement("div");
      item.className = "microItem" + (st.microSelected.has(opt.id) ? " selected" : "");
      item.setAttribute("role","button");
      item.tabIndex = 0;

      // marginal gain label given current selection
      const baseMonthlyTotal = st.monthly + selectedExtraMonthly();
      const stopNow = solveStopAge(st.age, st.pensionAge, st.savings, baseMonthlyTotal, st.income);
      const stopWith = solveStopAge(st.age, st.pensionAge, st.savings, baseMonthlyTotal + opt.kr, st.income);
      const nowGain = stopNow - stopWith;

      item.innerHTML = `
        <div class="microLeft">
          <div class="emoji" aria-hidden="true">${opt.emoji}</div>
          <div style="min-width:0">
            <div class="microName">${opt.name}</div>
          </div>
        </div>
        <div class="microRight">
          <div class="microGain mono">${microGainLabel(nowGain)}</div>
          <div class="microCost mono">${fmtDK(opt.kr)} kr./md</div>
        </div>
      `;

      const toggle = ()=>{
        if (st.microSelected.has(opt.id)) st.microSelected.delete(opt.id);
        else st.microSelected.add(opt.id);
        renderMicro();
        updateResult();
      };

      item.addEventListener("click", toggle, {passive:true});
      item.addEventListener("keydown", (e)=>{ if (e.key==="Enter"||e.key===" "){ e.preventDefault(); toggle(); }});
      ui.microList.appendChild(item);
    }

    updateResult();
  }

  function prepareReality(){
    const ok = [st.age, st.stopAge].every(Number.isFinite);
    if (!ok){
      ui.earlierSlider.max = "0";
      ui.earlierSlider.value = "0";
      ui.earlierLbl.textContent = "0 √•r";
      ui.targetAgeLbl.textContent = "‚Äî";
      ui.targetMeta.textContent = "‚Äî";
      ui.needMonthlyLbl.textContent = "‚Äî";
      ui.needLumpLbl.textContent = "‚Äî";
      ui.leadCard.style.display = "none";
      return;
    }

    const maxEarlierRaw = st.stopAge - (st.age + 0.5);
    const maxEarlier = Math.max(0, Math.floor(maxEarlierRaw*2)/2);
    ui.earlierSlider.max = String(maxEarlier);
    ui.earlierSlider.value = "0";
    updateReality();
  }

  function updateReality(){
    const earlier = parseFloat(ui.earlierSlider.value || "0") || 0;
    st.earlier = earlier;
    ui.earlierLbl.textContent = `${earlier.toString().replace('.',',')} √•r`;

    if (!Number.isFinite(st.stopAge)){
      ui.targetAgeLbl.textContent = "‚Äî";
      ui.targetMeta.textContent = "‚Äî";
      ui.needMonthlyLbl.textContent = "‚Äî";
      ui.needLumpLbl.textContent = "‚Äî";
      ui.leadCard.style.display = "none";
      return;
    }

    const targetAge = st.stopAge - earlier;
    st.targetAge = targetAge;
    ui.targetAgeLbl.textContent = `${targetAge.toString().replace('.',',')} √•r`;
    ui.targetMeta.textContent = earlier > 0 ? `m√•l: ca. ${earlier.toString().replace('.',',')} √•r tidligere` : "v√¶lg et m√•l (0,5 √•r-trin)";

    if (earlier <= 0){
      st.reqExtraMonthly = 0;
      st.reqExtraLump = 0;
      ui.needMonthlyLbl.textContent = "‚Äî";
      ui.needLumpLbl.textContent = "‚Äî";
      ui.leadCard.style.display = "none";
      return;
    }

    const monthlyTotal = st.monthly + selectedExtraMonthly();
    const req = inverseNeedAtTarget(targetAge, st, monthlyTotal);
    if (!req.ok){
      st.reqExtraMonthly = NaN;
      st.reqExtraLump = NaN;
      ui.needMonthlyLbl.textContent = "‚Äî";
      ui.needLumpLbl.textContent = "‚Äî";
      ui.leadCard.style.display = "none";
      return;
    }

    st.reqExtraMonthly = req.extraMonthly;
    st.reqExtraLump = req.extraLump;

    ui.needMonthlyLbl.textContent = `+${fmtDK(req.extraMonthly)} kr./md`;
    ui.needLumpLbl.textContent = `+${fmtDK(req.extraLump)} kr.`;

    // Show lead CTA only if (1) user completed micro step AND (2) there's a real need
    const shouldShowLead = st.microApplied && ((req.extraMonthly > 0.5) || (req.extraLump > 1000));
    ui.leadCard.style.display = shouldShowLead ? "block" : "none";
  }

  // ---------- Lead module (demo-ready) ----------
  function scenarioSummaryLines(){
    const microSelected = Array.from(st.microSelected);
    const extraMonthly = selectedExtraMonthly();
    return [
      `Alder: ${Number.isFinite(st.age) ? st.age : "‚Äî"}`,
      `Folkepension (estimat): ${Number.isFinite(st.pensionAge) ? st.pensionAge : "‚Äî"}`,
      `Mulig stop-alder: ${Number.isFinite(st.stopAge) ? st.stopAge.toString().replace('.',',') : "‚Äî"}`,
      `Opsparing: ${Number.isFinite(st.savings) ? fmtDK(st.savings) + " kr." : "‚Äî"}`,
      `M√•nedlig investering: ${Number.isFinite(st.monthly) ? fmtDK(st.monthly) + " kr./md" : "‚Äî"}`,
      `√ònsket indkomst: ${Number.isFinite(st.income) ? fmtDK(st.income) + " kr./md" : "‚Äî"}`,
      `Valgte l√∏ft: ${microSelected.length ? microSelected.join(", ") : "ingen"}`,
      `Samlet ekstra l√∏ft: ${fmtDK(extraMonthly)} kr./md`,
      `M√•l (stopalder): ${Number.isFinite(st.targetAge) ? st.targetAge.toString().replace('.',',') + " √•r" : "‚Äî"}`,
      `N√∏dvendigt ekstra l√∏ft: ${Number.isFinite(st.reqExtraMonthly) ? "+" + fmtDK(st.reqExtraMonthly) + " kr./md" : "‚Äî"}  |  ${Number.isFinite(st.reqExtraLump) ? "+" + fmtDK(st.reqExtraLump) + " kr." : "‚Äî"}`
    ].join("\n");
  }

  function buildLeadPayload(contact, consent, share){
    return {
      contact: {
        name: contact.name || null,
        email: contact.email || null,
        phone: contact.phone || null,
      },
      consent: !!consent,
      scenario: share ? {
        age: st.age,
        pension_estimate: st.pensionAge,
        stop_estimate: st.stopAge,
        savings: st.savings,
        monthly_investment: st.monthly,
        desired_income: st.income,
        micro_selected: Array.from(st.microSelected),
        micro_extra_monthly: selectedExtraMonthly(),
        slider_target_age: st.targetAge,
        required_extra_monthly: st.reqExtraMonthly,
        required_extra_lump_sum: st.reqExtraLump,
      } : null,
      meta: {
        timestamp: isoNow(),
        app_version: "7.0.0",
        mode: LEAD_ENDPOINT ? "live" : "demo"
      }
    };
  }

  function openLead(){
    ui.leadErrA.classList.remove("show");
    ui.leadErrB.classList.remove("show");

    ui.leadStepA.style.display = "block";
    ui.leadStepB.style.display = "none";
    ui.leadThanks.style.display = "none";

    ui.scenarioPreview.textContent = scenarioSummaryLines();
    ui.shareScenario.checked = true;

    ui.leadBack.classList.add("open");
  }

  function closeLead(hardReset=false){
    ui.leadBack.classList.remove("open");
    if (hardReset){
      ui.leadName.value = "";
      ui.leadEmail.value = "";
      ui.leadPhone.value = "";
      ui.leadConsent.checked = false;
      ui.shareScenario.checked = true;
      ui.leadPayloadPreview.textContent = "‚Äî";
    }
  }

  function validateLeadA(){
    const name = ui.leadName.value.trim();
    const email = ui.leadEmail.value.trim();
    const phone = ui.leadPhone.value.trim();
    const consent = ui.leadConsent.checked;
    const ok = (name.length > 0) && (email.length > 0) && (phone.length > 0) && consent;
    return { ok };
  }

  function storeDemoLead(payload){
    try{
      const key = "tidsloft_demo_leads";
      const arr = JSON.parse(localStorage.getItem(key) || "[]");
      arr.push(payload);
      localStorage.setItem(key, JSON.stringify(arr));
    } catch(_e){}
  }

  async function submitLead(){
    ui.leadErrB.classList.remove("show");

    const contact = {
      name: ui.leadName.value.trim(),
      email: ui.leadEmail.value.trim(),
      phone: ui.leadPhone.value.trim(),
    };
    const consent = ui.leadConsent.checked;
    const share = ui.shareScenario.checked;

    const payload = buildLeadPayload(contact, consent, share);

    if (!LEAD_ENDPOINT){
      storeDemoLead(payload);
      ui.leadPayloadPreview.textContent = JSON.stringify(payload, null, 2);
      ui.leadStepA.style.display = "none";
      ui.leadStepB.style.display = "none";
      ui.leadThanks.style.display = "block";
      console.log("[DEMO] Lead payload", payload);
      return;
    }

    try{
      const res = await fetch(LEAD_ENDPOINT, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error("HTTP " + res.status);
      ui.leadPayloadPreview.textContent = "Afsendt.";
      ui.leadStepA.style.display = "none";
      ui.leadStepB.style.display = "none";
      ui.leadThanks.style.display = "block";
    } catch(err){
      ui.leadErrB.textContent = "Afsendelse fejlede. (Demo kan fortsat bruges uden endpoint.)";
      ui.leadErrB.classList.add("show");
      console.error(err);
    }
  }

  // ---------- Sanity tests ----------
  function sanityTests(){
    const age=46;
    const pension=estimatePensionAgeFromAge(age);
    if (!(pension>=67 && pension<=70)) throw new Error("Sanity: pensionAge invalid");
    const stop=solveStopAge(46, pension, 25000, 3500, 35000);
    if (!Number.isFinite(stop)) throw new Error("Sanity: stopAge NaN");
    const fv=futureValue(25000,3500,10,0.04);
    if (!Number.isFinite(fv) || fv<=0) throw new Error("Sanity: FV invalid");
  }

  // ---------- Init ----------
  try{
    // sections
    sections.intro = el("s_intro");
    sections.age = el("s_age");
    sections.numbers = el("s_numbers");
    sections.result = el("s_result");
    sections.micro = el("s_micro");
    sections.reality = el("s_reality");

    // ui core
    ui.progressFill = el("progressFill");
    ui.startBtn = el("startBtn");
    ui.assumBtn = el("assumBtn");

    ui.ageInput = el("ageInput");
    ui.pensionAgeBig = el("pensionAgeBig");
    ui.ageNextBtn = el("ageNextBtn");
    ui.demoBtn = el("demoBtn");
    ui.errAge = el("errAge");

    ui.savingsInput = el("savingsInput");
    ui.monthlyInput = el("monthlyInput");
    ui.incomeInput = el("incomeInput");
    ui.numsBackBtn = el("numsBackBtn");
    ui.numsNextBtn = el("numsNextBtn");
    ui.resetNumsBtn = el("resetNumsBtn");
    ui.errNums = el("errNums");

    ui.resultMeta = el("resultMeta");
    ui.curAgeLbl = el("curAgeLbl");
    ui.pensionAgeLbl = el("pensionAgeLbl");
    ui.stopAgeBig = el("stopAgeBig");
    ui.gapText = el("gapText");
    ui.detailsText = el("detailsText");
    ui.toggleDetailsBtn = el("toggleDetailsBtn");
    ui.detailsBox = el("detailsBox");
    ui.resBackBtn = el("resBackBtn");
    ui.startOverBtn = el("startOverBtn");
    ui.toMicroBtn = el("toMicroBtn");
    ui.toRealityBtn = el("toRealityBtn");
    ui.toRealityCard = el("toRealityCard");

    ui.microList = el("microList");
    ui.totalGainLbl = el("totalGainLbl");
    ui.customMicroInput = el("customMicroInput");
    ui.customNote = el("customNote");
    ui.errMicro = el("errMicro");
    ui.microBackBtn = el("microBackBtn");
    ui.microDoneBtn = el("microDoneBtn");

    ui.earlierSlider = el("earlierSlider");
    ui.earlierLbl = el("earlierLbl");
    ui.targetAgeLbl = el("targetAgeLbl");
    ui.targetMeta = el("targetMeta");
    ui.needMonthlyLbl = el("needMonthlyLbl");
    ui.needLumpLbl = el("needLumpLbl");
    ui.realityBackBtn = el("realityBackBtn");

    // lead ui
    ui.leadCard = el("leadCard");
    ui.openLeadBtn = el("openLeadBtn");

    ui.leadBack = el("leadBack");
    ui.leadStepA = el("leadStepA");
    ui.leadStepB = el("leadStepB");
    ui.leadThanks = el("leadThanks");

    ui.leadName = el("leadName");
    ui.leadEmail = el("leadEmail");
    ui.leadPhone = el("leadPhone");
    ui.leadConsent = el("leadConsent");
    ui.leadErrA = el("leadErrA");

    ui.leadNextBtn = el("leadNextBtn");
    ui.leadBackBtn = el("leadBackBtn");
    ui.leadSubmitBtn = el("leadSubmitBtn");
    ui.closeLeadBtn = el("closeLeadBtn");
    ui.leadDoneBtn = el("leadDoneBtn");

    ui.shareScenario = el("shareScenario");
    ui.scenarioPreview = el("scenarioPreview");
    ui.leadErrB = el("leadErrB");
    ui.leadPayloadPreview = el("leadPayloadPreview");

    // privacy ui
    ui.privacyBack = el("privacyBack");
    ui.privacyBtn = el("privacyBtn");
    ui.privacyBtn2 = el("privacyBtn2");
    ui.closePrivacyBtn = el("closePrivacyBtn");

    // assumptions modal
    ui.modalBack = el("modalBack");
    ui.closeModalBtn = el("closeModalBtn");

    // sanity
    sanityTests();

    // events
    on(ui.startBtn, "click", ()=> setStep("age"));
    on(ui.demoBtn, "click", ()=> { ui.ageInput.value="46"; syncAgeCard(); });

    ui.ageInput.addEventListener("input", syncAgeCard, {passive:true});

    on(ui.ageNextBtn, "click", ()=>{
      ui.errAge.classList.remove("show");
      if (!commitAge()){ ui.errAge.classList.add("show"); return; }
      setStep("numbers");
    });

    on(ui.numsBackBtn, "click", ()=> setStep("age"));
    on(ui.resetNumsBtn, "click", ()=>{
      ui.savingsInput.value=""; ui.monthlyInput.value=""; ui.incomeInput.value="";
    });

    on(ui.numsNextBtn, "click", ()=>{
      ui.errNums.classList.remove("show");
      if (!commitAge()){ setStep("age"); ui.errAge.classList.add("show"); return; }
      if (!commitNumbers()){ ui.errNums.classList.add("show"); return; }

      st.microSelected.clear(); st.microCustom=0;
      ui.customMicroInput.value="";
      st.microApplied=false;
      ui.toRealityCard.style.display="none";
      ui.resultMeta.textContent="Baseret p√• dine tal lige nu.";
      ui.leadCard.style.display="none";
      lastStopAge = NaN;

      computeMicroBaseline();
      updateResult();
      setStep("result");
    });

    on(ui.toggleDetailsBtn, "click", ()=>{
      const open = ui.detailsBox.classList.toggle("open");
      ui.toggleDetailsBtn.textContent = open ? "Skjul beregningsgrundlag" : "Se beregningsgrundlag";
    });

    on(ui.resBackBtn, "click", ()=> setStep("numbers"));
    on(ui.startOverBtn, "click", resetAll);

    on(ui.toMicroBtn, "click", ()=>{
      computeMicroBaseline();
      renderMicro();
      setStep("micro");
    });

    on(ui.microBackBtn, "click", ()=> setStep("result"));

    ui.customMicroInput.addEventListener("input", ()=> { renderMicro(); }, {passive:true});

    on(ui.microDoneBtn, "click", ()=>{
      st.microApplied = true;
      ui.resultMeta.textContent = "Opdateret efter dine frihedsl√∏ft.";
      ui.toRealityCard.style.display = "block";
      updateResult();
      setStep("result");
    });

    on(ui.toRealityBtn, "click", ()=>{
      if (!st.microApplied) return;
      prepareReality();
      setStep("reality");
    });

    ui.earlierSlider.addEventListener("input", updateReality, {passive:true});
    on(ui.realityBackBtn, "click", ()=> setStep("result"));

    // assumptions modal
    on(ui.assumBtn, "click", ()=> ui.modalBack.classList.add("open"));
    on(ui.closeModalBtn, "click", ()=> ui.modalBack.classList.remove("open"));
    ui.modalBack.addEventListener("click", (e)=>{ if (e.target===ui.modalBack) ui.modalBack.classList.remove("open"); }, {passive:true});

    // lead modal
    on(ui.openLeadBtn, "click", openLead);
    on(ui.closeLeadBtn, "click", ()=> closeLead(false));
    on(ui.leadDoneBtn, "click", ()=> closeLead(true));
    ui.leadBack.addEventListener("click", (e)=>{ if (e.target===ui.leadBack) closeLead(false); }, {passive:true});

    on(ui.leadNextBtn, "click", ()=>{
      ui.leadErrA.classList.remove("show");
      const v = validateLeadA();
      if (!v.ok){ ui.leadErrA.classList.add("show"); return; }

      ui.scenarioPreview.textContent = scenarioSummaryLines();
      ui.leadStepA.style.display = "none";
      ui.leadStepB.style.display = "block";
      ui.leadThanks.style.display = "none";
    });

    on(ui.leadBackBtn, "click", ()=>{
      ui.leadErrB.classList.remove("show");
      ui.leadStepA.style.display = "block";
      ui.leadStepB.style.display = "none";
      ui.leadThanks.style.display = "none";
    });

    ui.shareScenario.addEventListener("change", ()=> {
      ui.scenarioPreview.textContent = ui.shareScenario.checked ? scenarioSummaryLines() : "(Ingen beregningsdata deles.)";
    }, {passive:true});

    on(ui.leadSubmitBtn, "click", submitLead);

    // privacy modal
    on(ui.privacyBtn, "click", ()=> ui.privacyBack.classList.add("open"));
    on(ui.privacyBtn2, "click", ()=> ui.privacyBack.classList.add("open"));
    on(ui.closePrivacyBtn, "click", ()=> ui.privacyBack.classList.remove("open"));
    ui.privacyBack.addEventListener("click", (e)=>{ if (e.target===ui.privacyBack) ui.privacyBack.classList.remove("open"); }, {passive:true});

    // initial
    syncAgeCard();
    setStep("intro");

  } catch(err){
    fatal("Appen kunne ikke starte korrekt.", err);
  }
})();
</script>
</body>
</html>
