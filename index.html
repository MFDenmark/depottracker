<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Tidsl√∏ft ¬∑ v5.9.1</title>
<style>
:root{
  --bg1:#f4f8ff; --bg2:#e9f1ff; --card:#ffffff;
  --text:#0b1220; --muted:#566b85; --line:#e6edf7;
  --blue:#3b82f6; --blue2:#1e40af; --teal:#06b6d4;
  --shadow:0 26px 70px rgba(10,30,70,.14);
  --shadow2:0 18px 45px rgba(10,30,70,.10);
  --radius:26px;
}
*{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
html,body{height:100%;}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  color:var(--text);
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
}
.app{max-width:860px;margin:0 auto;padding:18px 14px 30px;}
.header{
  position:sticky; top:0; z-index:50;
  padding:10px 12px 12px;
  backdrop-filter: blur(10px);
  background:linear-gradient(180deg, rgba(244,248,255,.92), rgba(244,248,255,.60));
  border-bottom:1px solid rgba(230,237,247,.6);
  border-radius:18px;
}
.toprow{display:flex; align-items:center; justify-content:space-between; gap:12px;}
.brand{display:flex; align-items:flex-start; gap:10px; min-width:0;}
.dot{width:12px;height:12px;border-radius:50%;background:var(--teal);margin-top:6px; flex:0 0 auto;}
.brand h1{margin:0;font-size:20px;letter-spacing:.2px; line-height:1.1;}
.brand .sub{margin:2px 0 0;color:var(--muted);font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
.pillbtn{
  border:1px solid var(--line); background:rgba(255,255,255,.85);
  padding:10px 14px; border-radius:999px; font-weight:700; color:var(--text);
}
.progressWrap{margin-top:10px;}
.progressBar{height:8px;border-radius:999px;background:rgba(230,237,247,.9); overflow:hidden;}
.progressFill{height:100%; width:0%; background:linear-gradient(90deg,var(--blue),var(--teal)); border-radius:999px; transition:width .25s ease;}
.card{
  background:var(--card);
  border:1px solid rgba(230,237,247,.9);
  border-radius:var(--radius);
  box-shadow:var(--shadow2);
}
.hero{padding:22px 20px; margin-top:14px;}
.kicker{letter-spacing:.16em; font-weight:800; font-size:12px; color:var(--muted);}
.huge{margin:10px 0 10px;font-size:44px;line-height:1.0;letter-spacing:-.03em;}
.p{margin:0;color:var(--muted);font-size:18px;line-height:1.45;}
.small{font-size:13px;color:var(--muted);}
.cta{
  width:100%; border:0; cursor:pointer;
  padding:16px 18px;
  border-radius:999px;
  font-size:16px; font-weight:800; color:#fff;
  background:linear-gradient(90deg,var(--blue),var(--blue2));
  box-shadow: 0 14px 28px rgba(30,64,175,.25);
  position:relative; z-index:2;
  touch-action: manipulation;
}
.cta:active{transform:translateY(1px);}
.section{display:none;}
.section.active{display:block;}
.stepTitle{font-size:38px; margin:4px 0 6px; letter-spacing:-.02em;}
.stepMeta{color:var(--muted); margin:0 0 14px; font-size:16px;}
.formCard{padding:18px 16px; margin-top:14px;}
.label{font-weight:800; color:var(--muted); margin:14px 2px 8px;}
.input{
  width:100%; font-size:34px; font-weight:900; letter-spacing:.5px;
  padding:18px 16px; border-radius:20px;
  border:1px solid rgba(230,237,247,.9); outline:none;
  background:rgba(255,255,255,.9);
}
.input:focus{border-color:rgba(59,130,246,.55); box-shadow:0 0 0 4px rgba(59,130,246,.12);}
.row{display:flex; gap:12px; align-items:center;}
.row > *{flex:1;}
.btnRow{display:flex; gap:12px; margin-top:16px;}
.btn{
  flex:1; border:1px solid var(--line); background:rgba(255,255,255,.85);
  padding:14px 14px; border-radius:18px;
  font-weight:900; font-size:16px;
  cursor:pointer; touch-action: manipulation;
}
.btn.primary{border:0; color:#fff; background:linear-gradient(90deg,var(--blue),var(--blue2));}
.btn.ghost{background:rgba(255,255,255,.75);}
.btn.link{
  border:0; background:transparent; color:var(--muted);
  font-weight:900;
}
.note{margin-top:10px; font-size:13px; color:var(--muted); line-height:1.4;}
.note.tight{margin-top:6px;}
.resultWrap{padding:16px 14px; margin-top:14px;}
.bigNum{font-size:74px; font-weight:1000; letter-spacing:-.04em; margin:0; text-align:center;}
.center{text-align:center;}
.subStrong{font-size:22px; font-weight:900; margin:0 0 6px;}
.hr{height:1px;background:rgba(230,237,247,.9); margin:14px 0;}
.resultPill{
  display:flex; justify-content:space-between; gap:10px;
  padding:10px 12px; border-radius:18px;
  background:rgba(59,130,246,.08); border:1px solid rgba(59,130,246,.20);
  font-weight:900;
}
.resultPill span{color:var(--muted); font-weight:800;}
.details{display:none; margin-top:12px;}
.details.open{display:block;}
.mono{font-variant-numeric: tabular-nums;}
.microSticky{
  position:sticky; top:88px; z-index:40;
  margin-top:12px; padding:12px 12px;
  background:rgba(255,255,255,.92);
  border:1px solid rgba(230,237,247,.9);
  border-radius:22px;
  box-shadow: var(--shadow2);
}
.microSticky .line1{display:flex; justify-content:space-between; gap:10px; align-items:center;}
.microSticky .ttl{font-weight:1000; letter-spacing:-.01em;}
.microSticky .gain{font-weight:1000; color:var(--blue2);}
.microList{margin-top:12px; display:flex; flex-direction:column; gap:12px;}
.microItem{
  display:flex; justify-content:space-between; gap:12px; align-items:flex-start;
  padding:14px 14px; border-radius:22px;
  border:1px solid rgba(230,237,247,.9);
  background:rgba(255,255,255,.88);
  cursor:pointer;
  touch-action: manipulation;
}
.microItem.selected{border-color:rgba(59,130,246,.55); background:rgba(59,130,246,.08);}
.microLeft{display:flex; gap:12px; align-items:flex-start; min-width:0;}
.emoji{font-size:22px; width:28px; text-align:center; margin-top:2px;}
.microName{
  font-weight:1000; font-size:18px;
  white-space:normal; overflow:visible; text-overflow:clip;
  line-height:1.15;
}
.microRight{text-align:right;}
.microGain{font-weight:1000; color:var(--blue2); line-height:1.05;}
.microCost{font-weight:900; color:var(--muted);}
.err{display:none; margin-top:10px; padding:10px 12px; border-radius:16px; background:rgba(180,35,24,.08); border:1px solid rgba(180,35,24,.22); color:#7a1c12; font-weight:800;}
.err.show{display:block;}

.ctaCard{ margin-top:14px; padding:14px 14px; }
.ctaBtn{
  width:100%;
  display:flex; justify-content:space-between; align-items:center; gap:10px;
  border:1px solid rgba(59,130,246,.20);
  background:rgba(59,130,246,.06);
  padding:14px 14px;
  border-radius:18px;
  font-weight:1000;
  cursor:pointer;
}
.ctaBtn span{color:var(--muted); font-weight:900;}

.rcWrap{ margin-top:14px; padding:14px 14px; }
.rcBtn{
  width:100%;
  display:flex; justify-content:space-between; align-items:center; gap:10px;
  border:1px solid rgba(59,130,246,.20);
  background:rgba(59,130,246,.06);
  padding:14px 14px;
  border-radius:18px;
  font-weight:1000;
  cursor:pointer;
}
.rcBtn span{color:var(--muted); font-weight:900;}
.rcBox{display:none; margin-top:12px;}
.rcBox.open{display:block;}
.sliderRow{display:flex; align-items:center; gap:12px; margin-top:10px;}
.sliderRow input[type="range"]{width:100%;}
.rcBig{
  font-size:42px; font-weight:1000; letter-spacing:-.03em;
  margin:8px 0 0;
}
.rcLine{display:flex; justify-content:space-between; gap:10px; align-items:baseline; margin-top:10px;}
.rcLine .lbl{color:var(--muted); font-weight:900;}
.rcLine .val{font-weight:1000;}
.rcHint{margin-top:8px; font-size:12px; color:var(--muted); line-height:1.35;}

.modalBack{
  position:fixed; inset:0; background:rgba(10,18,32,.40);
  display:none; align-items:flex-end; justify-content:center;
  z-index:200;
}
.modalBack.open{display:flex;}
.modal{
  width:min(860px, 100%);
  border-radius:22px 22px 0 0;
  background:#fff;
  border:1px solid rgba(230,237,247,.9);
  padding:16px 16px 22px;
  box-shadow: var(--shadow);
}
.modal h3{margin:0 0 8px; font-size:18px;}
.modal ul{margin:8px 0 0; padding-left:18px; color:var(--muted); line-height:1.45;}
.modal .closeRow{display:flex; justify-content:flex-end; margin-top:14px;}
button, .btn, .cta, .microItem, .pillbtn{-webkit-user-select:none; user-select:none;}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="toprow">
      <div class="brand">
        <div class="dot" aria-hidden="true"></div>
        <div style="min-width:0">
          <h1>Tidsl√∏ft</h1>
          <div class="sub">Sm√• valg. Store l√∏ft. ¬∑ <span class="mono">v5.9.1</span> ¬∑ Seneste</div>
        </div>
      </div>
      <button class="pillbtn" id="assumBtn" type="button">Foruds√¶tninger</button>
    </div>
    <div class="progressWrap">
      <div class="progressBar" aria-hidden="true"><div class="progressFill" id="progressFill"></div></div>
    </div>
  </div>

  <section class="section active" id="s_intro">
    <div class="card hero">
      <div class="kicker">MULIGHEDEN</div>
      <div class="huge">√ònsker du f√¶rre<br/>√•r p√• arbejdsmarkedet?</div>
      <p class="p">P√• 90 sekunder ser du, hvad sm√• bel√∏b og sm√• valg kan betyde for din mulighed for at stoppe f√∏r folkepension.</p>
      <div style="height:16px"></div>
      <button class="cta" id="startBtn" type="button">Tag dit Tidsl√∏ft ‚Äì gratis</button>
      <div class="hr"></div>
      <div class="small">Vi regner konservativt og kun frem til folkepension (bro-model). Eksisterende pensioner er ikke med.</div>
    </div>
  </section>

  <section class="section" id="s_age">
    <div class="card formCard">
      <div class="kicker">TRIN 1/4</div>
      <div class="stepTitle">Din alder</div>
      <p class="stepMeta">Start let. Du f√•r et estimat p√• folkepension, n√•r du skriver din alder.</p>

      <div class="label">Alder</div>
      <input class="input" id="ageInput" inputmode="numeric" pattern="[0-9]*" placeholder="fx 46"/>

      <div class="card" style="margin-top:14px; padding:14px 14px;">
        <div class="kicker">FOLKEPENSION (ESTIMAT)</div>
        <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px;">
          <div style="font-size:64px; font-weight:1000; letter-spacing:-.04em;" class="mono" id="pensionAgeBig">‚Äî</div>
          <div class="small" style="text-align:right;">Vises f√∏rst, n√•r alder er indtastet.</div>
        </div>
      </div>

      <div class="err" id="errAge">Indtast en gyldig alder (18‚Äì80).</div>

      <div class="btnRow">
        <button class="btn primary" id="ageNextBtn" type="button">Forts√¶t</button>
        <button class="btn ghost" id="demoBtn" type="button">Demo</button>
      </div>
    </div>
  </section>

  <section class="section" id="s_numbers">
    <div class="card formCard">
      <div class="kicker">TRIN 2/4</div>
      <div class="stepTitle">Dine tal</div>
      <p class="stepMeta">Felterne har kun forslag (ikke forudfyldte v√¶rdier).</p>

      <div class="label">Opsparing i dag (kr.)</div>
      <input class="input" id="savingsInput" inputmode="numeric" placeholder="fx 25.000"/>

      <div class="label">M√•nedlig investering (kr./md)</div>
      <input class="input" id="monthlyInput" inputmode="numeric" placeholder="fx 3.500"/>

      <div class="label">√ònsket m√•nedlig indkomst f√∏r folkepension (kr./md)</div>
      <input class="input" id="incomeInput" inputmode="numeric" placeholder="fx 35.000"/>
      <div class="note tight">Angiv bel√∏b f√∏r skat. Bruges til at beregne bro-perioden.</div>

      <div class="row" style="margin-top:12px; gap:10px;">
        <button class="btn" id="resetNumsBtn" type="button">Nulstil tal</button>
      </div>

      <div class="err" id="errNums">Udfyld felterne med tal. Indkomst skal v√¶re &gt; 0.</div>

      <div class="btnRow">
        <button class="btn" id="numsBackBtn" type="button">Tilbage</button>
        <button class="btn primary" id="numsNextBtn" type="button">Forts√¶t</button>
      </div>
    </div>
  </section>

  <section class="section" id="s_result">
    <div class="card resultWrap">
      <div class="kicker">TRIN 3/4</div>
      <div class="stepTitle">Resultat</div>
      <p class="stepMeta">Fokus: hvorn√•r du muligvis kan stoppe f√∏r folkepension ‚Äì baseret p√• dine tal.</p>

      <div class="card" style="padding:14px 14px;">
        <div class="resultPill">
          <div>Din alder: <span class="mono" id="curAgeLbl">‚Äî</span></div>
          <div>Folkepension: <span class="mono" id="pensionAgeLbl">‚Äî</span></div>
        </div>

        <div style="height:12px"></div>
        <div class="bigNum mono" id="stopAgeBig">‚Äî</div>
        <div class="center">
          <div class="subStrong">stop-alder (estimat)</div>
          <div class="p" style="margin-top:0;" id="gapText">‚Äî</div>
        </div>

        <div class="card ctaCard">
          <button class="ctaBtn" id="findMoreCardBtn" type="button">
            <div>Find flere √•r <span>Sm√• valg kan g√∏re stor forskel</span></div>
            <div class="mono">‚ñ∏</div>
          </button>
        </div>

        <div style="height:12px"></div>
        <button class="btn" id="toggleDetailsBtn" type="button">Se beregningsdetaljer</button>
        <div class="details" id="detailsBox">
          <div class="card" style="margin-top:12px; padding:14px 14px;">
            <div class="small mono" id="detailsText">‚Äî</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="btnRow">
          <button class="btn" id="resBackBtn" type="button">Tilbage</button>
          <button class="btn" id="toRealityBtn" type="button">Ikke tilfreds?</button>
          <button class="btn link" id="startOverBtn" type="button">Start forfra</button>
          <button class="btn primary" id="toMicroBtn" type="button">Find flere √•r</button>
        </div>
      </div>
    </div>
  </section>

  <section class="section" id="s_micro">
    <div class="card formCard">
      <div class="kicker">TRIN 4/4</div>
      <div class="stepTitle">Mulige tidsl√∏ft</div>
      <p class="stepMeta">V√¶lg flere. Vi l√¶gger dem sammen som ekstra m√•nedligt bel√∏b. Resultatet opdateres l√∏bende.</p>

      <div class="microSticky" id="microSticky">
        <div class="line1">
          <div class="ttl">Ekstra tid (samlet)</div>
          <div class="gain mono" id="totalGainLbl">0</div>
        </div>
        <div class="small" style="margin-top:6px;">
          Vi viser kun valg, der giver mindst <strong>1 m√•ned</strong> effekt (baseret p√• dine tal f√∏r du v√¶lger noget).
        </div>
      </div>

      <div class="microList" id="microList"></div>

      </div>
  </section>

</div>

<div class="modalBack" id="modalBack" role="dialog" aria-modal="true" aria-label="Foruds√¶tninger">
  <div class="modal">
    <h3>Foruds√¶tninger</h3>
    <ul>
      <li><strong>Folkepensionsalder</strong>: Estimat ud fra din alder (kan afvige op til ca. 1 √•r pga. f√∏dselsdato). Vi bruger vedtaget folkepensionsalder og regner ikke med forh√∏jelser over senest vedtagne niveau (maks. 70 √•r for 1971+).</li>
      <li>Opsparing/investering: <strong>4% real</strong> √•rligt (f√∏r stop).</li>
      <li>Bro-periode (stop ‚Üí folkepension): forbrug diskonteres med <strong>2% real</strong> og l√¶gges <strong>10% buffer</strong> oveni.</li>
      <li>Modellen medregner ikke eksisterende pensioner, skat eller afkastbeskatning. Alle bel√∏b angives derfor som <strong>f√∏r skat</strong>.</li>
    </ul>
    <div class="closeRow">
      <button class="btn primary" id="closeModalBtn" type="button">Luk</button>
    </div>
  </div>
</div>

<script>
(() => {
  const fmtDK = (n)=>{ 
    if (!isFinite(n)) return "‚Äî";
    const s = Math.round(n).toString();
    return s.replace(/\B(?=(\d{3})+(?!\d))/g,'.');
  };

  const parseDK = (s)=>{
    if (s === null || s === undefined) return NaN;
    if (typeof s !== "string") s = String(s);
    const raw = s.trim();
    if (raw === "") return NaN;
    const cleaned = raw.replace(/\./g,'').replace(/\s/g,'').replace(/,/g,'.');
    const v = Number(cleaned);
    return Number.isFinite(v) ? v : NaN;
  };

  const microGainLabel = (years)=>{
    if (!isFinite(years)) return "‚Äî";
    const days = Math.round(years * 365);
    if (days < 30) return "<1 md";
    const months = Math.round(days / 30);
    if (months < 24) return `+${months} md`;
    const y = (months/12);
    const yRound = Math.round(y*2)/2;
    return `+${yRound.toString().replace('.',',')} √•r`;
  };

  const yearsToGapText = (gapYears, pensionAge)=>{
    if (!isFinite(gapYears) || !isFinite(pensionAge)) return "‚Äî";
    const days = Math.round(gapYears*365);
    if (days < 30) return `${days} dage f√∏r folkepension (${pensionAge} √•r, estimat)`;
    const months = Math.round(days/30);
    if (months < 24) return `${months} m√•neder f√∏r folkepension (${pensionAge} √•r, estimat)`;
    const y = Math.round(gapYears*2)/2;
    return `${y.toString().replace('.',',')} √•r f√∏r folkepension (${pensionAge} √•r, estimat)`;
  };

  function pensionAgeByBirthYearApprox(birthYear){
    if (birthYear <= 1962) return 67;
    if (birthYear <= 1966) return 68;
    if (birthYear <= 1970) return 69;
    return 70;
  }

  function estimatePensionAge(currentAge){
    const now = new Date();
    const y = now.getFullYear();
    const by1 = y - currentAge;
    const by2 = y - currentAge - 1;
    const p1 = pensionAgeByBirthYearApprox(by1);
    const p2 = pensionAgeByBirthYearApprox(by2);
    return Math.min(70, Math.max(p1, p2));
  }

  function futureValue(savings, monthly, years, rAnnual=0.04) {
    if (years <= 0) return savings;
    const r = rAnnual/12;
    const n = Math.round(years*12);
    const fvLump = savings * Math.pow(1+r, n);
    const fvAnn = monthly * ( (Math.pow(1+r, n) - 1) / r );
    return fvLump + fvAnn;
  }

  function bridgePV(monthlyIncome, years, rAnnual=0.02, buffer=0.10) {
    const n = Math.max(0, years);
    if (n === 0) return 0;
    const r = rAnnual;
    let pv;
    if (r === 0) pv = monthlyIncome*12*n;
    else pv = monthlyIncome*12 * (1 - Math.pow(1+r, -n)) / r;
    return pv * (1+buffer);
  }

  function solveStopAge(currentAge, pensionAge, savings, monthly, desiredIncome) {
    const minAge = currentAge;
    const maxAge = pensionAge;
    let best = NaN;
    for (let a = minAge; a <= maxAge; a += 0.5) {
      const t = a - currentAge;
      const fv = futureValue(savings, monthly, t, 0.04);
      const bridgeYears = pensionAge - a;
      const need = bridgePV(desiredIncome, bridgeYears, 0.02, 0.10);
      if (fv >= need) { best = a; break; }
    }
    if (!isFinite(best)) best = pensionAge;
    return best;
  }

  function invRequirementsAtTarget(targetAge, state, baseMonthlyTotal){
    const r = 0.04/12;
    const yearsToTarget = targetAge - state.age;
    if (!(yearsToTarget > 0)) return { ok:false };

    const n = Math.round(yearsToTarget*12);
    const growth = Math.pow(1+r, n);

    const need = bridgePV(state.income, Math.max(0, state.pensionAge - targetAge), 0.02, 0.10);

    const fvLump = state.savings * growth;
    const fvAnn = baseMonthlyTotal * ((growth - 1) / r);
    const fvCurrent = fvLump + fvAnn;

    let extraMonthly = 0;
    if (need > fvCurrent){
      const totalMonthlyReq = (need - fvLump) * r / (growth - 1);
      extraMonthly = Math.max(0, totalMonthlyReq - baseMonthlyTotal);
    }

    let extraLump = 0;
    const needMinusAnn = need - fvAnn;
    if (needMinusAnn > fvLump){
      const totalLumpReq = needMinusAnn / growth;
      extraLump = Math.max(0, totalLumpReq - state.savings);
    }

    return { ok:true, extraMonthly, extraLump };
  }

  const state = {
    step: "intro",
    visitedMicro: false,
    age: NaN,
    pensionAge: NaN,
    savings: NaN,
    monthly: NaN,
    income: NaN,
    stopAge: NaN,
    microSelected: new Set(),
    microCustom: 0,
    microBaselineGain: new Map(),
    microEligible: new Set(),
    microBaselineCustomMin: NaN,
  };

  const microOptions = [
    { id:"coffee",  emoji:"‚òïÔ∏è", name:"Mindre caf√©-kaffe",   kr:200 },
    { id:"takeaway",emoji:"üçî", name:"1 mindre take-away",  kr:400 },
    { id:"stream",  emoji:"üì∫", name:"Del streaming",       kr:150 },
    { id:"subs",    emoji:"üßæ", name:"Abonnement-scan",     kr:150 },
    { id:"cons",    emoji:"üõí", name:"5% mindre forbrug",   kr:250 },
    { id:"food",    emoji:"ü•ó", name:"Spar p√• madindk√∏b",   kr:500 },
    { id:"impulse", emoji:"üõçÔ∏è", name:"F√¶rre impulsk√∏b",    kr:400 },
    { id:"transport",emoji:"üö≤", name:"Transport-optimering",kr:300 },
  ];

  const sections = {
    intro: document.getElementById("s_intro"),
    age: document.getElementById("s_age"),
    numbers: document.getElementById("s_numbers"),
    result: document.getElementById("s_result"),
    micro: document.getElementById("s_micro"),
  };
  const progressFill = document.getElementById("progressFill");

  const startBtn = document.getElementById("startBtn");
  const ageInput = document.getElementById("ageInput");
  const pensionAgeBig = document.getElementById("pensionAgeBig");
  const ageNextBtn = document.getElementById("ageNextBtn");
  const demoBtn = document.getElementById("demoBtn");
  const errAge = document.getElementById("errAge");

  const savingsInput = document.getElementById("savingsInput");
  const monthlyInput = document.getElementById("monthlyInput");
  const incomeInput = document.getElementById("incomeInput");
  const numsBackBtn = document.getElementById("numsBackBtn");
  const numsNextBtn = document.getElementById("numsNextBtn");
  const resetNumsBtn = document.getElementById("resetNumsBtn");
  const errNums = document.getElementById("errNums");

  const curAgeLbl = document.getElementById("curAgeLbl");
  const pensionAgeLbl = document.getElementById("pensionAgeLbl");
  const stopAgeBig = document.getElementById("stopAgeBig");
  const gapText = document.getElementById("gapText");
  const detailsText = document.getElementById("detailsText");
  const toggleDetailsBtn = document.getElementById("toggleDetailsBtn");
  const detailsBox = document.getElementById("detailsBox");
  const resBackBtn = document.getElementById("resBackBtn");
  const startOverBtn = document.getElementById("startOverBtn");
  const toMicroBtn = document.getElementById("toMicroBtn");
  const findMoreCardBtn = document.getElementById("findMoreCardBtn");

  const microList = document.getElementById("microList");
  const totalGainLbl = document.getElementById("totalGainLbl");
  const customMicroInput = document.getElementById("customMicroInput");
  const customNote = document.getElementById("customNote");
  const microBackBtn = document.getElementById("microBackBtn");
  const errMicro = document.getElementById("errMicro");

  const toggleRealityBtn = document.getElementById("toggleRealityBtn");
  const realityBox = document.getElementById("realityBox");
  const realityChevron = document.getElementById("realityChevron");
  const earlierSlider = document.getElementById("earlierSlider");
  const earlierLbl = document.getElementById("earlierLbl");
  const targetAgeLbl = document.getElementById("targetAgeLbl");
  const targetMeta = document.getElementById("targetMeta");
  const needMonthlyLbl = document.getElementById("needMonthlyLbl");
  const needLumpLbl = document.getElementById("needLumpLbl");

  const assumBtn = document.getElementById("assumBtn");
  const modalBack = document.getElementById("modalBack");
  const closeModalBtn = document.getElementById("closeModalBtn");

  function setStep(step) {
    Object.values(sections).forEach(s=>s.classList.remove("active"));
    sections[step].classList.add("active");
    state.step = step;
    const map = { intro:0, age:20, numbers:40, result:60, micro:80, reality:100 };
    progressFill.style.width = (map[step] ?? 0) + "%";
    window.scrollTo({top:0, behavior:"instant"});
  }

  function getSelectedExtraMonthly() {
    let sum = 0;
    for (const opt of microOptions) if (state.microSelected.has(opt.id)) sum += opt.kr;
    sum += Math.max(0, Number.isFinite(state.microCustom) ? state.microCustom : 0);
    return sum;
  }

  function commitAge() {
    const v = parseDK(ageInput.value);
    const a = Math.round(v);
    if (!Number.isFinite(a) || a < 18 || a > 80) return false;
    state.age = a;
    state.pensionAge = estimatePensionAge(a);
    return true;
  }

  function commitNums() {
    const s = parseDK(savingsInput.value);
    const m = parseDK(monthlyInput.value);
    const inc = parseDK(incomeInput.value);
    if (!(Number.isFinite(s) && s >= 0)) return false;
    if (!(Number.isFinite(m) && m >= 0)) return false;
    if (!(Number.isFinite(inc) && inc > 0)) return false;
    state.savings = s;
    state.monthly = m;
    state.income = inc;
    return true;
  }

  function resetMicroState(){
    state.microSelected.clear();
    state.microCustom = 0;
    customMicroInput.value = "";
    realityBox.classList.remove("open");
    realityChevron.textContent = "‚ñæ";
    earlierSlider.value = "0";
  }

  function updateAgeCard() {
    const v = parseDK(ageInput.value);
    const a = Math.round(v);
    if (Number.isFinite(a) && a >= 18 && a <= 80) pensionAgeBig.textContent = estimatePensionAge(a);
    else pensionAgeBig.textContent = "‚Äî";
  }

  function updateRealityUI(){
    const ok = [state.age, state.pensionAge, state.savings, state.monthly, state.income, state.stopAge].every(v=>Number.isFinite(v));
    if (!ok){
      earlierSlider.max = "0";
      earlierSlider.value = "0";
      earlierLbl.textContent = "0 √•r";
      targetAgeLbl.textContent = "‚Äî";
      targetMeta.textContent = "‚Äî";
      needMonthlyLbl.textContent = "‚Äî";
      needLumpLbl.textContent = "‚Äî";
      return;
    }

    const maxEarlierRaw = state.stopAge - (state.age + 0.5);
    const maxEarlier = Math.max(0, Math.floor(maxEarlierRaw*2)/2);
    earlierSlider.max = String(maxEarlier);
    if (parseFloat(earlierSlider.value) > maxEarlier) earlierSlider.value = String(maxEarlier);

    const earlier = parseFloat(earlierSlider.value || "0") || 0;
    earlierLbl.textContent = `${earlier.toString().replace('.',',')} √•r`;
    const targetAge = state.stopAge - earlier;

    targetAgeLbl.textContent = `${targetAge.toString().replace('.',',')} √•r`;
    targetMeta.textContent = earlier > 0
      ? `ca. ${earlier.toString().replace('.',',')} √•r tidligere end dit nuv√¶rende resultat`
      : `v√¶lg et m√•l (0,5 √•r-trin)`;

    const baseMonthlyTotal = state.monthly + getSelectedExtraMonthly();

    if (earlier <= 0){
      needMonthlyLbl.textContent = "‚Äî";
      needLumpLbl.textContent = "‚Äî";
      return;
    }

    const req = invRequirementsAtTarget(targetAge, state, baseMonthlyTotal);
    if (!req.ok){
      needMonthlyLbl.textContent = "‚Äî";
      needLumpLbl.textContent = "‚Äî";
      return;
    }

    needMonthlyLbl.textContent = `+${fmtDK(req.extraMonthly)} kr./md`;
    needLumpLbl.textContent = `+${fmtDK(req.extraLump)} kr.`;
  }

  function updateResultUI() {
    const ok = [state.age, state.pensionAge, state.savings, state.monthly, state.income].every(v=>Number.isFinite(v));
    curAgeLbl.textContent = Number.isFinite(state.age) ? state.age : "‚Äî";
    pensionAgeLbl.textContent = Number.isFinite(state.pensionAge) ? state.pensionAge : "‚Äî";
    if (!ok) {
      state.stopAge = NaN;
      stopAgeBig.textContent="‚Äî"; gapText.textContent="‚Äî"; detailsText.textContent="‚Äî";
      updateRealityUI();
      return;
    }

    const extra = getSelectedExtraMonthly();
    const stop = solveStopAge(state.age, state.pensionAge, state.savings, state.monthly + extra, state.income);
    state.stopAge = stop;

    stopAgeBig.textContent = stop.toString().replace('.',',');
    gapText.textContent = yearsToGapText(state.pensionAge - stop, state.pensionAge);

    const fv = futureValue(state.savings, state.monthly + extra, Math.max(0, stop - state.age), 0.04);
    const need = bridgePV(state.income, Math.max(0, state.pensionAge - stop), 0.02, 0.10);
    detailsText.textContent =
      `Folkepension (estimat): ${state.pensionAge} √•r\n` +
      `Stop-alder (estimat): ${stop.toString().replace('.',',')} √•r\n` +
      `Bro-periode: ${(state.pensionAge-stop).toString().replace('.',',')} √•r\n\n` +
      `Kapital ved stop (estimat): ${fmtDK(fv)} kr.\n` +
      `M√•lkapital for bro (inkl. 10% buffer): ${fmtDK(need)} kr.\n` +
      `Ekstra investering fra mikrovalg: ${fmtDK(extra)} kr./md\n\n` +
      `Antagelser: 4% real (opsparing) ¬∑ 2% real (bro) ¬∑ 10% margin.`;

    updateRealityUI();
  }

  function gainIfAdd(extraMonthlyAdd, baseMonthly){
    const ok = [state.age, state.pensionAge, state.savings, state.income].every(v=>Number.isFinite(v));
    if (!ok) return NaN;
    const stopNow = solveStopAge(state.age, state.pensionAge, state.savings, baseMonthly, state.income);
    const stopWith = solveStopAge(state.age, state.pensionAge, state.savings, baseMonthly + extraMonthlyAdd, state.income);
    return (stopNow - stopWith);
  }

  function computeMicroBaseline(){
    state.microBaselineGain.clear();
    state.microEligible.clear();

    const ok = [state.age, state.pensionAge, state.savings, state.monthly, state.income].every(v=>Number.isFinite(v));
    if (!ok) return;

    const baseMonthly = state.monthly;
    for (const opt of microOptions){
      const gainYears = gainIfAdd(opt.kr, baseMonthly);
      state.microBaselineGain.set(opt.id, gainYears);
      if (Math.round(gainYears*365) >= 30) state.microEligible.add(opt.id);
    }

    // minimal custom to reach >= 1 month at baseline (binary search)
    const targetDays = 30;
    let lo = 0, hi = 20000;
    for (let i=0; i<18; i++){
      const mid = (lo+hi)/2;
      const g = gainIfAdd(mid, baseMonthly);
      const d = Math.round(g*365);
      if (d >= targetDays) hi = mid;
      else lo = mid;
    }
    state.microBaselineCustomMin = hi;
  }

  function renderMicroList() {
    microList.innerHTML = "";
    const ok = [state.age, state.pensionAge, state.savings, state.monthly, state.income].every(v=>Number.isFinite(v));
    if (!ok) { errMicro.classList.add("show"); return; }
    errMicro.classList.remove("show");

    const baseMonthly = state.monthly;
    const selectedExtra = getSelectedExtraMonthly();

    const stopNoMicro = solveStopAge(state.age, state.pensionAge, state.savings, baseMonthly, state.income);
    const stopWithMicro = solveStopAge(state.age, state.pensionAge, state.savings, baseMonthly + selectedExtra, state.income);
    totalGainLbl.textContent = microGainLabel(stopNoMicro - stopWithMicro);

    // Custom micro: only counts if baseline >= 1 month
    const customVal = parseDK(customMicroInput.value);
    const custom = Number.isFinite(customVal) ? Math.max(0, customVal) : 0;

    if (custom > 0){
      const gainBaseline = gainIfAdd(custom, baseMonthly);
      if (Math.round(gainBaseline*365) < 30){
        state.microCustom = 0;
        const min = Number.isFinite(state.microBaselineCustomMin) ? fmtDK(state.microBaselineCustomMin) : "‚Äî";
        customNote.textContent = `Bel√∏bet giver under 1 m√•ned effekt (baseline). Pr√∏v ca. ${min} kr./md eller mere.`;
      } else {
        state.microCustom = custom;
        customNote.textContent = "Tilf√∏jet (baseline ‚â• 1 m√•ned).";
      }
    } else {
      state.microCustom = 0;
      customNote.textContent = "Tilf√∏jes, hvis det giver mindst 1 m√•ned effekt (baseline).";
    }

    // Eligible list: selected first, then by baseline gain desc
    const eligible = microOptions.filter(o => state.microEligible.has(o.id));
    eligible.sort((a,b)=>{
      const as = state.microSelected.has(a.id) ? 1 : 0;
      const bs = state.microSelected.has(b.id) ? 1 : 0;
      if (as !== bs) return bs - as;
      const ga = state.microBaselineGain.get(a.id) ?? 0;
      const gb = state.microBaselineGain.get(b.id) ?? 0;
      return gb - ga;
    });

    for (const opt of eligible) {
      const nowGain = gainIfAdd(opt.kr, baseMonthly + getSelectedExtraMonthly());
      const item = document.createElement("div");
      item.className = "microItem" + (state.microSelected.has(opt.id) ? " selected" : "");
      item.setAttribute("role","button");
      item.tabIndex = 0;

      item.innerHTML = `
        <div class="microLeft">
          <div class="emoji" aria-hidden="true">${opt.emoji}</div>
          <div style="min-width:0">
            <div class="microName">${opt.name}</div>
          </div>
        </div>
        <div class="microRight">
          <div class="microGain mono">${microGainLabel(nowGain)}</div>
          <div class="microCost mono">${fmtDK(opt.kr)} kr./md</div>
        </div>
      `;

      const toggle = () => {
        if (state.microSelected.has(opt.id)) state.microSelected.delete(opt.id);
        else state.microSelected.add(opt.id);
        renderMicroList();
        updateResultUI();
        updateRealityUI();
      };

      item.addEventListener("click", toggle, {passive:true});
      item.addEventListener("keydown", (e)=>{ if (e.key==="Enter"||e.key===" ") { e.preventDefault(); toggle(); }});
      microList.appendChild(item);
    }

    updateResultUI();
    updateRealityUI();
  }

  const onClick = (el, fn) => el.addEventListener("click", (e)=>{ e.preventDefault(); fn(e); });

  onClick(startBtn, ()=> setStep("age"));
  onClick(demoBtn, ()=> { ageInput.value="46"; 
  const toRealityBtn = document.getElementById("toRealityBtn");
  const realityBackBtn = document.getElementById("realityBackBtn");
  sections.reality = document.getElementById("s_reality");

  function enterReality(){
    setStep("reality");
    updateRealityUI();
  }

  toRealityBtn && toRealityBtn.addEventListener("click", enterReality);
  realityBackBtn && realityBackBtn.addEventListener("click", ()=> setStep("result"));

  updateAgeCard(); });

  ageInput.addEventListener("input", updateAgeCard);

  onClick(ageNextBtn, ()=> {
    errAge.classList.remove("show");
    if (!commitAge()) { errAge.classList.add("show"); return; }
    updateResultUI();
    setStep("numbers");
  });

  onClick(numsBackBtn, ()=> setStep("age"));

  onClick(resetNumsBtn, ()=> {
    savingsInput.value=""; monthlyInput.value=""; incomeInput.value="";
    resetMicroState();
  });

  onClick(numsNextBtn, ()=> {
    errNums.classList.remove("show");
    if (!commitAge()) { setStep("age"); errAge.classList.add("show"); return; }
    if (!commitNums()) { errNums.classList.add("show"); return; }
    resetMicroState();
    updateResultUI();
    setStep("result");
  });

  onClick(toggleDetailsBtn, ()=> {
    const open = detailsBox.classList.toggle("open");
    toggleDetailsBtn.textContent = open ? "Skjul beregningsdetaljer" : "Se beregningsdetaljer";
  });

  onClick(toggleRealityBtn, ()=> {
    const open = realityBox.classList.toggle("open");
    realityChevron.textContent = open ? "‚ñ¥" : "‚ñæ";
    if (open) {
      earlierSlider.value = "0";
      updateRealityUI();
    }
  });

  earlierSlider.addEventListener("input", updateRealityUI);

  onClick(resBackBtn, ()=> setStep("numbers"));

  onClick(startOverBtn, ()=> {
    state.visitedMicro = false;
    state.age=NaN; state.pensionAge=NaN; state.savings=NaN; state.monthly=NaN; state.income=NaN; state.stopAge=NaN;
    state.microBaselineGain.clear();
    state.microEligible.clear();
    state.microBaselineCustomMin = NaN;

    resetMicroState();

    ageInput.value=""; pensionAgeBig.textContent="‚Äî";
    savingsInput.value=""; monthlyInput.value=""; incomeInput.value="";

    detailsBox.classList.remove("open");
    toggleDetailsBtn.textContent="Se beregningsdetaljer";

    errAge.classList.remove("show"); errNums.classList.remove("show"); errMicro.classList.remove("show");
    setStep("intro");
  });

  function enterMicro(){
    const ok = [state.age, state.pensionAge, state.savings, state.monthly, state.income].every(v=>Number.isFinite(v));
    if (!ok) { setStep("numbers"); errNums.classList.add("show"); return; }
    state.visitedMicro = true;
    computeMicroBaseline();
    renderMicroList();
    setStep("micro");
  }

  onClick(toMicroBtn, enterMicro);
  onClick(findMoreCardBtn, enterMicro);

  customMicroInput.addEventListener("input", renderMicroList);

  onClick(microBackBtn, ()=> setStep("result"));

  onClick(assumBtn, ()=> modalBack.classList.add("open"));
  onClick(closeModalBtn, ()=> modalBack.classList.remove("open"));
  modalBack.addEventListener("click", (e)=>{ if (e.target===modalBack) modalBack.classList.remove("open"); });

  
  const toRealityBtn = document.getElementById("toRealityBtn");
  const realityBackBtn = document.getElementById("realityBackBtn");
  sections.reality = document.getElementById("s_reality");

  function enterReality(){
    setStep("reality");
    updateRealityUI();
  }

  toRealityBtn && toRealityBtn.addEventListener("click", enterReality);
  realityBackBtn && realityBackBtn.addEventListener("click", ()=> setStep("result"));

  updateAgeCard();
  updateResultUI();
})();
</script>
</body>
</html>
