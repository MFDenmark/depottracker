<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Tidsl√∏ft ¬∑ v8.0.0</title>
<style>
:root{
  --bg1:#f4f8ff; --bg2:#e9f1ff; --card:#ffffff;
  --text:#0b1220; --muted:#566b85; --line:#e6edf7;
  --blue:#3b82f6; --blue2:#1e40af; --teal:#06b6d4;
  --shadow2:0 18px 45px rgba(10,30,70,.10);
  --shadow:0 26px 70px rgba(10,30,70,.14);
  --radius:26px;
}
*{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
html,body{height:100%;}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  color:var(--text);
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
}
.app{max-width:860px;margin:0 auto;padding:18px 14px 30px;}
.header{
  position:sticky; top:0; z-index:60;
  padding:10px 12px 12px;
  /* iOS Safari: sticky + translucency can show content ‚Äúthrough‚Äù the header. */
  background:rgba(244,248,255,1);
  border:1px solid rgba(230,237,247,.95);
  border-radius:18px;
  box-shadow:0 10px 26px rgba(10,30,70,.08);
}
.toprow{display:flex;align-items:center;justify-content:space-between;gap:12px;}
.brand{display:flex;align-items:flex-start;gap:10px;min-width:0;}
.dot{width:12px;height:12px;border-radius:50%;background:var(--teal);margin-top:6px;flex:0 0 auto;}
.brand h1{margin:0;font-size:20px;letter-spacing:.2px;line-height:1.1;}
.brand .sub{margin:2px 0 0;color:var(--muted);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.pillbtn{border:1px solid var(--line);background:rgba(255,255,255,.92);padding:10px 14px;border-radius:999px;font-weight:1000;color:var(--text);cursor:pointer;}
.progressWrap{margin-top:10px;}
.progressBar{height:8px;border-radius:999px;background:rgba(230,237,247,.9);overflow:hidden;}
.progressFill{height:100%;width:0%;background:linear-gradient(90deg,var(--blue),var(--teal));border-radius:999px;transition:width .25s ease;}

.card{background:var(--card);border:1px solid rgba(230,237,247,.9);border-radius:var(--radius);box-shadow:var(--shadow2);}
.section{display:none;opacity:0;transform:translateY(6px);padding-top:10px;}
.section.active{display:block;animation:fadeUp .26s ease forwards;}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}

.hero{padding:22px 20px;margin-top:14px;}
.kicker{letter-spacing:.16em;font-weight:1100;font-size:12px;color:var(--muted);}
.huge{margin:10px 0 10px;font-size:44px;line-height:1.0;letter-spacing:-.03em;}
.p{margin:0;color:var(--muted);font-size:18px;line-height:1.45;}
.small{font-size:13px;color:var(--muted);line-height:1.35;}
.mono{font-variant-numeric:tabular-nums;}

.ctaPrimary{
  width:100%;border:0;cursor:pointer;padding:16px 18px;border-radius:999px;
  font-size:16px;font-weight:1150;color:#fff;background:linear-gradient(90deg,var(--blue),var(--blue2));
  box-shadow:0 14px 28px rgba(30,64,175,.22);
}
.ctaPrimary:active{transform:translateY(1px);}
.ctaSecondary{
  width:100%;border:1px solid rgba(59,130,246,.22);cursor:pointer;padding:14px 14px;border-radius:18px;
  font-size:16px;font-weight:1150;background:rgba(59,130,246,.06);color:var(--text);
}
.ctaSecondary span{color:var(--muted);font-weight:1000;}
.linkBtn{border:0;background:transparent;color:var(--muted);font-weight:1100;padding:8px 4px;cursor:pointer;}
.btnRow{display:flex;gap:12px;margin-top:16px;}
.btn{flex:1;border:1px solid var(--line);background:rgba(255,255,255,.9);padding:14px 14px;border-radius:18px;font-weight:1100;font-size:16px;cursor:pointer;}
.btn.primary{border:0;color:#fff;background:linear-gradient(90deg,var(--blue),var(--blue2));}
.btn.ghost{background:rgba(255,255,255,.75);}
.hr{height:1px;background:rgba(230,237,247,.9);margin:14px 0;}
.formCard{padding:18px 16px;margin-top:14px;}
.stepTitle{font-size:38px;margin:4px 0 6px;letter-spacing:-.02em;}
.stepMeta{color:var(--muted);margin:0 0 14px;font-size:16px;line-height:1.35;}
.err{display:none;margin-top:10px;padding:10px 12px;border-radius:16px;background:rgba(180,35,24,.08);border:1px solid rgba(180,35,24,.22);color:#7a1c12;font-weight:1000;}
.err.show{display:block;}

.label{font-weight:1000;color:var(--muted);margin:14px 2px 8px;display:flex;align-items:center;gap:10px;justify-content:space-between;}
.label .lblText{display:flex;align-items:center;gap:10px;}
.helpBtn{flex:0 0 auto;width:28px;height:28px;border-radius:999px;border:1px solid rgba(59,130,246,.22);background:rgba(59,130,246,.06);color:var(--muted);font-weight:1200;cursor:pointer;}
.helpBtn:active{transform:translateY(1px);}
.helpBox{display:none;margin-top:8px;padding:10px 12px;border-radius:16px;border:1px solid rgba(230,237,247,.9);background:rgba(244,248,255,.65);color:var(--muted);font-size:13px;line-height:1.4;font-weight:900;}
.helpBox.open{display:block;}
.warnBox{display:none;margin-top:8px;padding:10px 12px;border-radius:16px;border:1px solid rgba(180,120,10,.25);background:rgba(255,245,225,.75);color:rgba(120,80,10,1);font-size:13px;line-height:1.4;font-weight:1000;}
.warnBox.show{display:block;}

.input{
  width:100%;font-size:34px;font-weight:1100;letter-spacing:.5px;padding:18px 16px;border-radius:20px;
  border:1px solid rgba(230,237,247,.9);outline:none;background:rgba(255,255,255,.95);
}
.input.smallInput{font-size:18px;font-weight:900;padding:14px 14px;border-radius:16px;}
.input:focus{border-color:rgba(59,130,246,.55);box-shadow:0 0 0 4px rgba(59,130,246,.12);}

.resultWrap{padding:16px 14px;margin-top:14px;}
.resultPill{display:flex;justify-content:space-between;gap:10px;padding:10px 12px;border-radius:18px;background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.20);font-weight:1100;}
.resultPill span{color:var(--muted);font-weight:1000;}
.bigNum{font-size:78px;font-weight:1250;letter-spacing:-.05em;margin:8px 0 0;text-align:center;}
.center{text-align:center;}
.subStrong{font-size:22px;font-weight:1150;margin:2px 0 6px;}

.details{display:none;margin-top:12px;}
.details.open{display:block;}
.infoCard{margin-top:12px;padding:12px 12px;border-radius:18px;border:1px solid rgba(230,237,247,.9);background:rgba(244,248,255,.65);color:var(--muted);font-weight:900;line-height:1.35;}

.microSticky{
  position:sticky;top:88px;z-index:40;margin-top:12px;padding:12px 12px;
  background:rgba(255,255,255,.95);border:1px solid rgba(230,237,247,.9);
  border-radius:22px;box-shadow:var(--shadow2);
}
.microSticky .line1{display:flex;justify-content:space-between;gap:10px;align-items:center;}
.microSticky .ttl{font-weight:1200;letter-spacing:-.01em;}
.microSticky .gain{font-weight:1200;color:var(--blue2);}
.microList{margin-top:12px;display:flex;flex-direction:column;gap:12px;}
.microItem{
  display:flex;justify-content:space-between;gap:12px;align-items:flex-start;
  padding:14px 14px;border-radius:22px;border:1px solid rgba(230,237,247,.9);
  background:rgba(255,255,255,.92);cursor:pointer;
  transition:transform .16s ease, background .16s ease, border-color .16s ease;
}
.microItem:hover{transform:translateY(-1px);}
.microItem.selected{border-color:rgba(59,130,246,.55);background:rgba(59,130,246,.08);transform:translateY(-2px);}
.microLeft{display:flex;gap:12px;align-items:flex-start;min-width:0;}
.emoji{font-size:22px;width:28px;text-align:center;margin-top:2px;}
.microName{font-weight:1200;font-size:18px;white-space:normal;line-height:1.15;}
.microRight{text-align:right;}
.microGain{font-weight:1200;color:var(--blue2);line-height:1.05;}
.microCost{font-weight:1100;color:var(--muted);}
.tagBadge{display:inline-flex;align-items:center;font-size:11px;font-weight:1100;padding:4px 8px;border-radius:999px;border:1px solid rgba(59,130,246,.20);background:rgba(59,130,246,.06);color:var(--muted);margin-top:8px;}

.sliderRow{display:flex;align-items:center;gap:12px;margin-top:10px;}
.sliderRow input[type="range"]{width:100%;}
.rcBig{font-size:42px;font-weight:1200;letter-spacing:-.03em;margin:8px 0 0;}
.rcLine{display:flex;justify-content:space-between;gap:10px;align-items:baseline;margin-top:10px;}
.rcLine .lbl{color:var(--muted);font-weight:1100;}
.rcLine .val{font-weight:1200;}
.rcHint{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.35;}

.modalBack{position:fixed;inset:0;background:rgba(10,18,32,.40);display:none;align-items:flex-end;justify-content:center;z-index:200;}
.modalBack.open{display:flex;}
.modal{
  width:min(860px,100%);border-radius:22px 22px 0 0;background:#fff;
  border:1px solid rgba(230,237,247,.9);padding:16px 16px 22px;box-shadow:var(--shadow);
  animation:slideUp .18s ease;
}
@keyframes slideUp{from{transform:translateY(12px);opacity:.7;}to{transform:translateY(0);opacity:1;}}
.modal h3{margin:0 0 8px;font-size:18px;}
.modal ul{margin:8px 0 0;padding-left:18px;color:var(--muted);line-height:1.45;}
.modal .closeRow{display:flex;justify-content:flex-end;margin-top:14px;}

.checkRow{display:flex;gap:10px;align-items:flex-start;margin-top:12px;}
.checkRow input{margin-top:4px;}
.previewBox{
  margin-top:10px;padding:12px 12px;border-radius:16px;border:1px solid rgba(230,237,247,.9);
  background:rgba(244,248,255,.60);color:var(--muted);font-size:12px;line-height:1.4;
  white-space:pre-wrap;word-break:break-word;
}
.badge{
  display:inline-flex; align-items:center; gap:8px;
  font-size:12px; font-weight:1100;
  padding:6px 10px; border-radius:999px;
  border:1px solid rgba(59,130,246,.22);
  background:rgba(59,130,246,.06);
  color:var(--muted);
}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="toprow">
      <div class="brand">
        <div class="dot" aria-hidden="true"></div>
        <div style="min-width:0">
          <h1>Tidsl√∏ft</h1>
          <div class="sub">Sm√• valg. Store l√∏ft. ¬∑ <span class="mono">v8.0.0</span> ¬∑ <span class="badge">REBUILD</span></div>
        </div>
      </div>
      <button class="pillbtn" id="assumBtn" type="button">Foruds√¶tninger</button>
    </div>
    <div class="progressWrap">
      <div class="progressBar" aria-hidden="true"><div class="progressFill" id="progressFill"></div></div>
    </div>
  </div>

  <!-- INTRO -->
  <section class="section active" id="step_intro">
    <div class="card hero">
      <div class="kicker">MULIGHEDEN</div>
      <div class="huge">√ònsker du f√¶rre<br/>√•r p√• arbejdsmarkedet?</div>
      <p class="p">Se dit frihedspotentiale ‚Äì baseret p√• dine egne tal. Sm√• justeringer kan flytte mere, end man tror.</p>
      <div style="height:16px"></div>
      <button class="ctaPrimary" id="startBtn" type="button">Tag dit Tidsl√∏ft ‚Äì gratis</button>
      <div class="hr"></div>
      <div class="small">Vi regner forsigtigt for at give et robust estimat. Skat og eksisterende pensioner indg√•r ikke.</div>
    </div>
  </section>

  <!-- AGE -->
  <section class="section" id="step_age">
    <div class="card formCard">
      <div class="kicker">TRIN 1/5</div>
      <div class="stepTitle">Din alder</div>
      <p class="stepMeta">Vi estimerer din folkepensionsalder ud fra din alder.</p>

      <div class="label">
        <div class="lblText">Alder</div>
        <button class="helpBtn" id="helpAgeBtn" type="button" aria-label="Hj√¶lp">?</button>
      </div>
      <div class="helpBox" id="helpAgeBox">Indtast din alder i hele √•r. Vi bruger den til at estimere din folkepensionsalder (vedtaget niveau, maks. 70 √•r).</div>
      <input class="input" id="ageInput" inputmode="numeric" pattern="[0-9]*" placeholder="fx 46"/>

      <div class="card" style="margin-top:14px; padding:14px 14px;">
        <div class="kicker">FOLKEPENSION (ESTIMAT)</div>
        <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px;">
          <div style="font-size:64px; font-weight:1200; letter-spacing:-.04em;" class="mono" id="pensionAgeBig">‚Äî</div>
          <div class="small" style="text-align:right;">√•r</div>
        </div>
      </div>

      <div class="err" id="errAge">Indtast en gyldig alder (18‚Äì80).</div>

      <div class="btnRow">
        <button class="btn primary" id="ageNextBtn" type="button">Forts√¶t</button>
        <button class="btn ghost" id="demoBtn" type="button">Demo</button>
      </div>
    </div>
  </section>

  <!-- NUMBERS -->
  <section class="section" id="step_numbers">
    <div class="card formCard">
      <div class="kicker">TRIN 2/5</div>
      <div class="stepTitle">Dine tal</div>
      <p class="stepMeta">Felterne har kun forslag (ikke forudfyldte v√¶rdier). Du kan altid justere senere.</p>

      <div class="label">
        <div class="lblText">Opsparing i dag (kr.)</div>
        <button class="helpBtn" id="helpSavingsBtn" type="button" aria-label="Hj√¶lp">?</button>
      </div>
      <div class="helpBox" id="helpSavingsBox">Medtag frie midler du kan bruge til at stoppe tidligere (konto, depot, kontanter). Medtag ikke bundne pensioner, hvis de ikke kan bruges f√∏r folkepension.</div>
      <input class="input" id="savingsInput" inputmode="numeric" placeholder="fx 25.000"/>

      <div class="label">
        <div class="lblText">M√•nedlig investering (kr./md)</div>
        <button class="helpBtn" id="helpMonthlyBtn" type="button" aria-label="Hj√¶lp">?</button>
      </div>
      <div class="helpBox" id="helpMonthlyBox">Det bel√∏b du realistisk kan investere hver m√•ned frem til stop. Brug et bel√∏b du kan holde over tid.</div>
      <input class="input" id="monthlyInput" inputmode="numeric" placeholder="fx 3.500"/>

      <div class="label">
        <div class="lblText">√ònsket m√•nedlig indkomst f√∏r folkepension (kr./md)</div>
        <button class="helpBtn" id="helpIncomeBtn" type="button" aria-label="Hj√¶lp">?</button>
      </div>
      <div class="helpBox" id="helpIncomeBox">Dit m√•nedlige behov i perioden fra stop til folkepension (t√¶nk ‚Äúforbrug‚Äù, ikke l√∏n). Hvis du er i tvivl, kan 70‚Äì85% af din nuv√¶rende l√∏n v√¶re et startpunkt.</div>
      <input class="input" id="incomeInput" inputmode="numeric" placeholder="fx 35.000"/>
      <div class="warnBox" id="incomeWarn">‚Äî</div>
      <div class="small" style="margin-top:8px;">Vi regner uden skat for gennemsigtighed. V√¶lg et bel√∏b du vil kunne leve for i stop‚Üífolkepension-perioden.</div>

      <div class="err" id="errNums">Udfyld felterne med tal. Indkomst skal v√¶re &gt; 0.</div>

      <div class="btnRow">
        <button class="btn" id="numsBackBtn" type="button">Tilbage</button>
        <button class="btn primary" id="numsNextBtn" type="button">Se mit potentiale</button>
      </div>
      <div class="btnRow" style="margin-top:10px;">
        <button class="btn ghost" id="resetNumsBtn" type="button">Nulstil tal</button>
      </div>
    </div>
  </section>

  <!-- RESULT -->
  <section class="section" id="step_result">
    <div class="card resultWrap">
      <div class="kicker">TRIN 3/5</div>
      <div class="stepTitle">Dit potentiale</div>
      <p class="stepMeta" id="resultMeta">Baseret p√• dine tal lige nu.</p>

      <div class="card" style="padding:14px 14px;">
        <div class="resultPill">
          <div>Din alder: <span class="mono" id="curAgeLbl">‚Äî</span></div>
          <div>Folkepension: <span class="mono" id="pensionAgeLbl">‚Äî</span></div>
        </div>

        <div class="bigNum mono" id="stopAgeBig">‚Äî</div>
        <div class="center">
          <div class="subStrong">din mulige stop-alder</div>
          <div class="p" style="margin-top:0;" id="gapText">‚Äî</div>
        </div>

        <!-- CTA area (rendered by state machine) -->
        <div style="height:14px"></div>
        <div id="resultCtas"></div>

        <div style="height:10px"></div>
        <button class="btn" id="toggleDetailsBtn" type="button">Se beregningsgrundlag</button>
        <div class="details" id="detailsBox">
          <div class="card" style="margin-top:12px; padding:14px 14px;">
            <div class="small mono" id="detailsText">‚Äî</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="btnRow">
          <button class="btn" id="resBackBtn" type="button">Tilbage</button>
          <button class="linkBtn" id="startOverBtn" type="button">Start forfra</button>
        </div>
      </div>
    </div>
  </section>

  <!-- MICRO -->
  <section class="section" id="step_micro">
    <div class="card formCard">
      <div class="kicker">TRIN 4/5</div>
      <div class="stepTitle">Sm√• frihedsl√∏ft</div>
      <p class="stepMeta">V√¶lg konkrete greb. Effekten vises som potentiale, hvis du kan frig√∏re bel√∏bet.</p>

      <div class="microSticky">
        <div class="line1">
          <div class="ttl">Samlet frihedsl√∏ft</div>
          <div class="gain mono" id="totalGainLbl">‚Äî</div>
        </div>
        <div class="small" style="margin-top:6px;">
          Vi viser kun greb, der giver mindst <strong>1 m√•ned</strong> effekt (baseline).
        </div>
      </div>

      <div id="microInfo"></div>
      <div class="microList" id="microList"></div>

      <div class="label">
        <div class="lblText">Eget frihedsl√∏ft (ekstra kr./md)</div>
        <button class="helpBtn" id="helpCustomBtn" type="button" aria-label="Hj√¶lp">?</button>
      </div>
      <div class="helpBox" id="helpCustomBox">Hvis du vil teste et eget bel√∏b: vi tilf√∏jer det kun, hvis det giver ‚â• 1 m√•ned effekt (baseline).</div>
      <input class="input" id="customMicroInput" inputmode="numeric" placeholder="fx 300"/>
      <div class="small" id="customNote" style="margin-top:8px;">Tilf√∏jes, hvis det giver mindst 1 m√•ned effekt (baseline).</div>

      <div class="err" id="errMicro">Der er ikke nok data til at beregne effekten. G√• tilbage og udfyld dine tal.</div>

      <div class="btnRow">
        <button class="btn" id="microBackBtn" type="button">Tilbage</button>
        <button class="btn primary" id="microDoneBtn" type="button">Opdat√©r mit potentiale</button>
      </div>
    </div>
  </section>

  <!-- REALITY -->
  <section class="section" id="step_reality">
    <div class="card formCard">
      <div class="kicker">TRIN 5/5</div>
      <div class="stepTitle">Se hvad der skal til</div>
      <p class="stepMeta">V√¶lg et m√•l. Vi viser det ekstra l√∏ft, der kan bringe dig derhen.</p>

      <div class="sliderRow">
        <input id="earlierSlider" type="range" min="0" max="0" step="0.5" value="0" />
        <div class="mono" style="min-width:86px; text-align:right; font-weight:1200;" id="earlierLbl">0 √•r</div>
      </div>

      <div class="rcBig mono" id="targetAgeLbl">‚Äî</div>
      <div class="small" id="targetMeta">‚Äî</div>

      <div class="hr"></div>

      <div class="rcLine">
        <div class="lbl">Ekstra l√∏ft pr. m√•ned</div>
        <div class="val mono" id="needMonthlyLbl">‚Äî</div>
      </div>
      <div class="rcLine">
        <div class="lbl">Alternativ: ekstra startkapital</div>
        <div class="val mono" id="needLumpLbl">‚Äî</div>
      </div>

      <div style="height:14px"></div>
      <div id="realityCtas"></div>

      <div class="rcHint">Model: 4% real (opsparing) ¬∑ 2% real (overgang) ¬∑ 10% buffer. Skat og eksisterende pensioner indg√•r ikke.</div>

      <div class="btnRow">
        <button class="btn" id="realityBackBtn" type="button">Tilbage</button>
      </div>
    </div>
  </section>
</div>

<!-- Assumptions modal -->
<div class="modalBack" id="modalBack" role="dialog" aria-modal="true" aria-label="Foruds√¶tninger">
  <div class="modal">
    <h3>Foruds√¶tninger</h3>
    <ul>
      <li><strong>Folkepensionsalder</strong>: Estimat ud fra din alder (kan afvige op til ca. 1 √•r pga. f√∏dselsdato). Vi bruger vedtaget folkepensionsalder og regner ikke med forh√∏jelser over senest vedtagne niveau (maks. 70 √•r).</li>
      <li><strong>Opsparing f√∏r stop</strong>: 4% real √•rligt.</li>
      <li><strong>Overgang (stop ‚Üí folkepension)</strong>: 2% real diskontering + 10% buffer.</li>
      <li><strong>Skat og eksisterende pensioner</strong>: Ikke med i modellen.</li>
    </ul>
    <div class="closeRow">
      <button class="btn primary" id="closeModalBtn" type="button">Luk</button>
    </div>
  </div>
</div>

<!-- Lead modal -->
<div class="modalBack" id="leadBack" role="dialog" aria-modal="true" aria-label="Formidl kontakt">
  <div class="modal">
    <h3>Formidl kontakt til r√•dgiver</h3>
    <div class="small">Du bliver kun kontaktet, hvis du giver samtykke og sender formularen.</div>

    <div class="hr"></div>

    <div id="leadStepA">
      <div class="kicker">KONTAKT</div>

      <div class="label"><div class="lblText">Navn</div></div>
      <input class="input smallInput" id="leadName" autocomplete="name" placeholder="Dit navn"/>

      <div class="label"><div class="lblText">E-mail</div></div>
      <input class="input smallInput" id="leadEmail" inputmode="email" autocomplete="email" placeholder="navn@eksempel.dk"/>

      <div class="label"><div class="lblText">Telefon</div></div>
      <input class="input smallInput" id="leadPhone" inputmode="tel" autocomplete="tel" placeholder="+45 ‚Ä¶"/>

      <div class="checkRow">
        <input type="checkbox" id="leadConsent"/>
        <label for="leadConsent" class="small">
          Jeg √∏nsker at blive kontaktet af en r√•dgiver vedr√∏rende mine beregninger. Oplysninger bruges kun til dette form√•l.
        </label>
      </div>

      <div class="err" id="leadErrA">Udfyld navn, e-mail og telefon, og giv samtykke.</div>

      <div class="btnRow">
        <button class="btn" id="closeLeadBtn" type="button">Annull√©r</button>
        <button class="btn primary" id="leadNextBtn" type="button">Forts√¶t</button>
      </div>

      <div style="margin-top:10px;">
        <button class="linkBtn" id="privacyBtn" type="button">Privatliv og samtykke</button>
      </div>
    </div>

    <div id="leadStepB" style="display:none;">
      <div class="kicker">DELING</div>

      <div class="checkRow">
        <input type="checkbox" id="shareScenario" checked/>
        <label for="shareScenario" class="small">
          Del mine beregninger med r√•dgiver (anbefalet). Det sparer tid og giver et bedre svar.
        </label>
      </div>

      <div class="small" style="margin-top:10px;">Hvis du deler, sendes f√∏lgende:</div>
      <div class="previewBox" id="scenarioPreview">‚Äî</div>

      <div class="err" id="leadErrB">Der opstod en teknisk fejl. Pr√∏v igen.</div>

      <div class="btnRow">
        <button class="btn" id="leadBackBtn" type="button">Tilbage</button>
        <button class="btn primary" id="leadSubmitBtn" type="button">Send</button>
      </div>

      <div style="margin-top:10px;">
        <button class="linkBtn" id="privacyBtn2" type="button">Privatliv og samtykke</button>
      </div>
    </div>

    <div id="leadThanks" style="display:none;">
      <div class="kicker">KVITTERING</div>
      <div style="margin-top:10px; font-weight:1100;">Tak. Din foresp√∏rgsel er registreret.</div>
      <div class="small" style="margin-top:8px;">Demo-mode: Ingen data er sendt eksternt endnu. Payload kan ses herunder.</div>
      <div class="previewBox" id="leadPayloadPreview">‚Äî</div>

      <div class="btnRow">
        <button class="btn primary" id="leadDoneBtn" type="button">Luk</button>
      </div>
    </div>
  </div>
</div>

<!-- Privacy modal -->
<div class="modalBack" id="privacyBack" role="dialog" aria-modal="true" aria-label="Privatliv">
  <div class="modal">
    <h3>Privatliv og samtykke</h3>
    <ul>
      <li><strong>Form√•l</strong>: At formidle kontakt til en r√•dgiver efter dit √∏nske.</li>
      <li><strong>Retsgrundlag</strong>: Samtykke (du v√¶lger aktivt at sende).</li>
      <li><strong>Data</strong>: Kontaktoplysninger + (valgfrit) beregningsresum√©, pr√¶cist vist f√∏r afsendelse.</li>
      <li><strong>Deling</strong>: Oplysninger videregives kun, hvis du sender formularen.</li>
      <li><strong>Opbevaring</strong>: I demo-mode gemmes payload lokalt i din browser (localStorage) til test.</li>
      <li><strong>Dine rettigheder</strong>: Du kan til enhver tid undlade at sende eller stoppe processen.</li>
    </ul>
    <div class="closeRow">
      <button class="btn primary" id="closePrivacyBtn" type="button">Luk</button>
    </div>
  </div>
</div>

<script>
(() => {
  "use strict";

  // =========================
  // Config
  // =========================
  const APP_VERSION = "8.0.0";
  const LEAD_ENDPOINT = null; // inds√¶t URL senere (serverless endpoint)

  // =========================
  // Utils
  // =========================
  const fmtDK = (n)=> {
    if (!Number.isFinite(n)) return "‚Äî";
    const s = Math.round(n).toString();
    return s.replace(/\B(?=(\d{3})+(?!\d))/g,'.');
  };
  const parseDK = (s)=>{
    if (s === null || s === undefined) return NaN;
    const raw = String(s).trim();
    if (raw === "") return NaN;
    const cleaned = raw.replace(/\./g,'').replace(/\s/g,'').replace(/,/g,'.');
    const v = Number(cleaned);
    return Number.isFinite(v) ? v : NaN;
  };
  const isoNow = ()=> new Date().toISOString();
  const qs = (id)=> document.getElementById(id);

  function toggleHelp(btnId, boxId){
    const btn = qs(btnId);
    const box = qs(boxId);
    if (!btn || !box) return;
    btn.addEventListener("click", ()=> box.classList.toggle("open"), {passive:true});
  }

  // =========================
  // Model (deterministic)
  // =========================
  function pensionAgeByBirthYearApprox(birthYear){
    if (birthYear <= 1962) return 67;
    if (birthYear <= 1966) return 68;
    if (birthYear <= 1970) return 69;
    return 70;
  }
  function estimatePensionAgeFromAge(currentAge){
    const y = new Date().getFullYear();
    const by1 = y - currentAge;
    const by2 = y - currentAge - 1;
    const p1 = pensionAgeByBirthYearApprox(by1);
    const p2 = pensionAgeByBirthYearApprox(by2);
    return Math.min(70, Math.max(p1, p2));
  }
  function futureValue(savings, monthly, years, rAnnual=0.04){
    if (years <= 0) return savings;
    const r = rAnnual/12;
    const n = Math.round(years*12);
    const growth = Math.pow(1+r, n);
    const fvLump = savings * growth;
    const fvAnn = monthly * ((growth - 1)/r);
    return fvLump + fvAnn;
  }
  function bridgePV(monthlyIncome, years, rAnnual=0.02, buffer=0.10){
    const n = Math.max(0, years);
    if (n === 0) return 0;
    const r = rAnnual;
    let pv;
    if (r === 0) pv = monthlyIncome*12*n;
    else pv = monthlyIncome*12 * (1 - Math.pow(1+r, -n)) / r;
    return pv * (1+buffer);
  }
  function solveStopAge(age, pensionAge, savings, monthlyTotal, income){
    let best = NaN;
    for (let a=age; a<=pensionAge; a+=0.5){
      const t = a - age;
      const fv = futureValue(savings, monthlyTotal, t, 0.04);
      const need = bridgePV(income, pensionAge - a, 0.02, 0.10);
      if (fv >= need){ best = a; break; }
    }
    if (!Number.isFinite(best)) best = pensionAge;
    return best;
  }
  function inverseNeedAtTarget(targetAge, st, monthlyTotal){
    const r = 0.04/12;
    const years = targetAge - st.age;
    if (!(years > 0)) return { ok:false };
    const n = Math.round(years*12);
    const growth = Math.pow(1+r, n);

    const need = bridgePV(st.income, Math.max(0, st.pensionAge - targetAge), 0.02, 0.10);
    const fvLump = st.savings * growth;
    const fvAnn = monthlyTotal * ((growth - 1)/r);
    const fvCurrent = fvLump + fvAnn;

    let extraMonthly = 0;
    if (need > fvCurrent){
      const totalMonthlyReq = (need - fvLump) * r / (growth - 1);
      extraMonthly = Math.max(0, totalMonthlyReq - monthlyTotal);
    }

    let extraLump = 0;
    const needMinusAnn = need - fvAnn;
    if (needMinusAnn > fvLump){
      const totalLumpReq = needMinusAnn / growth;
      extraLump = Math.max(0, totalLumpReq - st.savings);
    }
    return { ok:true, extraMonthly, extraLump };
  }

  // =========================
  // State
  // =========================
  const state = {
    step: "intro",
    age: NaN,
    pensionAge: NaN,
    savings: NaN,
    monthly: NaN,
    income: NaN,

    microSelected: new Set(),
    microCustom: 0,
    microApplied: false,

    microBaselineGain: new Map(),
    microEligible: new Set(),
    microBaselineCustomMin: NaN,

    stopAge: NaN,

    earlier: 0,
    targetAge: NaN,
    reqExtraMonthly: NaN,
    reqExtraLump: NaN,
    hasRealityGap: false,
  };

  const microOptions = [
    // Konkrete hverdagsgreb (mindre)
    { id:"subs",    group:"quick", emoji:"üßæ", name:"Sk√¶r 1‚Äì2 abonnementer fra",                 kr:150 },
    { id:"food",    group:"quick", emoji:"üçΩÔ∏è", name:"Mindre takeaway / caf√©",                    kr:400 },
    { id:"grocery", group:"quick", emoji:"üõí", name:"Strammere dagligvarebudget",                kr:500 },
    { id:"impulse", group:"quick", emoji:"üí≥", name:"F√¶rre impulsk√∏b",                           kr:400 },
    { id:"ins",     group:"quick", emoji:"üõ°Ô∏è", name:"Genforhandle forsikringer / faste aftaler", kr:600 },

    // St√∏rre greb (vises kun hvis der mangler mindre greb)
    { id:"fuel",    group:"big",   emoji:"‚õΩÔ∏è", name:"K√∏r mindre / samk√∏rsel",                    kr:600 },
    { id:"car",     group:"big",   emoji:"üöó",  name:"Billigere bil",                            kr:1500 },
    { id:"car2",    group:"big",   emoji:"üöô",  name:"√ân bil mindre i husstanden",               kr:2500 },
    { id:"home1",   group:"big",   emoji:"üè†",  name:"Lavere boligudgifter",                     kr:1200 },
    { id:"home2",   group:"big",   emoji:"üè°",  name:"Flytte til billigere bolig",               kr:2500 },
    { id:"holiday1",group:"big",   emoji:"‚úàÔ∏è", name:"Billigere ferier",                          kr:800 },
    { id:"holiday2",group:"big",   emoji:"üå¥", name:"St√∏rre ferie-oml√¶gning",                    kr:1500 }
  ];

  // =========================
  // DOM
  // =========================
  const steps = {
    intro: qs("step_intro"),
    age: qs("step_age"),
    numbers: qs("step_numbers"),
    result: qs("step_result"),
    micro: qs("step_micro"),
    reality: qs("step_reality")
  };
  const ui = {
    progressFill: qs("progressFill"),

    startBtn: qs("startBtn"),
    demoBtn: qs("demoBtn"),

    ageInput: qs("ageInput"),
    pensionAgeBig: qs("pensionAgeBig"),
    ageNextBtn: qs("ageNextBtn"),
    errAge: qs("errAge"),

    savingsInput: qs("savingsInput"),
    monthlyInput: qs("monthlyInput"),
    incomeInput: qs("incomeInput"),
    incomeWarn: qs("incomeWarn"),
    numsBackBtn: qs("numsBackBtn"),
    numsNextBtn: qs("numsNextBtn"),
    resetNumsBtn: qs("resetNumsBtn"),
    errNums: qs("errNums"),

    resultMeta: qs("resultMeta"),
    curAgeLbl: qs("curAgeLbl"),
    pensionAgeLbl: qs("pensionAgeLbl"),
    stopAgeBig: qs("stopAgeBig"),
    gapText: qs("gapText"),
    detailsText: qs("detailsText"),
    toggleDetailsBtn: qs("toggleDetailsBtn"),
    detailsBox: qs("detailsBox"),
    resBackBtn: qs("resBackBtn"),
    startOverBtn: qs("startOverBtn"),
    resultCtas: qs("resultCtas"),

    totalGainLbl: qs("totalGainLbl"),
    microInfo: qs("microInfo"),
    microList: qs("microList"),
    customMicroInput: qs("customMicroInput"),
    customNote: qs("customNote"),
    errMicro: qs("errMicro"),
    microBackBtn: qs("microBackBtn"),
    microDoneBtn: qs("microDoneBtn"),

    earlierSlider: qs("earlierSlider"),
    earlierLbl: qs("earlierLbl"),
    targetAgeLbl: qs("targetAgeLbl"),
    targetMeta: qs("targetMeta"),
    needMonthlyLbl: qs("needMonthlyLbl"),
    needLumpLbl: qs("needLumpLbl"),
    realityBackBtn: qs("realityBackBtn"),
    realityCtas: qs("realityCtas"),

    assumBtn: qs("assumBtn"),
    modalBack: qs("modalBack"),
    closeModalBtn: qs("closeModalBtn"),

    leadBack: qs("leadBack"),
    leadStepA: qs("leadStepA"),
    leadStepB: qs("leadStepB"),
    leadThanks: qs("leadThanks"),

    leadName: qs("leadName"),
    leadEmail: qs("leadEmail"),
    leadPhone: qs("leadPhone"),
    leadConsent: qs("leadConsent"),
    leadErrA: qs("leadErrA"),

    shareScenario: qs("shareScenario"),
    scenarioPreview: qs("scenarioPreview"),
    leadErrB: qs("leadErrB"),
    leadPayloadPreview: qs("leadPayloadPreview"),

    closeLeadBtn: qs("closeLeadBtn"),
    leadNextBtn: qs("leadNextBtn"),
    leadBackBtn: qs("leadBackBtn"),
    leadSubmitBtn: qs("leadSubmitBtn"),
    leadDoneBtn: qs("leadDoneBtn"),

    privacyBack: qs("privacyBack"),
    privacyBtn: qs("privacyBtn"),
    privacyBtn2: qs("privacyBtn2"),
    closePrivacyBtn: qs("closePrivacyBtn"),
  };

  // =========================
  // Navigation
  // =========================
  const progressMap = { intro:0, age:20, numbers:40, result:60, micro:80, reality:100 };

  function showStep(name){
    for (const k of Object.keys(steps)) steps[k].classList.remove("active");
    steps[name].classList.add("active");
    state.step = name;
    ui.progressFill.style.width = (progressMap[name] ?? 0) + "%";
    window.scrollTo({top:0, behavior:"instant"});
    updateUI();
  }

  // =========================
  // Derived helpers
  // =========================
  function hasCoreNumbers(){
    return [state.age, state.pensionAge, state.savings, state.monthly, state.income].every(Number.isFinite);
  }
  function selectedExtraMonthly(){
    let sum = 0;
    for (const opt of microOptions) if (state.microSelected.has(opt.id)) sum += opt.kr;
    sum += Math.max(0, Number.isFinite(state.microCustom) ? state.microCustom : 0);
    return sum;
  }
  function gapLabel(gapYears){
    if (!Number.isFinite(gapYears) || !Number.isFinite(state.pensionAge)) return "‚Äî";
    const days = Math.round(gapYears*365);
    if (days < 30) return `Det svarer til ca. ${days} dage f√∏r folkepension (${state.pensionAge} √•r, estimat)`;
    const months = Math.round(days/30);
    if (months < 24) return `Det svarer til ca. ${months} m√•neder f√∏r folkepension (${state.pensionAge} √•r, estimat)`;
    const y = Math.round(gapYears*2)/2;
    return `Det svarer til ca. ${y.toString().replace('.',',')} √•r f√∏r folkepension (${state.pensionAge} √•r, estimat)`;
  }
  function microGainLabel(years){
    if (!Number.isFinite(years)) return "‚Äî";
    const days = Math.round(years*365);
    if (days < 30) return "<1 md";
    const months = Math.round(days/30);
    if (months < 24) return `+${months} md`;
    const y = Math.round((months/12)*2)/2;
    return `+${y.toString().replace('.',',')} √•r`;
  }

  // =========================
  // Validations + commits
  // =========================
  function updatePensionPreview(){
    const v = parseDK(ui.ageInput.value);
    const a = Math.round(v);
    ui.pensionAgeBig.textContent = (Number.isFinite(a) && a>=18 && a<=80) ? estimatePensionAgeFromAge(a) : "‚Äî";
  }
  function commitAge(){
    const v = parseDK(ui.ageInput.value);
    const a = Math.round(v);
    if (!Number.isFinite(a) || a<18 || a>80) return false;
    state.age = a;
    state.pensionAge = estimatePensionAgeFromAge(a);
    return true;
  }
  function commitNumbers(){
    const s = parseDK(ui.savingsInput.value);
    const m = parseDK(ui.monthlyInput.value);
    const inc = parseDK(ui.incomeInput.value);
    if (!(Number.isFinite(s) && s>=0)) return false;
    if (!(Number.isFinite(m) && m>=0)) return false;
    if (!(Number.isFinite(inc) && inc>0)) return false;
    state.savings = s;
    state.monthly = m;
    state.income = inc;
    return true;
  }
  function resetAll(){
    state.step="intro";
    state.age=NaN; state.pensionAge=NaN; state.savings=NaN; state.monthly=NaN; state.income=NaN;
    state.microSelected.clear(); state.microCustom=0; state.microApplied=false;
    state.microBaselineGain.clear(); state.microEligible.clear(); state.microBaselineCustomMin=NaN;
    state.stopAge=NaN;
    state.earlier=0; state.targetAge=NaN; state.reqExtraMonthly=NaN; state.reqExtraLump=NaN; state.hasRealityGap=false;

    ui.ageInput.value=""; ui.pensionAgeBig.textContent="‚Äî";
    ui.savingsInput.value=""; ui.monthlyInput.value=""; ui.incomeInput.value="";
    ui.customMicroInput.value="";
    ui.errAge.classList.remove("show");
    ui.errNums.classList.remove("show");
    ui.errMicro.classList.remove("show");
    ui.detailsBox.classList.remove("open");
    ui.toggleDetailsBtn.textContent="Se beregningsgrundlag";
    ui.incomeWarn.classList.remove("show");
    closeLead(true);
    showStep("intro");
  }

  // =========================
  // Income warning
  // =========================
  function updateIncomeWarning(){
    const v = parseDK(ui.incomeInput.value);
    if (!Number.isFinite(v) || v <= 0){ ui.incomeWarn.classList.remove("show"); return; }

    if (v < 8000){
      ui.incomeWarn.textContent = "Bem√¶rk: Bel√∏bet er us√¶dvanligt lavt for et m√•nedligt levebehov. Hvis du mente 35.000, s√• skriv 35.000 (ikke 3.500).";
      ui.incomeWarn.classList.add("show");
    } else if (v > 150000){
      ui.incomeWarn.textContent = "Bem√¶rk: Bel√∏bet er meget h√∏jt. Resultatet kan blive f√∏lsomt for antagelser. Tjek at tallet er korrekt.";
      ui.incomeWarn.classList.add("show");
    } else {
      ui.incomeWarn.classList.remove("show");
    }
  }

  // =========================
  // Micro eligibility + custom
  // =========================
  function computeMicroBaseline(){
    state.microBaselineGain.clear();
    state.microEligible.clear();
    if (!hasCoreNumbers()) return;

    const baseMonthly = state.monthly;
    const stopBase = solveStopAge(state.age, state.pensionAge, state.savings, baseMonthly, state.income);

    for (const opt of microOptions){
      const stopWith = solveStopAge(state.age, state.pensionAge, state.savings, baseMonthly + opt.kr, state.income);
      const gain = stopBase - stopWith;
      state.microBaselineGain.set(opt.id, gain);
      if (Math.round(gain*365) >= 30) state.microEligible.add(opt.id);
    }

    // minimal custom for >= 1 month (binary search)
    let lo=0, hi=20000;
    for (let i=0;i<18;i++){
      const mid=(lo+hi)/2;
      const stopWith = solveStopAge(state.age, state.pensionAge, state.savings, baseMonthly + mid, state.income);
      const d = Math.round((stopBase - stopWith)*365);
      if (d >= 30) hi = mid; else lo = mid;
    }
    state.microBaselineCustomMin = hi;
  }

  function computeCustomMicro(){
    if (!hasCoreNumbers()){ state.microCustom = 0; return; }
    const customVal = parseDK(ui.customMicroInput.value);
    const custom = Number.isFinite(customVal) ? Math.max(0, customVal) : 0;
    if (custom <= 0){ state.microCustom = 0; ui.customNote.textContent = "Tilf√∏jes, hvis det giver mindst 1 m√•ned effekt (baseline)."; return; }

    const stopBase = solveStopAge(state.age, state.pensionAge, state.savings, state.monthly, state.income);
    const stopWith = solveStopAge(state.age, state.pensionAge, state.savings, state.monthly + custom, state.income);
    const baselineDays = Math.round((stopBase - stopWith)*365);

    if (baselineDays < 30){
      state.microCustom = 0;
      ui.customNote.textContent = `Bel√∏bet giver under 1 m√•ned effekt (baseline). Pr√∏v ca. ${fmtDK(state.microBaselineCustomMin)} kr./md eller mere.`;
    } else {
      state.microCustom = custom;
      ui.customNote.textContent = "Tilf√∏jet (baseline ‚â• 1 m√•ned).";
    }
  }

  function getTopMicroSuggestions(){
    // eligible by baseline
    const eligibleAll = microOptions.filter(o => state.microEligible.has(o.id));
    const byGainDesc = (a,b)=> ( (state.microBaselineGain.get(b.id) ?? 0) - (state.microBaselineGain.get(a.id) ?? 0) );

    const quick = eligibleAll.filter(o => o.group==="quick").sort(byGainDesc);
    const big = eligibleAll.filter(o => o.group==="big").sort(byGainDesc);

    let chosen = [];
    if (quick.length >= 5){
      chosen = quick.slice(0,5);
    } else {
      chosen = quick.slice(0,5);
      const remaining = 5 - chosen.length;
      chosen = chosen.concat(big.slice(0, remaining));
    }

    // selected first within chosen
    chosen.sort((a,b)=>{
      const as = state.microSelected.has(a.id) ? 1 : 0;
      const bs = state.microSelected.has(b.id) ? 1 : 0;
      if (as !== bs) return bs - as;
      return byGainDesc(a,b);
    });
    return chosen;
  }

  // =========================
  // Calculate core results
  // =========================
  function updateResults(){
    ui.curAgeLbl.textContent = Number.isFinite(state.age) ? state.age : "‚Äî";
    ui.pensionAgeLbl.textContent = Number.isFinite(state.pensionAge) ? state.pensionAge : "‚Äî";

    if (!hasCoreNumbers()){
      state.stopAge = NaN;
      ui.stopAgeBig.textContent = "‚Äî";
      ui.gapText.textContent = "‚Äî";
      ui.detailsText.textContent = "‚Äî";
      return;
    }

    const extra = selectedExtraMonthly();
    const stop = solveStopAge(state.age, state.pensionAge, state.savings, state.monthly + extra, state.income);
    state.stopAge = stop;

    const fmtAge = (v)=> v.toFixed(1).replace('.',',').replace(',0','');
    ui.stopAgeBig.textContent = fmtAge(stop);
    ui.gapText.textContent = gapLabel(state.pensionAge - stop);

    const fv = futureValue(state.savings, state.monthly + extra, Math.max(0, stop - state.age), 0.04);
    const need = bridgePV(state.income, Math.max(0, state.pensionAge - stop), 0.02, 0.10);

    ui.detailsText.textContent =
      `Folkepension (estimat): ${state.pensionAge} √•r\n` +
      `Mulig stop-alder: ${fmtAge(stop)} √•r\n` +
      `Overgangsperiode: ${(state.pensionAge-stop).toString().replace('.',',')} √•r\n\n` +
      `Kapital ved stop (estimat): ${fmtDK(fv)} kr.\n` +
      `Kapital til overgang (inkl. 10% buffer): ${fmtDK(need)} kr.\n` +
      `Ekstra l√∏ft fra valg: ${fmtDK(extra)} kr./md\n\n` +
      `Antagelser: 4% real ¬∑ 2% real ¬∑ 10% buffer.`;
  }

  // =========================
  // Reality calculations
  // =========================
  function prepareReality(){
    if (!Number.isFinite(state.stopAge)){
      ui.earlierSlider.max="0";
      ui.earlierSlider.value="0";
      state.earlier=0;
      return;
    }
    const maxEarlierRaw = state.stopAge - (state.age + 0.5);
    const maxEarlier = Math.max(0, Math.floor(maxEarlierRaw*2)/2);
    ui.earlierSlider.max = String(maxEarlier);
    ui.earlierSlider.value = String(Math.min(state.earlier, maxEarlier));
  }

  function updateReality(){
    if (!hasCoreNumbers() || !Number.isFinite(state.stopAge)){
      ui.earlierLbl.textContent="0 √•r";
      ui.targetAgeLbl.textContent="‚Äî";
      ui.targetMeta.textContent="‚Äî";
      ui.needMonthlyLbl.textContent="‚Äî";
      ui.needLumpLbl.textContent="‚Äî";
      state.hasRealityGap=false;
      return;
    }

    const earlier = parseFloat(ui.earlierSlider.value || "0") || 0;
    state.earlier = earlier;
    ui.earlierLbl.textContent = `${earlier.toString().replace('.',',')} √•r`;

    const targetAge = state.stopAge - earlier;
    state.targetAge = targetAge;

    ui.targetAgeLbl.textContent = `${targetAge.toString().replace('.',',')} √•r`;
    ui.targetMeta.textContent = earlier > 0 ? `m√•l: ca. ${earlier.toString().replace('.',',')} √•r tidligere` : "v√¶lg et m√•l (0,5 √•r-trin)";

    if (earlier <= 0){
      state.reqExtraMonthly = 0;
      state.reqExtraLump = 0;
      ui.needMonthlyLbl.textContent = "‚Äî";
      ui.needLumpLbl.textContent = "‚Äî";
      state.hasRealityGap=false;
      return;
    }

    const monthlyTotal = state.monthly + selectedExtraMonthly();
    const req = inverseNeedAtTarget(targetAge, state, monthlyTotal);
    if (!req.ok){
      state.reqExtraMonthly = NaN;
      state.reqExtraLump = NaN;
      ui.needMonthlyLbl.textContent = "‚Äî";
      ui.needLumpLbl.textContent = "‚Äî";
      state.hasRealityGap=false;
      return;
    }

    state.reqExtraMonthly = req.extraMonthly;
    state.reqExtraLump = req.extraLump;
    ui.needMonthlyLbl.textContent = `+${fmtDK(req.extraMonthly)} kr./md`;
    ui.needLumpLbl.textContent = `+${fmtDK(req.extraLump)} kr.`;
    state.hasRealityGap = true;
  }

  // =========================
  // Micro rendering
  // =========================
  function renderMicro(){
    ui.microList.innerHTML = "";
    ui.microInfo.innerHTML = "";
    ui.errMicro.classList.remove("show");

    if (!hasCoreNumbers()){
      ui.errMicro.classList.add("show");
      return;
    }

    computeCustomMicro();

    // total gain label
    const extra = selectedExtraMonthly();
    const stopNo = solveStopAge(state.age, state.pensionAge, state.savings, state.monthly, state.income);
    const stopYes = solveStopAge(state.age, state.pensionAge, state.savings, state.monthly + extra, state.income);
    ui.totalGainLbl.textContent = microGainLabel(stopNo - stopYes);

    const list = getTopMicroSuggestions();
    if (list.length === 0){
      const info = document.createElement("div");
      info.className = "infoCard";
      info.textContent = "Ingen forslag giver ‚â• 1 m√•ned effekt i din situation. Pr√∏v et eget bel√∏b nedenfor.";
      ui.microInfo.appendChild(info);
      return;
    }

    for (const opt of list){
      const item = document.createElement("div");
      item.className = "microItem" + (state.microSelected.has(opt.id) ? " selected" : "");
      item.setAttribute("role","button");
      item.tabIndex = 0;

      const baseMonthlyTotal = state.monthly + selectedExtraMonthly();
      const stopNow = solveStopAge(state.age, state.pensionAge, state.savings, baseMonthlyTotal, state.income);
      const stopWith = solveStopAge(state.age, state.pensionAge, state.savings, baseMonthlyTotal + opt.kr, state.income);
      const nowGain = stopNow - stopWith;

      const badge = opt.group==="big" ? `<div class="tagBadge">ST√òRRE GREB</div>` : ``;

      item.innerHTML = `
        <div class="microLeft">
          <div class="emoji" aria-hidden="true">${opt.emoji}</div>
          <div style="min-width:0">
            <div class="microName">${opt.name}</div>
            ${badge}
          </div>
        </div>
        <div class="microRight">
          <div class="microGain mono">${microGainLabel(nowGain)}</div>
          <div class="microCost mono">${fmtDK(opt.kr)} kr./md</div>
        </div>
      `;

      const toggle = ()=>{
        if (state.microSelected.has(opt.id)) state.microSelected.delete(opt.id);
        else state.microSelected.add(opt.id);
        updateUI();
      };
      item.addEventListener("click", toggle, {passive:true});
      item.addEventListener("keydown", (e)=>{ if (e.key==="Enter"||e.key===" "){ e.preventDefault(); toggle(); }});
      ui.microList.appendChild(item);
    }
  }

  // =========================
  // CTA rendering (state machine)
  // =========================
  function renderResultCTAs(){
    ui.resultCtas.innerHTML = "";

    const makeCard = (btnEl)=> {
      const wrap = document.createElement("div");
      wrap.className = "card";
      wrap.style.padding = "14px 14px";
      wrap.style.marginTop = "12px";
      wrap.appendChild(btnEl);
      return wrap;
    };

    const btnImprove = document.createElement("button");
    btnImprove.type="button";
    btnImprove.className = state.microApplied ? "ctaSecondary" : "ctaPrimary";
    btnImprove.textContent = "Forbedr mit potentiale";
    btnImprove.addEventListener("click", ()=> {
      computeMicroBaseline();
      renderMicro();
      showStep("micro");
    }, {passive:true});

    const btnAdvisory = document.createElement("button");
    btnAdvisory.type="button";
    btnAdvisory.className = state.microApplied ? "ctaPrimary" : "ctaSecondary";
    btnAdvisory.innerHTML = state.microApplied
      ? 'F√• sparring p√• min plan'
      : 'F√• sparring p√• min plan <span>Frivilligt ‚Äì vi formidler kontakt, hvis du √∏nsker det</span>';
    btnAdvisory.addEventListener("click", openLead, {passive:true});

    // Reality CTA only after microApplied (per flow requirement)
    const btnReality = document.createElement("button");
    btnReality.type="button";
    btnReality.className = "ctaSecondary";
    btnReality.innerHTML = 'Se hvad der skal til <span>Pr√∏v et m√•l og se n√∏dvendigt l√∏ft</span>';
    btnReality.addEventListener("click", ()=> {
      prepareReality();
      showStep("reality");
    }, {passive:true});

    // Before microApplied: primary improve, secondary advisory (still visible), no reality
    if (!state.microApplied){
      ui.resultCtas.appendChild(makeCard(btnImprove));
      ui.resultCtas.appendChild(makeCard(btnAdvisory));
      return;
    }

    // After microApplied: primary advisory, secondary reality, improve becomes neutral link
    const linkImprove = document.createElement("button");
    linkImprove.type="button";
    linkImprove.className = "linkBtn";
    linkImprove.textContent = "Vil du optimere igen? √Öbn frihedsl√∏ft";
    linkImprove.addEventListener("click", ()=> {
      computeMicroBaseline();
      renderMicro();
      showStep("micro");
    }, {passive:true});

    ui.resultCtas.appendChild(makeCard(btnAdvisory));
    ui.resultCtas.appendChild(makeCard(btnReality));

    const linkWrap = document.createElement("div");
    linkWrap.style.marginTop = "6px";
    linkWrap.appendChild(linkImprove);
    ui.resultCtas.appendChild(linkWrap);
  }

  function renderRealityCTAs(){
    ui.realityCtas.innerHTML = "";

    const makeCard = (btnEl)=> {
      const wrap = document.createElement("div");
      wrap.className = "card";
      wrap.style.padding = "14px 14px";
      wrap.style.marginTop = "12px";
      wrap.appendChild(btnEl);
      return wrap;
    };

    const btnAdvisory = document.createElement("button");
    btnAdvisory.type="button";
    btnAdvisory.className = state.hasRealityGap ? "ctaPrimary" : "ctaSecondary";
    btnAdvisory.innerHTML = state.hasRealityGap
      ? 'F√• sparring p√• min plan'
      : 'F√• sparring p√• min plan <span>Frivilligt ‚Äì hvis du vil have hj√¶lp</span>';
    btnAdvisory.addEventListener("click", openLead, {passive:true});

    ui.realityCtas.appendChild(makeCard(btnAdvisory));
  }

  // =========================
  // Lead module
  // =========================
  function scenarioSummaryLines(){
    const extraMonthly = selectedExtraMonthly();
    return [
      `Alder: ${Number.isFinite(state.age) ? state.age : "‚Äî"}`,
      `Folkepension (estimat): ${Number.isFinite(state.pensionAge) ? state.pensionAge : "‚Äî"}`,
      `Mulig stop-alder: ${Number.isFinite(state.stopAge) ? state.stopAge.toString().replace('.',',') : "‚Äî"}`,
      `Opsparing: ${Number.isFinite(state.savings) ? fmtDK(state.savings) + " kr." : "‚Äî"}`,
      `M√•nedlig investering: ${Number.isFinite(state.monthly) ? fmtDK(state.monthly) + " kr./md" : "‚Äî"}`,
      `√ònsket indkomst: ${Number.isFinite(state.income) ? fmtDK(state.income) + " kr./md" : "‚Äî"}`,
      `Valgte greb: ${Array.from(state.microSelected).length ? Array.from(state.microSelected).join(", ") : "ingen"}`,
      `Samlet ekstra l√∏ft: ${fmtDK(extraMonthly)} kr./md`,
      `M√•l (stopalder): ${Number.isFinite(state.targetAge) ? state.targetAge.toString().replace('.',',') + " √•r" : "‚Äî"}`,
      `N√∏dvendigt ekstra l√∏ft: ${Number.isFinite(state.reqExtraMonthly) ? "+" + fmtDK(state.reqExtraMonthly) + " kr./md" : "‚Äî"}  |  ${Number.isFinite(state.reqExtraLump) ? "+" + fmtDK(state.reqExtraLump) + " kr." : "‚Äî"}`
    ].join("\n");
  }

  function buildLeadPayload(contact, consent, share){
    return {
      contact: { name: contact.name || null, email: contact.email || null, phone: contact.phone || null },
      consent: !!consent,
      scenario: share ? {
        age: state.age,
        pension_estimate: state.pensionAge,
        stop_estimate: state.stopAge,
        savings: state.savings,
        monthly_investment: state.monthly,
        desired_income: state.income,
        micro_selected: Array.from(state.microSelected),
        micro_extra_monthly: selectedExtraMonthly(),
        slider_target_age: state.targetAge,
        required_extra_monthly: state.reqExtraMonthly,
        required_extra_lump_sum: state.reqExtraLump,
      } : null,
      meta: { timestamp: isoNow(), app_version: APP_VERSION, mode: LEAD_ENDPOINT ? "live" : "demo" }
    };
  }

  function openLead(){
    ui.leadErrA.classList.remove("show");
    ui.leadErrB.classList.remove("show");

    ui.leadStepA.style.display = "block";
    ui.leadStepB.style.display = "none";
    ui.leadThanks.style.display = "none";

    ui.scenarioPreview.textContent = scenarioSummaryLines();
    ui.shareScenario.checked = true;

    ui.leadBack.classList.add("open");
  }
  function closeLead(hardReset=false){
    ui.leadBack.classList.remove("open");
    if (hardReset){
      ui.leadName.value=""; ui.leadEmail.value=""; ui.leadPhone.value="";
      ui.leadConsent.checked=false;
      ui.shareScenario.checked=true;
      ui.leadPayloadPreview.textContent="‚Äî";
    }
  }
  function validateLeadA(){
    const name = ui.leadName.value.trim();
    const email = ui.leadEmail.value.trim();
    const phone = ui.leadPhone.value.trim();
    const consent = ui.leadConsent.checked;
    return (name.length>0 && email.length>0 && phone.length>0 && consent);
  }
  function storeDemoLead(payload){
    try{
      const key="tidsloft_demo_leads";
      const arr = JSON.parse(localStorage.getItem(key) || "[]");
      arr.push(payload);
      localStorage.setItem(key, JSON.stringify(arr));
    } catch(_e){}
  }
  async function submitLead(){
    ui.leadErrB.classList.remove("show");
    const contact = { name: ui.leadName.value.trim(), email: ui.leadEmail.value.trim(), phone: ui.leadPhone.value.trim() };
    const consent = ui.leadConsent.checked;
    const share = ui.shareScenario.checked;
    const payload = buildLeadPayload(contact, consent, share);

    if (!LEAD_ENDPOINT){
      storeDemoLead(payload);
      ui.leadPayloadPreview.textContent = JSON.stringify(payload, null, 2);
      ui.leadStepA.style.display="none";
      ui.leadStepB.style.display="none";
      ui.leadThanks.style.display="block";
      console.log("[DEMO] Lead payload", payload);
      return;
    }
    try{
      const res = await fetch(LEAD_ENDPOINT, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      if (!res.ok) throw new Error("HTTP " + res.status);
      ui.leadPayloadPreview.textContent = "Afsendt.";
      ui.leadStepA.style.display="none";
      ui.leadStepB.style.display="none";
      ui.leadThanks.style.display="block";
    } catch(err){
      ui.leadErrB.textContent = "Afsendelse fejlede. (Demo kan fortsat bruges uden endpoint.)";
      ui.leadErrB.classList.add("show");
      console.error(err);
    }
  }

  // =========================
  // updateUI (single orchestrator)
  // =========================
  function updateUI(){
    // Core numbers preview
    if (state.step === "age") updatePensionPreview();

    // compute core results always when data exists
    updateResults();

    if (state.step === "micro"){
      renderMicro();
    }
    if (state.step === "reality"){
      prepareReality();
      updateReality();
      renderRealityCTAs();
    }
    if (state.step === "result"){
      renderResultCTAs();
    }
  }

  // =========================
  // Events
  // =========================
  // Step transitions
  ui.startBtn.addEventListener("click", ()=> showStep("age"), {passive:true});
  ui.demoBtn.addEventListener("click", ()=> { ui.ageInput.value="46"; updatePensionPreview(); }, {passive:true});
  ui.ageInput.addEventListener("input", updatePensionPreview, {passive:true});

  ui.ageNextBtn.addEventListener("click", ()=>{
    ui.errAge.classList.remove("show");
    if (!commitAge()){ ui.errAge.classList.add("show"); return; }
    showStep("numbers");
  }, {passive:true});

  ui.numsBackBtn.addEventListener("click", ()=> showStep("age"), {passive:true});
  ui.resetNumsBtn.addEventListener("click", ()=> { ui.savingsInput.value=""; ui.monthlyInput.value=""; ui.incomeInput.value=""; updateIncomeWarning(); }, {passive:true});
  ui.incomeInput.addEventListener("input", updateIncomeWarning, {passive:true});

  ui.numsNextBtn.addEventListener("click", ()=>{
    ui.errNums.classList.remove("show");
    if (!commitAge()){ showStep("age"); ui.errAge.classList.add("show"); return; }
    if (!commitNumbers()){ ui.errNums.classList.add("show"); return; }

    // reset downstream state
    state.microSelected.clear();
    state.microCustom = 0;
    state.microApplied = false;
    ui.customMicroInput.value = "";
    state.earlier = 0;
    state.targetAge = NaN;
    state.reqExtraMonthly = NaN;
    state.reqExtraLump = NaN;
    state.hasRealityGap = false;

    computeMicroBaseline();
    ui.resultMeta.textContent = "Baseret p√• dine tal lige nu.";
    showStep("result");
  }, {passive:true});

  ui.toggleDetailsBtn.addEventListener("click", ()=>{
    const open = ui.detailsBox.classList.toggle("open");
    ui.toggleDetailsBtn.textContent = open ? "Skjul beregningsgrundlag" : "Se beregningsgrundlag";
  }, {passive:true});

  ui.resBackBtn.addEventListener("click", ()=> showStep("numbers"), {passive:true});
  ui.startOverBtn.addEventListener("click", resetAll, {passive:true});

  ui.microBackBtn.addEventListener("click", ()=> showStep("result"), {passive:true});
  ui.customMicroInput.addEventListener("input", ()=> updateUI(), {passive:true});

  ui.microDoneBtn.addEventListener("click", ()=>{
    state.microApplied = true;
    ui.resultMeta.textContent = "Opdateret efter dine frihedsl√∏ft.";
    showStep("result");
  }, {passive:true});

  ui.earlierSlider.addEventListener("input", ()=> { updateReality(); renderRealityCTAs(); }, {passive:true});
  ui.realityBackBtn.addEventListener("click", ()=> showStep("result"), {passive:true});

  // Assumptions modal
  ui.assumBtn.addEventListener("click", ()=> ui.modalBack.classList.add("open"), {passive:true});
  ui.closeModalBtn.addEventListener("click", ()=> ui.modalBack.classList.remove("open"), {passive:true});
  ui.modalBack.addEventListener("click", (e)=>{ if (e.target===ui.modalBack) ui.modalBack.classList.remove("open"); }, {passive:true});

  // Lead modal
  ui.closeLeadBtn.addEventListener("click", ()=> closeLead(false), {passive:true});
  ui.leadDoneBtn.addEventListener("click", ()=> closeLead(true), {passive:true});
  ui.leadBack.addEventListener("click", (e)=>{ if (e.target===ui.leadBack) closeLead(false); }, {passive:true});

  ui.leadNextBtn.addEventListener("click", ()=>{
    ui.leadErrA.classList.remove("show");
    if (!validateLeadA()){ ui.leadErrA.classList.add("show"); return; }
    ui.scenarioPreview.textContent = scenarioSummaryLines();
    ui.leadStepA.style.display="none";
    ui.leadStepB.style.display="block";
    ui.leadThanks.style.display="none";
  }, {passive:true});

  ui.leadBackBtn.addEventListener("click", ()=>{
    ui.leadErrB.classList.remove("show");
    ui.leadStepA.style.display="block";
    ui.leadStepB.style.display="none";
    ui.leadThanks.style.display="none";
  }, {passive:true});

  ui.shareScenario.addEventListener("change", ()=> {
    ui.scenarioPreview.textContent = ui.shareScenario.checked ? scenarioSummaryLines() : "(Ingen beregningsdata deles.)";
  }, {passive:true});

  ui.leadSubmitBtn.addEventListener("click", submitLead, {passive:true});

  // Privacy modal
  ui.privacyBtn.addEventListener("click", ()=> ui.privacyBack.classList.add("open"), {passive:true});
  ui.privacyBtn2.addEventListener("click", ()=> ui.privacyBack.classList.add("open"), {passive:true});
  ui.closePrivacyBtn.addEventListener("click", ()=> ui.privacyBack.classList.remove("open"), {passive:true});
  ui.privacyBack.addEventListener("click", (e)=>{ if (e.target===ui.privacyBack) ui.privacyBack.classList.remove("open"); }, {passive:true});

  // Help toggles
  toggleHelp("helpAgeBtn","helpAgeBox");
  toggleHelp("helpSavingsBtn","helpSavingsBox");
  toggleHelp("helpMonthlyBtn","helpMonthlyBox");
  toggleHelp("helpIncomeBtn","helpIncomeBox");
  toggleHelp("helpCustomBtn","helpCustomBox");

  // Sanity tests (throws early if broken)
  (function sanity(){
    const pension = estimatePensionAgeFromAge(46);
    if (!(pension>=67 && pension<=70)) throw new Error("Sanity: pensionAge invalid");
    const stop = solveStopAge(46, pension, 25000, 3500, 35000);
    if (!Number.isFinite(stop)) throw new Error("Sanity: stopAge NaN");
    const fv = futureValue(25000, 3500, 10, 0.04);
    if (!Number.isFinite(fv) || fv<=0) throw new Error("Sanity: FV invalid");
  })();

  // Initial
  updatePensionPreview();
  updateIncomeWarning();
  showStep("intro");
})();
</script>
</body>
</html>
