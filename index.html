<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PensionenOptimer — Demo</title>
  <meta name="theme-color" content="#2c6cff">
  <style>
    :root{
      --bg1:#f6fbff; --bg2:#eef5ff;
      --card:#ffffff; --text:#0b1220; --muted:#5a6b85; --line:#e7eef8;
      --blue:#2c6cff; --blue2:#1f4ed8; --alt:#00a6ff;
      --shadow: 0 18px 45px rgba(10,30,80,0.10);
      --radius: 18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--text); min-height:100vh;
      background:
        radial-gradient(1200px 800px at 20% 10%, #d7ebff 0%, rgba(215,235,255,0) 60%),
        radial-gradient(1000px 700px at 80% 20%, #d9fff6 0%, rgba(217,255,246,0) 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
    }
    .app{max-width:460px; margin:0 auto; padding:16px 14px 18px;}
    .topbar{display:flex; align-items:center; justify-content:space-between; padding:10px 6px 14px;}
    .brand{display:flex; gap:10px; align-items:center; cursor:pointer; user-select:none;}
    .dot{
      width:12px;height:12px;border-radius:999px;
      background: linear-gradient(135deg, var(--blue), var(--alt));
      box-shadow:0 8px 18px rgba(44,108,255,0.25);
    }
    .name{font-weight:900; letter-spacing:0.2px}
    .tag{font-size:12px;color:var(--muted);margin-top:1px}
    .badge{
      font-size:11px; padding:4px 8px; border-radius:999px;
      border:1px solid rgba(44,108,255,0.18); background: rgba(44,108,255,0.08); color:#1c3f9e;
      margin-left:8px; font-weight:800;
    }
    .screen{display:flex; flex-direction:column; gap:14px;}
    .card{
      background: rgba(255,255,255,0.90);
      border: 1px solid rgba(231,238,248,0.9);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 18px 16px;
      backdrop-filter: blur(8px);
    }
    .hidden{display:none}
    .kicker{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.12em;margin-bottom:8px;}
    h1,h2{margin:0 0 10px}
    h1{font-size:22px;line-height:1.2}
    h2{font-size:20px;line-height:1.2}
    p{margin:0 0 12px;line-height:1.5}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .footnote{font-size:12px;color:var(--muted);margin-top:10px}
    .strong{font-weight:900}
    .row{display:flex;gap:10px;align-items:center}
    .between{justify-content:space-between}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .field{display:flex;flex-direction:column;gap:6px;margin: 10px 0}
    label{font-size:13px;color:#30415f}
    input, select{
      border: 1px solid var(--line);
      background:#fff;
      border-radius: 14px;
      padding: 12px 12px;
      font-size:16px;
      outline:none;
    }
    input:focus, select:focus{
      border-color: rgba(44,108,255,0.55);
      box-shadow: 0 0 0 4px rgba(44,108,255,0.10)
    }
    button{
      border:1px solid transparent;
      border-radius: 14px;
      padding: 12px 12px;
      font-size:14px;
      cursor:pointer;
    }
    button.primary{
      background: linear-gradient(135deg, var(--blue), var(--blue2));
      color:#fff;
      box-shadow: 0 14px 28px rgba(44,108,255,0.22);
      flex:1;
      font-weight:800;
    }
    button.ghost{
      background: rgba(255,255,255,0.65);
      border-color: var(--line);
      color:#20314c;
      font-weight:700;
    }
    button.smallBtn{padding:8px 10px;border-radius:12px;font-size:12px;font-weight:800}
    .hero{padding: 10px 0 8px}
    .heroAge{font-size:44px;font-weight:950;letter-spacing:-0.02em}
    .heroSub{color:var(--muted);font-size:13px;margin-top:6px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      font-size:12px; padding: 8px 10px; border-radius: 999px;
      border:1px solid rgba(44,108,255,0.20);
      background: rgba(44,108,255,0.08);
      color:#1c3f9e;
      font-weight:800;
      white-space:nowrap;
    }
    .pill.good{border-color: rgba(0,166,255,0.25); background: rgba(0,166,255,0.10); color:#055a84}
    .miniChart{
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 12px 12px;
      background: rgba(255,255,255,0.7);
      margin-top:12px;
    }
    .bar{display:grid;grid-template-columns:70px 1fr 62px;gap:10px;align-items:center;margin:10px 0}
    .track{height:10px;border-radius:999px;background:#edf3ff;overflow:hidden;border:1px solid rgba(44,108,255,0.10)}
    .fill{height:100%;width:50%;background: linear-gradient(90deg, rgba(44,108,255,0.35), rgba(44,108,255,0.95))}
    .fill.alt{background: linear-gradient(90deg, rgba(0,166,255,0.35), rgba(0,166,255,0.95))}
    .label{font-size:12px;color:var(--muted)}
    .val{font-size:12px;color:#2a3b57;text-align:right}
    input[type="range"]{width:100%}
    .preview{
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px 12px;
      background: rgba(255,255,255,0.7);
      margin-top:12px;
    }
    .previewTitle{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.12em;margin-bottom:8px}
    .previewRow{display:flex;justify-content:space-between;gap:10px;padding:8px 0;border-top:1px dashed rgba(90,107,133,0.25)}
    .previewRow:first-of-type{border-top:none}
    .choiceList{display:flex;flex-direction:column;gap:10px;margin-top:8px}
    .choiceItem{
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px 12px;
      background: rgba(255,255,255,0.75);
      display:flex; justify-content:space-between; gap:12px;
    }
    .choiceTitle{font-weight:900}
    .choiceMeta{font-size:12px;color:var(--muted);margin-top:4px}
    .toggle{
      display:flex; flex-direction:column; align-items:flex-end; gap:8px;
      min-width: 120px;
    }
    .switch{
      width: 46px; height: 28px; border-radius: 999px;
      background: #e8f0ff; border:1px solid rgba(44,108,255,0.18);
      position: relative;
    }
    .knob{
      width: 22px; height: 22px; border-radius: 999px;
      background: #fff; position:absolute; top:2px; left:2px;
      box-shadow: 0 8px 14px rgba(10,30,80,0.12);
      transition: left 160ms ease;
    }
    .switch.on{background: rgba(44,108,255,0.20); border-color: rgba(44,108,255,0.35);}
    .switch.on .knob{left: 22px;}
    .switchBtn{background:transparent;border:none;padding:0;cursor:pointer}
    pre.payload{
      background:#0b1220; color:#d7e6ff;
      border-radius:16px; padding:12px;
      overflow:auto; max-height:320px;
      font-size:12px; line-height:1.45;
    }
    .bottombar{display:flex; justify-content:space-between; padding:14px 6px 0}
    .adminList{display:flex; flex-direction:column; gap:10px; margin-top:10px}
    .leadCard{
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px 12px;
      background: rgba(255,255,255,0.75);
    }
    .leadHead{display:flex;justify-content:space-between;gap:10px}
    .leadName{font-weight:950}
    .leadTime{font-size:12px;color:var(--muted)}
    details summary{cursor:pointer}
    .nav{
      position: sticky; bottom: 0; z-index: 10;
      padding-top: 10px;
    }
    .navInner{
      background: rgba(255,255,255,0.80);
      border: 1px solid rgba(231,238,248,0.95);
      box-shadow: 0 18px 45px rgba(10,30,80,0.10);
      border-radius: 16px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      padding: 8px;
      backdrop-filter: blur(10px);
    }
    .navBtn{
      background: transparent;
      border: 1px solid transparent;
      border-radius: 14px;
      padding: 10px 10px;
      font-weight:900;
      color:#22334f;
      cursor:pointer;
      font-size:13px;
    }
    .navBtn.active{
      background: rgba(44,108,255,0.10);
      border-color: rgba(44,108,255,0.18);
      color:#1c3f9e;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="brand" id="btnHome" title="Hjem (beholder dine valg)">
        <div class="dot"></div>
        <div>
          <div class="name">PensionenOptimer <span class="badge">DEMO</span></div>
          <div class="tag">Tid frem for kroner · mobil-first</div>
        </div>
      </div>
      <button class="ghost" id="btnAdminTop">Admin</button>
    </header>

    <main class="screen">

      <section class="card" data-screen="start">
        <div class="kicker">Start</div>
        <h1>Køb tid tilbage</h1>
        <p class="muted">Se din mulige pensionsalder i <strong>tid</strong> — og hvad små justeringer kan gøre.</p>

        <div class="grid2">
          <div class="field">
            <label for="age">Din alder</label>
            <input id="age" type="number" inputmode="numeric" min="18" max="70" placeholder="fx 38" />
          </div>
          <div class="field">
            <label for="currentSavings">Nuværende opsparing (kr.)</label>
            <input id="currentSavings" type="number" inputmode="numeric" min="0" placeholder="fx 250000" />
          </div>
        </div>

        <div class="preview">
          <div class="previewTitle">Preview (opdateres live)</div>
          <div class="previewRow"><div>Mulig pensionsalder</div><div class="strong" id="startPossible">—</div></div>
          <div class="previewRow"><div>Tidsgevinst</div><div class="strong" id="startDelta">—</div></div>
          <div class="previewRow"><div>Normal pensionsalder</div><div class="strong" id="startNormal">—</div></div>
        </div>

        <div class="row">
          <button class="primary" id="btnGo">Se min tid</button>
          <button class="ghost" id="btnDemo">Demo-tal</button>
        </div>

        <p class="footnote">Simulering baseret på forudsætninger, der kan ændre sig. Ikke rådgivning.</p>
      </section>

      <section class="card hidden" data-screen="hero">
        <div class="kicker">Resultat</div>
        <div class="row between">
          <h2 style="margin:0">Din mulige pensionsalder</h2>
          <span class="pill good" id="pillDelta">+ —</span>
        </div>

        <div class="hero">
          <div class="heroAge" id="heroPossible">—</div>
          <div class="heroSub">
            Normal pensionsalder: <span id="heroNormal">—</span>
            · Udbetaling: <span id="heroPayout">—</span>
            · Afkast: <span id="heroReturn">—</span>
          </div>
        </div>

        <div class="miniChart" aria-label="Normal vs mulig pensionsalder">
          <div class="bar">
            <div class="label">Normal</div>
            <div class="track"><div class="fill" id="barNormal"></div></div>
            <div class="val" id="valNormal">—</div>
          </div>
          <div class="bar">
            <div class="label">Mulig</div>
            <div class="track"><div class="fill alt" id="barPossible"></div></div>
            <div class="val" id="valPossible">—</div>
          </div>
        </div>

        <div class="row">
          <button class="primary" id="btnAdjust">Justér opsparing</button>
          <button class="ghost" id="btnAssumptions">Tilpas forudsætninger</button>
        </div>

        <p class="muted small">Beregningen er en simulering – resultater kan variere.</p>
      </section>

      <section class="card hidden" data-screen="adjust">
        <div class="kicker">Justering</div>
        <h2>Ekstra opsparing pr. måned</h2>
        <p class="muted">Live effekt i tid. Ingen hårdt loft ved manuel indtastning.</p>

        <div class="row between">
          <div class="strong">+ <span id="extraLbl">0</span> kr./md</div>
          <button class="ghost smallBtn" id="btnBackHero1">Tilbage</button>
        </div>

        <input id="extraRange" type="range" min="0" max="5000" step="100" value="0" />
        <div class="row between muted small"><span>0</span><span>5.000</span></div>

        <div class="field">
          <label for="extraManual">Eller indtast beløb</label>
          <input id="extraManual" type="number" inputmode="numeric" min="0" placeholder="fx 1200" />
        </div>

        <div class="preview">
          <div class="previewTitle">Opdateret resultat</div>
          <div class="previewRow"><div>Mulig pensionsalder</div><div class="strong" id="adjPossible">—</div></div>
          <div class="previewRow"><div>Tidsgevinst</div><div class="strong" id="adjDelta">—</div></div>
          <div class="previewRow"><div>Valgte “Små valg”</div><div class="strong" id="adjChoices">0</div></div>
        </div>

        <div class="row">
          <button class="primary" id="btnChoices">Små valg</button>
          <button class="ghost" id="btnBackHero2">Tilbage til resultat</button>
        </div>
      </section>

      <section class="card hidden" data-screen="assumptions">
        <div class="kicker">Tilpas forudsætninger</div>
        <h2>Beregningsgrundlag</h2>
        <p class="muted">Sekundært. Brug kun hvis relevant.</p>

        <div class="field">
          <label for="payout">Referenceudbetaling (kr./md)</label>
          <select id="payout">
            <option value="18000">18.000</option>
            <option value="20000" selected>20.000 (standard)</option>
            <option value="22000">22.000</option>
            <option value="25000">25.000</option>
            <option value="custom">Egen værdi…</option>
          </select>
        </div>
        <div class="field hidden" id="payoutCustomWrap">
          <label for="payoutCustom">Egen referenceudbetaling</label>
          <input id="payoutCustom" type="number" inputmode="numeric" min="5000" placeholder="fx 21000" />
        </div>

        <div class="field">
          <label for="returnRate">Afkast (langt sigt)</label>
          <select id="returnRate">
            <option value="0.06">6%</option>
            <option value="0.07" selected>7% (default)</option>
            <option value="0.08">8%</option>
            <option value="0.09">9%</option>
          </select>
        </div>

        <div class="row">
          <button class="primary" id="btnApply">Anvend</button>
          <button class="ghost" id="btnBackHero3">Tilbage</button>
        </div>

        <p class="footnote">Beregningen er en simulering baseret på forudsætninger, der kan ændre sig.</p>
      </section>

      <section class="card hidden" data-screen="choices">
        <div class="kicker">Små valg</div>
        <div class="row between">
          <h2 style="margin:0">Vælg flere – og se effekten live</h2>
          <button class="ghost smallBtn" id="btnBackAdjust">Tilbage</button>
        </div>
        <p class="muted">Hvert valg viser marginal gevinst ift. din aktuelle situation.</p>

        <div class="preview">
          <div class="previewRow"><div>Mulig pensionsalder</div><div class="strong" id="choicesPossible">—</div></div>
          <div class="previewRow"><div>Tidsgevinst</div><div class="strong" id="choicesDelta">—</div></div>
          <div class="previewRow"><div>Samlet ekstra opsparing</div><div class="strong" id="choicesTotalExtra">—</div></div>
        </div>

        <div class="choiceList" id="choiceList"></div>

        <div class="row">
          <button class="primary" id="btnMomentum">Se fremgang</button>
          <button class="ghost" id="btnLeadFromChoices">Tal med rådgiver</button>
        </div>
      </section>

      <section class="card hidden" data-screen="momentum">
        <div class="kicker">Momentum</div>
        <h2>Din fremgang siden sidst</h2>
        <p class="muted">Vises altid positivt eller neutralt.</p>

        <div class="preview">
          <div class="previewRow"><div>Sidste check-in</div><div class="strong" id="mLast">—</div></div>
          <div class="previewRow"><div>Nu</div><div class="strong" id="mNow">—</div></div>
          <div class="previewRow"><div>Udvikling</div><div class="strong" id="mDelta">—</div></div>
        </div>

        <div class="row">
          <button class="primary" id="btnLead">Tal med en rådgiver</button>
          <button class="ghost" id="btnBackHero4">Tilbage</button>
        </div>
      </section>

      <section class="card hidden" data-screen="lead">
        <div class="kicker">Frivillig kontakt</div>
        <h2>Vil du blive kontaktet?</h2>
        <p class="muted">Du ser præcis hvad der sendes, før du godkender.</p>

        <div class="field">
          <label for="intent">Hvad ønsker du?</label>
          <select id="intent">
            <option value="tidligere_pension">Tidligere pension</option>
            <option value="overblik">Overblik</option>
            <option value="optimere_opsparing">Optimere opsparing</option>
          </select>
        </div>

        <div class="grid2">
          <div class="field"><label for="firstName">Fornavn</label><input id="firstName" type="text" placeholder="Fornavn"></div>
          <div class="field"><label for="lastName">Efternavn</label><input id="lastName" type="text" placeholder="Efternavn"></div>
        </div>

        <div class="grid2">
          <div class="field"><label for="email">Email</label><input id="email" type="email" placeholder="navn@domain.dk"></div>
          <div class="field"><label for="phone">Telefon</label><input id="phone" type="tel" placeholder="+45 ..."></div>
        </div>

        <div class="field">
          <label for="pref">Kontaktpræference</label>
          <select id="pref">
            <option value="ring">Ring</option>
            <option value="email">Email</option>
            <option value="booking">Booking</option>
          </select>
        </div>

        <div class="row">
          <button class="primary" id="btnPreview">Se hvad der sendes</button>
          <button class="ghost" id="btnBackMomentum">Tilbage</button>
        </div>
      </section>

      <section class="card hidden" data-screen="preview">
        <div class="kicker">Preview</div>
        <h2>Det her sendes</h2>
        <p class="muted">Demo gemmer lokalt (ingen afsendelse til tredjepart).</p>

        <div class="preview">
          <div class="previewRow"><div>Navn</div><div class="strong" id="pvName">—</div></div>
          <div class="previewRow"><div>Kontakt</div><div class="strong" id="pvContact">—</div></div>
          <div class="previewRow"><div>Intent</div><div class="strong" id="pvIntent">—</div></div>
          <div class="previewRow"><div>Mulig pensionsalder</div><div class="strong" id="pvPossible">—</div></div>
          <div class="previewRow"><div>Tidsgevinst</div><div class="strong" id="pvDelta">—</div></div>
        </div>

        <details style="margin-top:12px">
          <summary class="muted">Se teknisk payload</summary>
          <pre class="payload" id="payloadBox" style="margin-top:10px">{}</pre>
        </details>

        <div class="row">
          <button class="primary" id="btnSubmit">Send (demo)</button>
          <button class="ghost" id="btnBackLead">Tilbage</button>
        </div>
      </section>

      <section class="card hidden" data-screen="thanks">
        <div class="kicker">Tak</div>
        <h2>Din henvendelse er registreret</h2>
        <p class="muted">I en rigtig version vil en rådgiver kontakte dig indenfor en aftalt tidsramme.</p>
        <div class="row">
          <button class="primary" id="btnRestart">Start forfra</button>
          <button class="ghost" id="btnAdminGo">Se admin</button>
        </div>
      </section>

      <section class="card hidden" data-screen="admin">
        <div class="kicker">Admin</div>
        <h2>Leads (demo)</h2>
        <p class="muted">Gemmes i browserens localStorage.</p>
        <div class="row">
          <button class="ghost" id="btnClear">Slet alle leads</button>
          <button class="ghost" id="btnBackStart">Til start</button>
        </div>
        <div class="adminList" id="adminList"></div>
      </section>

      <div class="nav">
        <div class="navInner">
          <button class="navBtn" id="navResult">Resultat</button>
          <button class="navBtn" id="navAdjust">Justér</button>
          <button class="navBtn" id="navContact">Kontakt</button>
        </div>
      </div>

    </main>

    <footer class="bottombar">
      <div class="muted small">Simulering · ikke rådgivning</div>
      <div class="muted small" id="buildStamp"></div>
    </footer>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));

    const state = {
      profile: { age: null },
      capital: { current_savings: 0 },
      assumptions: { normal_pension_age: 67, return_rate: 0.07, payout_target_monthly: 20000 },
      scenario: { extra_saving_manual: 0, selected_choices: new Set() },
      momentum: { last_seen_at: null, last_possible_age: null }
    };

    function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
    function fmtInt(n){ return new Intl.NumberFormat('da-DK',{maximumFractionDigits:0}).format(n); }

    function splitYearsToYmConservative(yearsFloat){
      const totalMonths = Math.max(0, Math.floor(yearsFloat * 12 + 1e-9));
      const y = Math.floor(totalMonths / 12);
      const m = totalMonths % 12;
      return { y, m, totalMonths };
    }
    function fmtAgeConservative(ageFloat){
      const { y, m } = splitYearsToYmConservative(ageFloat);
      return m===0 ? `${y} år` : `${y} år ${m} mdr`;
    }
    function fmtDeltaConservative(deltaYears){
      const days = Math.max(0, Math.floor(deltaYears * 365 + 1e-9));
      if(days < 45) return `${days} dage`;
      const months = Math.max(0, Math.floor(deltaYears * 12 + 1e-9));
      if(days <= 540) return `${months} mdr`;
      const y = Math.floor(months/12), m = months%12;
      return m===0 ? `${y} år` : `${y} år ${m} mdr`;
    }

    function screen(name){
      $$('[data-screen]').forEach(el=>el.classList.toggle('hidden', el.getAttribute('data-screen')!==name));
      setNavActive(name);
    }
    function setNavActive(screenName){
      const map = { hero:'navResult', momentum:'navResult', adjust:'navAdjust', choices:'navAdjust', assumptions:'navAdjust', lead:'navContact', preview:'navContact' };
      const active = map[screenName] || null;
      ['navResult','navAdjust','navContact'].forEach(id=>$('#'+id).classList.toggle('active', id===active));
    }
    function canNavigateMain(){ return Number.isFinite(state.profile.age) && state.profile.age !== null; }

    const CHOICES = [
      { id:'stream', title:'Hvis 129 kr./md går til opsparing', meta:'Fx abonnement', addMonthly:129 },
      { id:'coffee', title:'Hvis 300 kr./md går til opsparing', meta:'Små vaner', addMonthly:300 },
      { id:'raise',  title:'Hvis 1.000 kr./md fra lønforhøjelse går til opsparing', meta:'Strukturel', addMonthly:1000 },
      { id:'car',    title:'Hvis 1.200 kr./md frigøres til opsparing', meta:'Fx bilvalg ved næste skifte', addMonthly:1200 },
      { id:'housing',title:'Hvis 2.000 kr./md frigøres til opsparing', meta:'Fx bolig/struktur', addMonthly:2000 },
    ];
    function orderedChoicesByAge(age){
      const young = age < 32;
      const order = young ? ['stream','coffee','raise','car','housing'] : ['raise','car','housing','stream','coffee'];
      return order.map(id=>CHOICES.find(x=>x.id===id));
    }
    function selectedSum(){
      let sum = 0;
      for(const id of state.scenario.selected_choices){
        const c = CHOICES.find(x=>x.id===id);
        if(c) sum += c.addMonthly;
      }
      return sum;
    }
    function totalExtraMonthly(){ return Math.max(0, state.scenario.extra_saving_manual) + selectedSum(); }

    function compute(extraMonthlyOverride=null, currentSavingsOverride=null){
      const age = state.profile.age;
      const normal = state.assumptions.normal_pension_age;
      const r = state.assumptions.return_rate;
      const payout = state.assumptions.payout_target_monthly;

      const extraMonthly = (extraMonthlyOverride===null) ? totalExtraMonthly() : Math.max(0, extraMonthlyOverride);
      const currentSavings = (currentSavingsOverride===null) ? Math.max(0, state.capital.current_savings) : Math.max(0, currentSavingsOverride);

      const yearsToNormal = Math.max(0, normal - age);

      const extraAnnual = extraMonthly * 12;
      const returnFactor = 0.85 + (r - 0.06) * 2.5;
      const payoutFactor = 20000 / Math.max(12000, payout);

      const rawFlow = Math.log1p(extraAnnual / 10000) * 2.8;
      const rawStock = Math.log1p(currentSavings / 250000) * 0.55; // very conservative

      const horizonFactor = Math.sqrt(Math.max(0.5, yearsToNormal / 20));
      const yearsBought = (rawFlow + rawStock) * returnFactor * payoutFactor * horizonFactor;

      const minAge = Math.max(18, normal - 15);
      const possible = clamp(normal - yearsBought, minAge, normal);
      const deltaYears = Math.max(0, normal - possible);

      return { possible, normal, deltaYears, minAge, extraMonthly, currentSavings, r, payout };
    }

    function renderStartPreview(){
      const ageInput = parseInt($('#age').value, 10);
      const savingsInput = parseInt($('#currentSavings').value, 10);

      const ageOk = Number.isFinite(ageInput) && ageInput>=18 && ageInput<=70;
      const savingsOk = Number.isFinite(savingsInput) && savingsInput>=0;

      $('#startNormal').textContent = fmtAgeConservative(state.assumptions.normal_pension_age);

      if(!ageOk){
        $('#startPossible').textContent = '—';
        $('#startDelta').textContent = '—';
        return;
      }

      state.profile.age = ageInput;
      state.capital.current_savings = savingsOk ? savingsInput : 0;

      const res = compute(0, state.capital.current_savings);
      $('#startPossible').textContent = fmtAgeConservative(res.possible);
      $('#startDelta').textContent = fmtDeltaConservative(res.deltaYears);
    }

    function renderHero(){
      const res = compute();
      $('#heroPossible').textContent = fmtAgeConservative(res.possible);
      $('#heroNormal').textContent = fmtAgeConservative(res.normal);
      $('#pillDelta').textContent = `+ ${fmtDeltaConservative(res.deltaYears)}`;

      $('#heroPayout').textContent = `${fmtInt(res.payout)} kr./md`;
      $('#heroReturn').textContent = `${Math.round(res.r*100)}%`;

      $('#valNormal').textContent = fmtAgeConservative(res.normal);
      $('#valPossible').textContent = fmtAgeConservative(res.possible);

      const span = res.normal - res.minAge || 1;
      const wPossible = ((res.possible - res.minAge)/span)*100;
      $('#barNormal').style.width = `100%`;
      $('#barPossible').style.width = `${clamp(wPossible,0,100)}%`;
    }

    function renderAdjust(){
      const res = compute();
      $('#extraLbl').textContent = fmtInt(state.scenario.extra_saving_manual);
      $('#adjPossible').textContent = fmtAgeConservative(res.possible);
      $('#adjDelta').textContent = fmtDeltaConservative(res.deltaYears);
      $('#adjChoices').textContent = String(state.scenario.selected_choices.size);
    }

    function renderChoices(){
      const res = compute();
      $('#choicesPossible').textContent = fmtAgeConservative(res.possible);
      $('#choicesDelta').textContent = fmtDeltaConservative(res.deltaYears);
      $('#choicesTotalExtra').textContent = `${fmtInt(res.extraMonthly)} kr./md`;

      const list = $('#choiceList');
      list.innerHTML = '';

      const age = state.profile.age ?? 35;
      const items = orderedChoicesByAge(age);

      const baseRes = compute();
      const baseDelta = baseRes.deltaYears;

      items.forEach(item=>{
        const isOn = state.scenario.selected_choices.has(item.id);
        let label = '—';
        if(!isOn){
          const resOn = compute(totalExtraMonthly() + item.addMonthly, null);
          const marginal = Math.max(0, resOn.deltaYears - baseDelta);
          label = `+ ${fmtDeltaConservative(marginal)}`;
        } else {
          const resOff = compute(totalExtraMonthly() - item.addMonthly, null);
          const loss = Math.max(0, baseDelta - resOff.deltaYears);
          label = `− ${fmtDeltaConservative(loss)}`;
        }

        const el = document.createElement('div');
        el.className='choiceItem';
        el.innerHTML = `
          <div>
            <div class="choiceTitle">${item.title}</div>
            <div class="choiceMeta">${item.meta} · ${fmtInt(item.addMonthly)} kr./md</div>
          </div>
          <div class="toggle">
            <span class="pill ${isOn ? 'good':''}">${label}</span>
            <button class="switchBtn" data-choice="${item.id}" aria-label="Toggle">
              <div class="switch ${isOn ? 'on':''}">
                <div class="knob"></div>
              </div>
            </button>
          </div>
        `;
        list.appendChild(el);
      });

      list.querySelectorAll('[data-choice]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-choice');
          if(state.scenario.selected_choices.has(id)) state.scenario.selected_choices.delete(id);
          else state.scenario.selected_choices.add(id);
          renderHero(); renderAdjust(); renderChoices();
        });
      });
    }

    function updateMomentum(){
      const res = compute();
      const last = state.momentum.last_seen_at;
      const now = new Date();
      $('#mLast').textContent = last ? new Date(last).toLocaleString('da-DK') : '—';
      $('#mNow').textContent = now.toLocaleString('da-DK');

      const lastPossible = state.momentum.last_possible_age;
      let text = '—';
      if(lastPossible != null){
        const diff = Math.max(0, lastPossible - res.possible);
        text = diff > 1e-6 ? `+ ${fmtDeltaConservative(diff)}` : 'Uændret';
      }
      $('#mDelta').textContent = text;

      state.momentum.last_seen_at = now.toISOString();
      state.momentum.last_possible_age = res.possible;
      localStorage.setItem('po_momentum', JSON.stringify(state.momentum));
    }

    function leadsGet(){ try { return JSON.parse(localStorage.getItem('po_leads')||'[]'); } catch { return []; } }
    function leadsSet(arr){ localStorage.setItem('po_leads', JSON.stringify(arr)); }

    function buildPayload(){
      const res = compute();
      return {
        contact: {
          first_name: ($('#firstName').value||'').trim(),
          last_name:  ($('#lastName').value||'').trim(),
          email:      ($('#email').value||'').trim(),
          phone:      ($('#phone').value||'').trim(),
          contact_preference: $('#pref').value
        },
        intent: $('#intent').value,
        profile: { age: state.profile.age },
        capital: { current_savings: state.capital.current_savings },
        assumptions: {
          normal_pension_age: state.assumptions.normal_pension_age,
          return_rate: state.assumptions.return_rate,
          payout_target_monthly: state.assumptions.payout_target_monthly
        },
        scenario_state: {
          extra_saving_manual_monthly: state.scenario.extra_saving_manual,
          selected_choices: Array.from(state.scenario.selected_choices),
          total_extra_monthly: totalExtraMonthly()
        },
        result: {
          possible_pension_age: res.possible,
          normal_pension_age: res.normal,
          delta_time: fmtDeltaConservative(res.deltaYears)
        },
        timestamp: new Date().toISOString(),
        mode: "demo_localstorage"
      };
    }

    function renderPreview(){
      const p = buildPayload();
      $('#pvName').textContent = `${p.contact.first_name||'—'} ${p.contact.last_name||''}`.trim();
      const bits = [];
      if(p.contact.email) bits.push(p.contact.email);
      if(p.contact.phone) bits.push(p.contact.phone);
      $('#pvContact').textContent = bits.length ? bits.join(' · ') : '—';
      $('#pvIntent').textContent = p.intent.replaceAll('_',' ');
      $('#pvPossible').textContent = fmtAgeConservative(p.result.possible_pension_age);
      $('#pvDelta').textContent = p.result.delta_time;
      $('#payloadBox').textContent = JSON.stringify(p, null, 2);
    }

    function renderAdmin(){
      const root = $('#adminList');
      const leads = leadsGet().slice().reverse();
      if(!leads.length){
        root.innerHTML = `<div class="leadCard"><div class="muted">Ingen leads endnu.</div></div>`;
        return;
      }
      root.innerHTML = '';
      leads.forEach(p=>{
        const d = new Date(p.timestamp);
        const el = document.createElement('div');
        el.className='leadCard';
        el.innerHTML = `
          <div class="leadHead">
            <div class="leadName">${(p.contact.first_name||'—')} ${(p.contact.last_name||'')}</div>
            <div class="leadTime">${d.toLocaleString('da-DK')}</div>
          </div>
          <div class="small" style="margin-top:8px;color:#2a3b57">
            <div><strong>Intent:</strong> ${p.intent}</div>
            <div><strong>Alder:</strong> ${p.profile.age} · <strong>Opsparing:</strong> ${fmtInt(p.capital.current_savings)} kr.</div>
            <div><strong>Mulig:</strong> ${fmtAgeConservative(p.result.possible_pension_age)} · <strong>Normal:</strong> ${fmtAgeConservative(p.result.normal_pension_age)} · <strong>Gevinst:</strong> ${p.result.delta_time}</div>
            <div><strong>Ekstra opsparing:</strong> ${fmtInt(p.scenario_state.total_extra_monthly)} kr./md · <strong>Valg:</strong> ${(p.scenario_state.selected_choices||[]).length}</div>
          </div>
          <details style="margin-top:10px">
            <summary class="muted">Se payload</summary>
            <pre class="payload" style="margin-top:10px">${JSON.stringify(p,null,2)}</pre>
          </details>
        `;
        root.appendChild(el);
      });
    }

    function safeParseInt(v){ const n = parseInt(v,10); return Number.isFinite(n) ? n : null; }

    function ensureProfileFromStartInputs(){
      const a = safeParseInt($('#age').value);
      if(!(Number.isFinite(a) && a>=18 && a<=70)) return false;
      const s = safeParseInt($('#currentSavings').value);
      state.profile.age = a;
      state.capital.current_savings = (s!==null && s>=0) ? s : 0;
      return true;
    }

    function softHome(){
      if(state.profile.age !== null) $('#age').value = state.profile.age;
      $('#currentSavings').value = state.capital.current_savings ? state.capital.current_savings : '';
      renderStartPreview();
      screen('start');
    }

    function goHero(){
      if(!ensureProfileFromStartInputs()){
        alert('Indtast en alder mellem 18 og 70.');
        return;
      }
      renderHero();
      screen('hero');
    }

    function wireNav(){
      $('#navResult').addEventListener('click', ()=>{
        if(!canNavigateMain()) return softHome();
        renderHero(); screen('hero');
      });
      $('#navAdjust').addEventListener('click', ()=>{
        if(!canNavigateMain()) return softHome();
        renderAdjust(); screen('adjust');
      });
      $('#navContact').addEventListener('click', ()=>{
        if(!canNavigateMain()) return softHome();
        screen('lead');
      });
    }

    function init(){
      try{
        const m = JSON.parse(localStorage.getItem('po_momentum')||'null');
        if(m) state.momentum = m;
      }catch{}

      $('#buildStamp').textContent = `Build: ${new Date().toLocaleDateString('da-DK')}`;

      $('#btnHome').addEventListener('click', softHome);
      $('#btnDemo').addEventListener('click', ()=>{
        $('#age').value = 38;
        $('#currentSavings').value = 250000;
        renderStartPreview();
      });

      $('#age').addEventListener('input', renderStartPreview);
      $('#currentSavings').addEventListener('input', renderStartPreview);
      $('#btnGo').addEventListener('click', goHero);

      $('#btnAdminTop').addEventListener('click', ()=>{ renderAdmin(); screen('admin'); });

      $('#btnAdjust').addEventListener('click', ()=>{ renderAdjust(); screen('adjust'); });
      $('#btnAssumptions').addEventListener('click', ()=>{
        const payout = state.assumptions.payout_target_monthly;
        const known = ['18000','20000','22000','25000'];
        if(known.includes(String(payout))){
          $('#payout').value = String(payout);
          $('#payoutCustomWrap').classList.add('hidden');
        } else {
          $('#payout').value = 'custom';
          $('#payoutCustomWrap').classList.remove('hidden');
          $('#payoutCustom').value = payout;
        }
        $('#returnRate').value = String(state.assumptions.return_rate);
        screen('assumptions');
      });

      $('#btnBackHero1').addEventListener('click', ()=>{ renderHero(); screen('hero'); });
      $('#btnBackHero2').addEventListener('click', ()=>{ renderHero(); screen('hero'); });

      $('#extraRange').addEventListener('input', (e)=>{
        state.scenario.extra_saving_manual = parseInt(e.target.value,10) || 0;
        $('#extraManual').value = state.scenario.extra_saving_manual;
        renderHero(); renderAdjust();
      });
      $('#extraManual').addEventListener('input', (e)=>{
        const v = Math.max(0, parseInt(e.target.value,10) || 0);
        state.scenario.extra_saving_manual = v;
        $('#extraRange').value = clamp(v,0,5000);
        renderHero(); renderAdjust();
      });

      $('#btnChoices').addEventListener('click', ()=>{ renderChoices(); screen('choices'); });

      $('#payout').addEventListener('change', ()=>{
        $('#payoutCustomWrap').classList.toggle('hidden', $('#payout').value !== 'custom');
      });
      $('#btnApply').addEventListener('click', ()=>{
        const v = $('#payout').value;
        let payout = 20000;
        if(v==='custom'){
          payout = parseInt($('#payoutCustom').value,10);
          if(!Number.isFinite(payout) || payout<5000) return alert('Indtast en realistisk referenceudbetaling (min. 5.000).');
        } else payout = parseInt(v,10);
        state.assumptions.payout_target_monthly = payout;
        state.assumptions.return_rate = parseFloat($('#returnRate').value);
        renderStartPreview();
        renderHero();
        renderAdjust();
        screen('hero');
      });
      $('#btnBackHero3').addEventListener('click', ()=>{ renderHero(); screen('hero'); });

      $('#btnBackAdjust').addEventListener('click', ()=>{ renderAdjust(); screen('adjust'); });
      $('#btnMomentum').addEventListener('click', ()=>{ updateMomentum(); screen('momentum'); });
      $('#btnLeadFromChoices').addEventListener('click', ()=>{ screen('lead'); });

      $('#btnLead').addEventListener('click', ()=>screen('lead'));
      $('#btnBackHero4').addEventListener('click', ()=>{ renderHero(); screen('hero'); });

      $('#btnPreview').addEventListener('click', ()=>{ renderPreview(); screen('preview'); });
      $('#btnBackMomentum').addEventListener('click', ()=>screen('momentum'));
      $('#btnBackLead').addEventListener('click', ()=>screen('lead'));

      $('#btnSubmit').addEventListener('click', ()=>{
        const p = buildPayload();
        const arr = leadsGet();
        arr.push(p);
        leadsSet(arr);
        screen('thanks');
      });

      $('#btnRestart').addEventListener('click', ()=>{
        state.profile.age = null;
        state.capital.current_savings = 0;
        state.scenario.extra_saving_manual = 0;
        state.scenario.selected_choices = new Set();
        $('#age').value = '';
        $('#currentSavings').value = '';
        $('#extraRange').value = 0;
        $('#extraManual').value = '';
        renderStartPreview();
        screen('start');
      });

      $('#btnAdminGo').addEventListener('click', ()=>{ renderAdmin(); screen('admin'); });
      $('#btnClear').addEventListener('click', ()=>{
        if(confirm('Slet alle leads i demo?')){ leadsSet([]); renderAdmin(); }
      });
      $('#btnBackStart').addEventListener('click', softHome);

      wireNav();
      renderStartPreview();
      screen('start');
    }

    init();
  </script>
</body>
</html>
